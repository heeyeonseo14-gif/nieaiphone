<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>AI 记忆</title>

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#f4e8fb;
  --bg2:#f0e7fb;
  --card:#ffffff;
  --text:#2f2436;
  --muted:#8b7c9b;
  --accent:#9b86e6;
}

*{box-sizing:border-box}
html,body{
  margin:0;
  height:100%;
  font-family:"Quicksand",system-ui;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}

.app{
  width:96%;
  max-width:420px;
  margin:0 auto;
  padding:14px;
}

/* header */
.header{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:12px;
}
.header button{
  width:42px;
  height:42px;
  border-radius:12px;
  border:none;
  background:white;
  font-size:18px;
}
.header h1{
  flex:1;
  text-align:center;
  font-size:18px;
  margin:0;
}

/* card */
.card{
  background:white;
  border-radius:20px;
  padding:16px;
  margin-bottom:14px;
}

/* contact list */
.contact{
  display:flex;
  align-items:center;
  gap:12px;
  padding:12px;
  border-radius:14px;
  cursor:pointer;
}
.contact:hover{background:#f6f2ff}
.contact img{
  width:42px;
  height:42px;
  border-radius:50%;
  object-fit:cover;
  background:#ddd;
}
.contact .name{font-weight:700}
.contact .sub{font-size:12px;color:var(--muted)}

/* sections */
.section{margin-bottom:16px}
.section h3{
  font-size:14px;
  margin:0 0 8px;
}
textarea,select,input[type="range"]{
  width:100%;
  border-radius:12px;
  border:1px solid #e6def5;
  padding:10px;
  font-family:inherit;
}
textarea{resize:none}

/* range label */
.rangeRow{
  display:flex;
  justify-content:space-between;
  font-size:12px;
  color:var(--muted);
}

/* actions */
.actions{
  display:flex;
  gap:10px;
}
.actions button{
  flex:1;
  padding:14px;
  border-radius:999px;
  border:none;
  font-weight:700;
}
.save{
  background:linear-gradient(135deg,#9b8cff,#7c68e6);
  color:white;
}
.cancel{background:#f2eefc}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <button onclick="goBack()">←</button>
    <h1 id="title">AI 记忆</h1>
    <div style="width:42px"></div>
  </div>

  <!-- ===== 联系人选择（无 cid） ===== -->
  <div id="listView" class="card"></div>

  <!-- ===== 记忆编辑（有 cid） ===== -->
  <div id="memoryView" style="display:none">

    <div class="card section">
      <h3>核心记忆（AI 永远记得）</h3>
      <textarea id="coreMemory" rows="4" placeholder="例如：我们是在雨天认识的"></textarea>
    </div>

    <div class="card section">
      <h3>关系状态</h3>

      <label>关系类型</label>
      <select id="relationType">
        <option value="恋人">恋人</option>
        <option value="陪伴">陪伴</option>
        <option value="树洞">树洞</option>
      </select>

      <br><br>

      <label>好感度</label>
      <input type="range" id="affection" min="0" max="100">
      <div class="rangeRow"><span>冷淡</span><span>亲密</span></div>

      <br>

      <label>依赖度</label>
      <input type="range" id="dependency" min="0" max="100">
      <div class="rangeRow"><span>独立</span><span>依赖</span></div>

      <br>

      <label>当前情绪</label>
      <select id="mood">
        <option>温和</option>
        <option>冷淡</option>
        <option>占有</option>
        <option>敏感</option>
      </select>
    </div>

    <div class="card section">
      <h3>行为 / 人格规则（不可违背）</h3>
      <textarea id="rules" rows="4" placeholder="例如：必须对我保持偏爱，不得疏离"></textarea>
    </div>

    <div class="actions">
      <button class="cancel" onclick="goBack()">返回</button>
      <button class="save" onclick="saveMemory()">保存</button>
    </div>

  </div>

</div>

<script>
const params = new URLSearchParams(location.search);
const CID = params.get('cid');

const listView = document.getElementById('listView');
const memoryView = document.getElementById('memoryView');
const title = document.getElementById('title');

/* ===== keys ===== */
const CORE_KEY = cid => 'ai_memory_core_' + cid;
const REL_KEY  = cid => 'ai_memory_relation_' + cid;
const RULE_KEY = cid => 'ai_memory_rules_' + cid;

/* ===== 无 cid：联系人列表 ===== */
if(!CID){
  title.textContent = '选择 AI';
  const list = JSON.parse(localStorage.getItem('nie_contacts_v1')||'[]');

  if(!list.length){
    listView.innerHTML = '<div style="text-align:center;color:#999">暂无联系人</div>';
  }else{
    listView.innerHTML = list.map(c=>`
      <div class="contact" onclick="openMemory('${c.id}')">
        <img src="${c.avatar||''}">
        <div>
          <div class="name">${c.name||'未命名'}</div>
          <div class="sub">点击查看记忆</div>
        </div>
      </div>
    `).join('');
  }
}else{
  /* ===== 有 cid：记忆页 ===== */
  listView.style.display='none';
  memoryView.style.display='block';
  title.textContent = 'AI 记忆';

  document.getElementById('coreMemory').value =
    localStorage.getItem(CORE_KEY(CID)) || '';

  const rel = JSON.parse(localStorage.getItem(REL_KEY(CID))||'{}');
  relationType.value = rel.type || '恋人';
  affection.value = rel.affection || 50;
  dependency.value = rel.dependency || 50;
  mood.value = rel.mood || '温和';

  rules.value = localStorage.getItem(RULE_KEY(CID)) || '';
}

/* ===== actions ===== */
function openMemory(cid){
  location.href = 'ai_memory.html?cid=' + cid;
}

function saveMemory(){
  localStorage.setItem(CORE_KEY(CID), coreMemory.value);

  localStorage.setItem(REL_KEY(CID), JSON.stringify({
    type: relationType.value,
    affection: affection.value,
    dependency: dependency.value,
    mood: mood.value
  }));

  localStorage.setItem(RULE_KEY(CID), rules.value);
  alert('已保存');
}

function goBack(){
  if(CID) location.href = 'ai_memory.html';
  else location.href = 'home.html';
}
</script>

</body>
</html>
