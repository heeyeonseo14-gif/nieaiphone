<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>NIEaiphone · 我的设定</title>

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#f4e8fb;
  --bg2:#f0e7fb;
  --card:#ffffff;
  --text:#2f2436;
  --muted:#8b7c9b;
  --accent:#9b86e6;
}

*{box-sizing:border-box}

html,body{
  margin:0;
  height:100%;
  font-family:"Quicksand",system-ui;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}

.app{
  width:96%;
  max-width:420px;
  margin:0 auto;
  padding:14px;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

/* header */
.header{
  display:flex;
  align-items:center;
  gap:10px;
  margin-bottom:14px;
}
.header button{
  width:42px;
  height:42px;
  border-radius:12px;
  border:none;
  background:white;
  font-size:18px;
}
.header h1{
  flex:1;
  text-align:center;
  font-size:18px;
  font-weight:700;
  margin:0;
}

/* card */
.card{
  background:var(--card);
  border-radius:20px;
  padding:16px;
  display:flex;
  flex-direction:column;
  gap:14px;
}

label{
  font-size:13px;
  color:var(--muted);
}

input,textarea,select{
  width:100%;
  padding:10px;
  border-radius:12px;
  border:1px solid #e6def5;
  font-family:inherit;
  font-size:14px;
}
textarea{resize:none}

/* avatar */
.avatarWrap{
  display:flex;
  align-items:center;
  gap:14px;
}
.avatarPreview{
  width:64px;
  height:64px;
  border-radius:50%;
  background:#ddd;
  object-fit:cover;
}
.uploadBtn{
  padding:8px 14px;
  border-radius:999px;
  border:none;
  background:linear-gradient(135deg,#cbb8ff,#9b86e6);
  color:white;
  font-size:13px;
}

/* actions */
.actions{
  display:flex;
  gap:12px;
  margin-top:10px;
}
.actions button{
  flex:1;
  padding:12px;
  border-radius:999px;
  border:none;
  font-weight:700;
}
.cancel{background:#f2eefc}
.save{background:linear-gradient(135deg,#9b8cff,#7c68e6);color:white}
</style>
</head>

<body>
<div class="app">

<div class="header">
  <button id="backBtn">←</button>
  <h1>我的设定</h1>
  <div style="width:42px"></div>
</div>

<div class="card">

  <label>我的头像</label>
  <div class="avatarWrap">
    <img id="avatarPreview" class="avatarPreview">
    <button class="uploadBtn" type="button" id="uploadBtn">上传头像</button>
  </div>

  <input
    id="avatarInput"
    type="file"
    accept="image/*"
    style="display:none"
  >

  <label>我的名称</label>
  <input id="u_name" placeholder="请输入你的名字">

  <label>性别</label>
  <select id="u_gender">
    <option value="">未设定</option>
    <option>男性</option>
    <option>女性</option>
    <option>中性</option>
  </select>

  <label>我的人设 / 身份</label>
  <textarea id="u_persona" rows="3" placeholder="例如：温柔的普通人 / 学生 / 旁观者"></textarea>

  <div class="actions">
    <button class="cancel" id="cancelBtn">取消</button>
    <button class="save" id="saveBtn">保存</button>
  </div>

</div>

</div>

<script>
document.addEventListener('DOMContentLoaded',()=>{

  const params = new URLSearchParams(location.search);
  const CHAT_ID = params.get('cid');
  const USER_KEY = 'nie_user_profile_v1';

  const avatarPreview = document.getElementById('avatarPreview');
  const avatarInput   = document.getElementById('avatarInput');
  const u_name        = document.getElementById('u_name');
  const u_gender      = document.getElementById('u_gender');
  const u_persona     = document.getElementById('u_persona');

  function goBack(){
    if(CHAT_ID){
      location.href = `chat_ui.html?cid=${CHAT_ID}`;
    }else{
      history.back();
    }
  }

  document.getElementById('backBtn').onclick = goBack;
  document.getElementById('cancelBtn').onclick = goBack;

  document.getElementById('uploadBtn').onclick = ()=>{
    avatarInput.click();
  };

  avatarInput.onchange = ()=>{
    const file = avatarInput.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      avatarPreview.src = e.target.result;
      avatarPreview.dataset.base64 = e.target.result;
    };
    reader.readAsDataURL(file);
  };

  /* 读取已保存数据 */
  const old = JSON.parse(localStorage.getItem(USER_KEY) || '{}');
  if(old.name) u_name.value = old.name;
  if(old.gender) u_gender.value = old.gender;
  if(old.persona) u_persona.value = old.persona;
  if(old.avatar){
    avatarPreview.src = old.avatar;
    avatarPreview.dataset.base64 = old.avatar;
  }

  document.getElementById('saveBtn').onclick = ()=>{
    const profile = {
      name: u_name.value.trim(),
      gender: u_gender.value,
      persona: u_persona.value.trim(),
      avatar: avatarPreview.dataset.base64 || old.avatar || ''
    };
    localStorage.setItem(USER_KEY, JSON.stringify(profile));
    goBack();
  };

});
</script>

</body>
</html>
