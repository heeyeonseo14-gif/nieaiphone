<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NIEaiphone â€” èŠå¤©ï¼ˆæ”¯æŒåç«¯ & AI å‘åŠ¨æ€ï¼‰</title>

<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet">

<style>
  :root{
    --bg1:#f0e6fb; --bg2:#e6d8f6;
    --card: rgba(255,255,255,0.36);
    --accent1:#9b86e6; --accent2:#7a64d0;
    --muted:#7b6c88; --text:#33283f;
    /* bubble theme variables (default) */
    --user-bubble: linear-gradient(180deg,#ffdedeff,#ffd6e6);
    --ai-bubble: linear-gradient(180deg,#e9dbff,#d7c8ff);
    --user-text: #3b1a2f;
    --ai-text: #2b1b3a;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:"Quicksand","Nunito","Segoe UI",sans-serif;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
  a{color:inherit}

  /* frame */
  .frame{width:92%;max-width:420px;margin:12px auto;border-radius:20px;background:var(--card);backdrop-filter:blur(12px);padding:10px 12px 18px;box-shadow:0 18px 50px rgba(40,24,60,0.08)}
  .topbar{display:flex;align-items:center;gap:10px;padding:6px}
  .backBtn{width:40px;height:40px;border-radius:10px;display:flex;align-items:center;justify-content:center;background:transparent;border:1px solid rgba(0,0,0,0.04);cursor:pointer}
  .titleWrap{flex:1}
  .title{font-weight:700;font-size:16px;margin:0}
  .subtitle{font-size:12px;color:var(--muted);margin-top:4px}
  .actions{display:flex;gap:8px;align-items:center}

  .tabs{display:flex;gap:10px;padding:10px 6px}
  .tab{flex:1;padding:10px;border-radius:12px;text-align:center;background:transparent;border:1px solid rgba(0,0,0,0.03);cursor:pointer}
  .tab.active{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;box-shadow:0 10px 26px rgba(125,106,200,0.18)}

  .content{height:62vh;overflow:hidden;border-radius:12px;margin:8px 4px;padding:10px;background:rgba(255,255,255,0.9)}
  .pane{height:100%;overflow:auto;padding-bottom:8px}

  /* chat header & messages */
  .chatHeader{display:flex;align-items:center;gap:12px;padding:8px;border-bottom:1px solid rgba(0,0,0,0.03)}
  .avatar{width:48px;height:48px;border-radius:12px;overflow:hidden;display:flex;align-items:center;justify-content:center;background:#fff}
  .avatar img{width:100%;height:100%;object-fit:cover;display:block}
  .chatTitle{font-weight:700}
  .chatMeta{font-size:12px;color:var(--muted)}

  .messages{padding:12px;display:flex;flex-direction:column;gap:10px;background-size:cover}
  .msgRow{display:flex;gap:8px;align-items:flex-end}
  .msgRow.mine{justify-content:flex-end}
  .bubble{max-width:78%;padding:10px 12px;border-radius:14px;font-size:14px;line-height:1.45;word-break:break-word}
  .bubble.user{background:var(--user-bubble);color:var(--user-text);border-bottom-right-radius:6px}
  .bubble.bot{background:var(--ai-bubble);color:var(--ai-text);border-bottom-left-radius:6px}
  .msgAvatar{width:32px;height:32px;border-radius:8px;overflow:hidden}
  .metaSmall{font-size:11px;color:var(--muted);margin-top:6px}

  /* input area */
  .composer{display:flex;gap:8px;padding:10px;border-top:1px solid rgba(0,0,0,0.03);align-items:end}
  textarea{flex:1;min-height:44px;max-height:120px;padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);resize:none}
  .sendBtn{padding:10px 14px;border-radius:10px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;border:none;cursor:pointer}
  .smallBtn{padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);background:transparent;cursor:pointer}

  /* feed */
  .post{padding:12px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);margin-bottom:12px;background:white}
  .postHeader{display:flex;gap:8px;align-items:center}
  .postImg{width:40px;height:40px;border-radius:10px;overflow:hidden}
  .postBody{margin-top:8px}
  .postMedia{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}
  .postMedia img{max-width:48%;border-radius:10px}

  /* modal */
  .modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(10,8,12,0.45);z-index:1200;padding:14px}
  .modal{width:100%;max-width:640px;max-height:86vh;overflow:auto;background:white;border-radius:12px;padding:14px;box-shadow:0 30px 80px rgba(10,10,20,0.45)}
  .formRow{display:flex;gap:8px;align-items:center;margin-bottom:10px}
  .formRow label{width:92px;font-size:13px;color:var(--muted)}
  .formRow input[type=text], .formRow select, .formRow textarea{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
  .modalActions{display:flex;gap:8px;justify-content:flex-end;padding-top:8px}

  /* color swatches */
  .swatch{display:inline-block;width:36px;height:24px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);cursor:pointer;margin-right:8px}

  @media (max-width:420px){
    .frame{width:96%;padding:8px}
    .content{height:64vh}
    .modal{padding:12px}
  }
</style>
</head>
<body>
  <div class="frame" role="application" aria-label="èŠå¤©åº”ç”¨">
    <div class="topbar">
      <button class="backBtn" id="backHome" title="è¿”å›å°å®¶">â†</button>
      <div class="titleWrap">
        <div class="title">èŠå¤©</div>
        <div class="subtitle" id="subInfo">ä¸€å¯¹ä¸€ / ç¾¤èŠ</div>
      </div>
      <div class="actions">
        <button class="smallBtn" id="openFeed">æœ‹å‹åœˆ</button>
        <button class="smallBtn" id="openPersona">AI è®¾ç½®</button>
        <button class="smallBtn" id="openBg">èƒŒæ™¯</button>
      </div>
    </div>

    <div class="tabs">
      <div class="tab active" data-tab="chats">æ¶ˆæ¯</div>
      <div class="tab" data-tab="contacts">è”ç³»äºº</div>
    </div>

    <div class="content">
      <!-- Chats pane -->
      <div class="pane" id="paneChats">
        <div class="chatHeader">
          <div class="avatar" id="chatAvatar"><img src="" alt="avatar"></div>
          <div>
            <div class="chatTitle" id="chatTitle">ä¸ AI èŠå¤©</div>
            <div class="chatMeta" id="chatMeta">å•èŠ â€¢ äººæ•°ï¼š1</div>
          </div>
          <div style="flex:1"></div>
          <button class="smallBtn" id="openGroup">ç¾¤èŠ</button>
        </div>

        <div class="messages" id="messages"></div>

        <div class="composer">
          <textarea id="inputMsg" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰"></textarea>
          <button class="sendBtn" id="sendBtn">å‘é€</button>
        </div>
      </div>

      <!-- Contacts pane -->
      <div class="pane" id="paneContacts" style="display:none">
        <div style="padding:10px">
          <button class="smallBtn" id="createContact">+ æ–°å»ºè”ç³»äºº</button>
        </div>
        <div id="contactsList" style="padding:10px"></div>
      </div>
    </div>
  </div>

  <!-- Feed modal -->
  <div class="modalWrap" id="feedModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="feedTitle">
      <h3 id="feedTitle">æœ‹å‹åœˆ</h3>
      <div style="display:flex;gap:8px;margin:8px 0 12px">
        <input type="text" id="postText" placeholder="è¯´ç‚¹ä»€ä¹ˆ..." style="flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)">
        <input type="file" id="postFile" accept="image/*" multiple>
        <button class="btnPrimary" id="postBtn">å‘å¸ƒ</button>
      </div>

      <div style="display:flex;gap:8px;margin-bottom:8px">
        <button class="smallBtn" id="aiPostBtn">AI å‘ä¸€æ¡åŠ¨æ€</button>
        <button class="smallBtn" id="clearFeedBtn">æ¸…ç©º</button>
      </div>

      <div id="feedList" style="max-height:56vh;overflow:auto"></div>

      <div style="text-align:right;margin-top:10px">
        <button class="btnGhost" id="closeFeed">å…³é—­</button>
      </div>
    </div>
  </div>

  <!-- Persona modal (AI è®¾ç½® + bubble color + backend test) -->
  <div class="modalWrap" id="personaModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="personaTitle">
      <h3 id="personaTitle">AI äººè®¾ä¸åå¥½è®¾ç½®</h3>

      <div class="formRow"><label>AI åç§°</label><input type="text" id="aiName" placeholder="ä¾‹å¦‚ï¼šå°NIE"></div>
      <div class="formRow"><label>æ€§åˆ«</label>
        <select id="aiGender"><option value="neutral">ä¸­æ€§</option><option value="female">å¥³</option><option value="male">ç”·</option></select>
      </div>
      <div class="formRow"><label>èº«ä»½ / äººè®¾</label><input type="text" id="aiRole" placeholder="ä¾‹å¦‚ï¼šæ¸©æŸ”çš„å­¦ä¹ åŠ©æ‰‹"></div>
      <div class="formRow"><label>è¡¨è¾¾é£æ ¼</label>
        <select id="aiStyle">
          <option value="friendly">å‹å¥½éšå’Œ</option>
          <option value="professional">ä¸“ä¸šä¸¥è°¨</option>
          <option value="playful">ä¿çš®å¯çˆ±</option>
          <option value="romantic">æ¸©æŸ”æµªæ¼«</option>
        </select>
      </div>
      <div class="formRow"><label>ä¹ æƒ¯ç”¨è¯­</label><input type="text" id="aiCatch" placeholder="ä¾‹å¦‚ï¼šå¸¸ç”¨é—®å€™æˆ–å£å¤´ç¦…"></div>

      <hr>

      <h4>èŠå¤©æ°”æ³¡é…è‰²ï¼ˆé€‰æ‹©ä¸€ç»„ï¼‰</h4>
      <div style="margin:8px 0">
        <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px">
          <div><strong>é¢„è®¾ä¸»é¢˜ï¼š</strong></div>
          <div class="swatch" data-theme="pinkwhite" title="ç²‰ç™½" style="background:linear-gradient(180deg,#ffeff3,#ffeef8)"></div>
          <div class="swatch" data-theme="pinkpurple" title="ç²‰ç´«" style="background:linear-gradient(180deg,#ffdfe8,#e6d5ff)"></div>
          <div class="swatch" data-theme="purpleblue" title="ç´«è“" style="background:linear-gradient(180deg,#e9dbff,#d7c8ff)"></div>
          <div class="swatch" data-theme="mint" title="è–„è·" style="background:linear-gradient(180deg,#e8fff2,#d9fff0)"></div>
        </div>

        <div style="font-size:13px;color:var(--muted)">é€‰æ‹©åä¼šåŒæ—¶ä¸ºã€Œä½ ã€ä¸ã€ŒAIã€è®¾ç½®ä¸€ç»„æ­é…ï¼Œå½“ç„¶ä½ ä¹Ÿå¯ä»¥åˆ†åˆ«å¾®è°ƒï¼ˆé«˜çº§ï¼‰ã€‚</div>
      </div>

      <div style="margin-top:10px">
        <div class="formRow"><label>ç”¨æˆ·æ°”æ³¡</label><input type="color" id="userColor" value="#ffd6e6"></div>
        <div class="formRow"><label>AI æ°”æ³¡</label><input type="color" id="aiColor" value="#d7c8ff"></div>
      </div>

      <hr>

      <div style="display:flex;gap:8px;align-items:center;">
        <div style="flex:1">
          <div style="font-size:13px;color:var(--muted)">åç«¯ URLï¼ˆç”¨äºçœŸå®ç”Ÿæˆï¼‰ï¼š</div>
          <input type="text" id="backendUrl" placeholder="åœ¨ api.html å¡«å†™æˆ–ç›´æ¥åœ¨æ­¤å¤„å¡«å†™åç«¯ URL" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);margin-top:8px">
        </div>
        <div style="width:130px">
          <button class="smallBtn" id="testBackend">æµ‹è¯•åç«¯è¿æ¥</button>
        </div>
      </div>

      <div style="margin-top:8px;font-size:13px;color:var(--muted)">æ³¨æ„ï¼šä¸è¦åœ¨å‰ç«¯ç›´æ¥æ”¾ç½® API Keyã€‚åç«¯ä»£ç†åº”å®‰å…¨å­˜æ”¾å¯†é’¥å¹¶æä¾›çŸ­æœŸ token æˆ–ä»…å…è®¸ä½ çš„åŸŸã€‚</div>

      <div class="modalActions">
        <button class="btnGhost" id="personaCancel">å–æ¶ˆ</button>
        <button class="btnPrimary" id="personaSave">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Background modal -->
  <div class="modalWrap" id="bgModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="bgTitle">
      <h3 id="bgTitle">æ›´æ¢èŠå¤©èƒŒæ™¯ / å¤´åƒ</h3>

      <div class="formRow"><label>èŠå¤©èƒŒæ™¯</label><input type="file" id="bgFile" accept="image/*"></div>
      <div class="formRow"><label>æˆ–èƒŒæ™¯ URL</label><input type="text" id="bgUrl" placeholder="å›¾ç‰‡ URL"></div>

      <hr>
      <div class="formRow"><label>æˆ‘çš„å¤´åƒ</label><input type="file" id="avatarFile" accept="image/*"></div>
      <div class="formRow"><label>AI å¤´åƒ</label><input type="file" id="aiAvatarFile" accept="image/*"></div>

      <div class="modalActions">
        <button class="btnGhost" id="bgCancel">å–æ¶ˆ</button>
        <button class="btnPrimary" id="bgSave">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Group modal -->
  <div class="modalWrap" id="groupModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="groupTitle">
      <h3 id="groupTitle">åˆ›å»ºç¾¤èŠï¼ˆæœ€å¤š 8 äººï¼‰</h3>
      <div class="formRow"><label>ç¾¤èŠåç§°</label><input type="text" id="groupName" placeholder="ä¾‹å¦‚ï¼šç­çº§å°ç¾¤"></div>
      <div style="font-size:13px;margin-bottom:8px;color:var(--muted)">å‹¾é€‰äººæ•°å¹¶å¡«å†™åå­—ï¼ˆå«ä½ è‡ªå·±ï¼‰ã€‚</div>
      <div class="groupGrid" id="groupMembers"></div>

      <div style="margin-top:10px;text-align:right">
        <button class="btnGhost" id="groupCancel">å–æ¶ˆ</button>
        <button class="btnPrimary" id="groupCreate">åˆ›å»º</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   Storage keys & defaults
   ========================= */
const CHAT_STATE_KEY = 'nie_chat_state_v2';
const FEED_KEY = 'chat_posts_v1';
const BACKEND_KEY = 'chat_backend_url';

const defaultState = {
  me: { name: 'ä½ ', avatar: '' },
  ai: { name: 'å°NIE', avatar: '', gender: 'neutral', role: 'æ¸©æŸ”çš„å­¦ä¹ åŠ©æ‰‹', style: 'friendly', catch: 'å—¨ï½' },
  background: '',
  contacts: [],
  conversations: { one2ai: { members:['me','ai'], messages: [] } },
  activeConv: 'one2ai',
  bubbleTheme: { preset: 'pinkpurple', userColor: '#ffd6e6', aiColor: '#d7c8ff' } // defaults
};

/* helpers */
function loadState(){ try{ const r = localStorage.getItem(CHAT_STATE_KEY); return r ? JSON.parse(r) : structuredClone(defaultState);}catch(e){console.error(e);return structuredClone(defaultState);} }
function saveState(s){ localStorage.setItem(CHAT_STATE_KEY, JSON.stringify(s)); }

/* initial */
let state = loadState();
/* ensure keys */
if(!state.bubbleTheme) state.bubbleTheme = structuredClone(defaultState.bubbleTheme);

/* UI refs */
const paneChats = document.getElementById('paneChats');
const paneContacts = document.getElementById('paneContacts');
const messagesEl = document.getElementById('messages');
const inputEl = document.getElementById('inputMsg');
const sendBtn = document.getElementById('sendBtn');
const chatTitle = document.getElementById('chatTitle');
const chatMeta = document.getElementById('chatMeta');
const chatAvatarImg = document.querySelector('#chatAvatar img');
const subInfo = document.getElementById('subInfo');

/* modal refs */
const feedModal = document.getElementById('feedModal');
const feedList = document.getElementById('feedList');
const postBtn = document.getElementById('postBtn');
const postText = document.getElementById('postText');
const postFile = document.getElementById('postFile');
const aiPostBtn = document.getElementById('aiPostBtn');
const clearFeedBtn = document.getElementById('clearFeedBtn');

const personaModal = document.getElementById('personaModal');
const aiName = document.getElementById('aiName');
const aiGender = document.getElementById('aiGender');
const aiRole = document.getElementById('aiRole');
const aiStyle = document.getElementById('aiStyle');
const aiCatch = document.getElementById('aiCatch');
const backendUrl = document.getElementById('backendUrl');
const testBackend = document.getElementById('testBackend');
const userColorInput = document.getElementById('userColor');
const aiColorInput = document.getElementById('aiColor');

const bgModal = document.getElementById('bgModal');
const bgFile = document.getElementById('bgFile');
const bgUrl = document.getElementById('bgUrl');
const avatarFile = document.getElementById('avatarFile');
const aiAvatarFile = document.getElementById('aiAvatarFile');

const groupModal = document.getElementById('groupModal');
const groupMembers = document.getElementById('groupMembers');
const groupNameInput = document.getElementById('groupName');

/* tabs */
document.querySelectorAll('.tab').forEach(t=>{
  t.addEventListener('click', ()=>{ document.querySelector('.tab.active').classList.remove('active'); t.classList.add('active'); if(t.dataset.tab==='chats'){ paneChats.style.display='block'; paneContacts.style.display='none'; } else { paneChats.style.display='none'; paneContacts.style.display='block'; } });
});

/* basic nav */
document.getElementById('backHome').addEventListener('click', ()=> location.href='home.html');
document.getElementById('openFeed').addEventListener('click', ()=> openFeed());
document.getElementById('openPersona').addEventListener('click', ()=> openPersona());
document.getElementById('openBg').addEventListener('click', ()=> openBg());
document.getElementById('openGroup').addEventListener('click', ()=> openGroupBuilder());
document.getElementById('closeFeed').addEventListener('click', ()=> closeModal(feedModal));

/* contacts */
document.getElementById('createContact').addEventListener('click', ()=> {
  const id = 'c'+Date.now();
  const name = prompt('æ–°è”ç³»äººåå­—ï¼š') || ('è”ç³»äºº'+(state.contacts.length+1));
  const c = { id, name, avatar: '' };
  state.contacts.push(c);
  saveState(state);
  renderContacts();
});

/* render helpers */
function defaultAvatar(kind){
  if(kind==='ai') return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect rx='36' width='100%' height='100%' fill='white'/><text x='50%' y='50%' font-size='120' text-anchor='middle' dominant-baseline='central'>ğŸ¤–</text></svg>`);
  return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect rx='36' width='100%' height='100%' fill='white'/><text x='50%' y='50%' font-size='110' text-anchor='middle' dominant-baseline='central'>ğŸ™‚</text></svg>`);
}

/* apply bubble theme CSS variables */
function applyBubbleTheme(){
  const bt = state.bubbleTheme || defaultState.bubbleTheme;
  // if user chooses colors, we convert to linear-gradient simple version
  const u = bt.userColor || '#ffd6e6';
  const a = bt.aiColor || '#d7c8ff';
  document.documentElement.style.setProperty('--user-bubble', `linear-gradient(180deg, ${lighten(u,12)}, ${u})`);
  document.documentElement.style.setProperty('--ai-bubble', `linear-gradient(180deg, ${lighten(a,10)}, ${a})`);
  document.documentElement.style.setProperty('--user-text', readableTextColor(u));
  document.documentElement.style.setProperty('--ai-text', readableTextColor(a));
}
function lighten(hex, pct){
  // hex like #rrggbb, return lighter color by pct%
  const c = hex.replace('#','');
  const num = parseInt(c,16);
  let r = (num>>16) + Math.round(255 * (pct/100));
  let g = ((num>>8)&0xff) + Math.round(255 * (pct/100));
  let b = (num & 0xff) + Math.round(255 * (pct/100));
  r=Math.min(255,r);g=Math.min(255,g);b=Math.min(255,b);
  return '#'+((1<<24)+(r<<16)+(g<<8)+b).toString(16).slice(1);
}
function readableTextColor(bg){
  // simple brightness test
  const c = bg.replace('#','');
  const r = parseInt(c.substring(0,2),16), g=parseInt(c.substring(2,4),16), b=parseInt(c.substring(4,6),16);
  const yiq = (r*299 + g*587 + b*114)/1000;
  return yiq >= 128 ? '#2b1b3a' : '#fff';
}

/* initial theme apply */
applyBubbleTheme();

/* header & messages render */
function renderHeader(){
  const conv = state.conversations[state.activeConv];
  const memberCount = conv.members.length;
  chatMeta.textContent = (memberCount>2?('ç¾¤èŠ â€¢ äººæ•°ï¼š'+memberCount):'å•èŠ â€¢ äººæ•°ï¼š'+memberCount);
  subInfo.textContent = memberCount>2?('ç¾¤èŠæ¨¡å¼'):('ä¸€å¯¹ä¸€ / ç¾¤èŠ');
  if(conv.members.length===2 && conv.members.includes('ai')){
    chatTitle.textContent = state.ai.name || 'å°NIE';
    chatAvatarImg.src = state.ai.avatar || defaultAvatar('ai');
  } else {
    chatTitle.textContent = conv.name || 'ç¾¤èŠ';
    const first = conv.members.find(m=>m!=='me');
    if(first==='ai') chatAvatarImg.src = state.ai.avatar || defaultAvatar('ai');
    else {
      const c = state.contacts.find(x=>x.id===first);
      chatAvatarImg.src = c?.avatar || defaultAvatar('contact');
    }
  }
}

function renderMessages(){
  messagesEl.innerHTML = '';
  const conv = state.conversations[state.activeConv];
  if(!conv) return;
  conv.messages.forEach(m=>{
    const row = document.createElement('div');
    row.className = 'msgRow ' + (m.from==='me' ? 'mine' : '');
    const avatarWrap = document.createElement('div');
    avatarWrap.className = 'msgAvatar';
    const img = document.createElement('img');
    img.src = (m.from==='me') ? (state.me.avatar||defaultAvatar('me')) : (m.from==='ai' ? (state.ai.avatar||defaultAvatar('ai')) : ( (m.from.startsWith('c') ? (state.contacts.find(c=>c.id===m.from)?.avatar||defaultAvatar('contact') : defaultAvatar('contact')) ) ));
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
    avatarWrap.appendChild(img);

    const bubble = document.createElement('div');
    bubble.className = 'bubble ' + (m.from==='me' ? 'user' : 'bot');
    bubble.innerHTML = escapeHtml(m.text).replaceAll('\\n','<br>');
    if(m.from==='me'){
      row.appendChild(bubble);
      row.appendChild(avatarWrap);
    } else {
      row.appendChild(avatarWrap);
      row.appendChild(bubble);
    }
    messagesEl.appendChild(row);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* message send */
sendBtn.addEventListener('click', sendMessage);
inputEl.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

async function sendMessage(){
  const text = inputEl.value.trim();
  if(!text) return;
  pushMessage({ from:'me', to: state.activeConv, text, ts: Date.now() });
  inputEl.value = '';
  renderMessages();

  // show typing
  pushMessage({ from:'ai', to: state.activeConv, text:'æ­£åœ¨è¾“å…¥...', ts: Date.now(), temp:true });
  renderMessages();

  try{
    const reply = await generateReply(text);
    // remove temp
    const conv = state.conversations[state.activeConv];
    if(conv.messages.length && conv.messages[conv.messages.length-1].temp) conv.messages.pop();
    pushMessage({ from:'ai', to: state.activeConv, text: reply.text, ts: Date.now(), note: reply.note });
    saveState(state);
    renderMessages();
  }catch(err){
    console.error(err);
    const conv = state.conversations[state.activeConv];
    if(conv.messages.length && conv.messages[conv.messages.length-1].temp) conv.messages.pop();
    pushMessage({ from:'ai', to: state.activeConv, text: 'å‡ºé”™ï¼š'+err.message, ts: Date.now() });
    saveState(state);
    renderMessages();
  }
}

function pushMessage(msg){
  const conv = state.conversations[state.activeConv];
  conv.messages.push(msg);
  saveState(state);
}

/* generateReply: calls backend if configured else local demo */
async function generateReply(userText){
  const persona = { name: state.ai.name, gender: state.ai.gender, role: state.ai.role, style: state.ai.style, catch: state.ai.catch };
  const backend = localStorage.getItem(BACKEND_KEY) || document.getElementById('backendUrl').value.trim();
  if(backend){
    // call backend
    const payload = { message: userText, persona, conversation: state.conversations[state.activeConv] || {} };
    const res = await fetch(backend, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify(payload) });
    if(!res.ok) throw new Error('åç«¯è¿”å› '+res.status);
    const j = await res.json();
    return { text: j.reply || JSON.stringify(j), note: j.note || '' };
  }
  // local demo reply behavior (simple)
  await delay(500 + Math.random()*600);
  const low = userText.toLowerCase();
  const prefix = state.ai.style==='playful' ? 'å˜¿å˜¿ï¼Œ' : (state.ai.style==='professional' ? '' : (state.ai.style==='romantic' ? 'äº²çˆ±çš„ï¼Œ' : 'ä½ å¥½ï¼Œ'));
  if(low.includes('ä½ å¥½')||low.includes('hi')) return { text: prefix + (state.ai.catch||'æˆ‘æ˜¯å°NIE') + 'ï¼Œå¾ˆé«˜å…´è§åˆ°ä½ ~' };
  if(low.includes('æ—¶é—´')) return { text: prefix + 'ç°åœ¨æ˜¯æœ¬åœ°æ—¶é—´ï¼ˆæ¼”ç¤ºï¼‰ï¼Œä½ å¯ä»¥æŠŠæ—¶é—´å‘Šè¯‰æˆ‘ï¼Œæˆ‘ä¼šè®°ä½ã€‚' };
  if(low.includes('ç¬‘è¯')) return { text: prefix + 'æœ‰ä¸ªç¨‹åºå‘˜èµ°è¿›å’–å•¡é¦†ï¼Œä»–è¯´ï¼šæˆ‘æ¥è°ƒè¯•ã€‚' };
  return { text: prefix + 'å…³äºã€Œ'+userText+'ã€ï¼Œæˆ‘ï¼ˆ'+(state.ai.role||'AI')+'ï¼‰çš„çœ‹æ³•ï¼š' + simpleParaphrase(userText) };
}

function delay(ms){ return new Promise(r=>setTimeout(r,ms)); }
function escapeHtml(s){ if(!s) return ''; return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function simpleParaphrase(s){ if(s.length>80) return s.slice(0,80)+'â€¦â€¦'; return s.split('').reverse().join(''); }

/* =========================
   Feed (æœ‹å‹åœˆ)
   ========================= */
function openFeed(){ feedModal.style.display='flex'; feedModal.setAttribute('aria-hidden','false'); renderFeed(); }
function closeModal(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }
function loadFeed(){ try{ return JSON.parse(localStorage.getItem(FEED_KEY)||'[]'); }catch(e){ return []; } }
function saveFeed(list){ localStorage.setItem(FEED_KEY, JSON.stringify(list)); }
function renderFeed(){
  const list = loadFeed();
  feedList.innerHTML = '';
  for(let i=list.length-1;i>=0;i--){
    const p = list[i];
    const node = document.createElement('div'); node.className='post';
    node.innerHTML = `<div class="postHeader"><div class="postImg"><img src="${escapeAttr(p.avatar)}" style="width:100%;height:100%;object-fit:cover"></div><div><div style="font-weight:700">${escapeHtml(p.name)}</div><div style="font-size:12px;color:${'var(--muted)'}">${new Date(p.ts).toLocaleString()}</div></div></div><div class="postBody">${escapeHtml(p.text||'')}</div>`;
    if(p.media && p.media.length){
      const mwrap = document.createElement('div'); mwrap.className='postMedia';
      p.media.forEach(u=>{ const im=document.createElement('img'); im.src=u; mwrap.appendChild(im); });
      node.appendChild(mwrap);
    }
    feedList.appendChild(node);
  }
}

document.getElementById('postBtn').addEventListener('click', async ()=>{
  const txt = postText.value.trim();
  const files = [...postFile.files];
  const media = [];
  if(files.length){
    for(const f of files) media.push(await fileToDataUrl(f));
  }
  const posts = loadFeed();
  posts.push({ name: state.me.name||'ä½ ', avatar: state.me.avatar||defaultAvatar('me'), text: txt, media, ts: Date.now() });
  saveFeed(posts);
  postText.value=''; postFile.value='';
  renderFeed();
});

/* AI è‡ªåŠ¨å‘åŠ¨æ€ï¼ˆCï¼‰ */
aiPostBtn.addEventListener('click', async ()=>{
  aiPostBtn.disabled = true; aiPostBtn.textContent = 'ç”Ÿæˆä¸­...';
  try {
    // if backend exists, request backend to generate a post using persona
    const backend = localStorage.getItem(BACKEND_KEY) || document.getElementById('backendUrl').value.trim();
    let content = '';
    if(backend){
      // ask backend to generate a post
      const payload = { action: 'generate_post', persona: state.ai };
      const res = await fetch(backend, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(res.ok){
        const j = await res.json();
        content = j.post || (j.reply || 'ï¼ˆåç«¯è¿”å›æ ¼å¼ä¸å« post å­—æ®µï¼‰');
      } else {
        content = 'ï¼ˆåç«¯ç”Ÿæˆå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆï¼‰';
      }
    }
    if(!content){
      // local generator: use persona to craft a short post
      content = localAIGeneratePost();
    }
    // save into feed as AI post
    const posts = loadFeed();
    posts.push({ name: state.ai.name || 'å°NIE', avatar: state.ai.avatar || defaultAvatar('ai'), text: content, media: [], ts: Date.now() });
    saveFeed(posts);
    renderFeed();
    alert('AI å·²å‘å¸ƒä¸€æ¡åŠ¨æ€åˆ°æœ‹å‹åœˆ');
  } catch(err){
    console.error(err); alert('AI å‘åŠ¨æ€å¤±è´¥ï¼š'+err.message);
  } finally {
    aiPostBtn.disabled = false; aiPostBtn.textContent = 'AI å‘ä¸€æ¡åŠ¨æ€';
  }
});

function localAIGeneratePost(){
  const p = state.ai;
  const greetings = p.style==='playful' ? ['å˜¿ï½','å˜»å˜»ï½','ä»Šå¤©å¥½å¼€å¿ƒï¼'] : (p.style==='professional'?['ä»Šæ—¥æ‘˜è¦ï¼š']:['ä»Šå¤©å¿ƒæƒ…ä¸é”™ï½']);
  const g = greetings[Math.floor(Math.random()*greetings.length)];
  const lines = [
    g + (p.catch ? (' ' + p.catch) : ''),
    'ä»Šå¤©æˆ‘è¯»åˆ°äº†ä¸€æ®µæœ‰è¶£çš„æ–‡å­—ï¼Œæƒ³å’Œå¤§å®¶åˆ†äº«ã€‚', 
    'å¦‚æœä½ æ„¿æ„ï¼Œå¯ä»¥å’Œæˆ‘èŠèŠä½ çš„ä»Šå¤© ğŸ˜Š'
  ];
  return lines.join('\n');
}

/* æ¸…ç©º feed */
clearFeedBtn.addEventListener('click', ()=>{ if(confirm('ç¡®è®¤æ¸…ç©ºæœ‹å‹åœˆï¼Ÿ')){ saveFeed([]); renderFeed(); } });

/* =========================
   Persona modal logic (å« bubble color & backend test)
   ========================= */
function openPersona(){
  personaModal.style.display='flex'; personaModal.setAttribute('aria-hidden','false');
  aiName.value = state.ai.name || '';
  aiGender.value = state.ai.gender || 'neutral';
  aiRole.value = state.ai.role || '';
  aiStyle.value = state.ai.style || 'friendly';
  aiCatch.value = state.ai.catch || '';
  backendUrl.value = localStorage.getItem(BACKEND_KEY) || '';
  userColorInput.value = state.bubbleTheme.userColor || '#ffd6e6';
  aiColorInput.value = state.bubbleTheme.aiColor || '#d7c8ff';
}
document.querySelectorAll('.swatch').forEach(s=>{
  s.addEventListener('click', ()=>{
    const t = s.dataset.theme;
    if(t==='pinkwhite'){ state.bubbleTheme.userColor='#fff0f4'; state.bubbleTheme.aiColor='#fff7fb'; }
    if(t==='pinkpurple'){ state.bubbleTheme.userColor='#ffd6e6'; state.bubbleTheme.aiColor='#e6d5ff'; }
    if(t==='purpleblue'){ state.bubbleTheme.userColor='#f3ecff'; state.bubbleTheme.aiColor='#e9dbff'; }
    if(t==='mint'){ state.bubbleTheme.userColor='#e8fff2'; state.bubbleTheme.aiColor='#d9fff0'; }
    userColorInput.value = state.bubbleTheme.userColor;
    aiColorInput.value = state.bubbleTheme.aiColor;
    applyBubbleTheme();
  });
});

testBackend.addEventListener('click', async ()=>{
  const url = (backendUrl.value||localStorage.getItem(BACKEND_KEY||'')).trim();
  if(!url){ alert('è¯·å…ˆåœ¨æ­¤å¤„æˆ– API é¡µé¢å¡«å†™åç«¯ URL'); return; }
  testBackend.disabled = true; testBackend.textContent='æµ‹è¯•ä¸­...';
  try{
    const resp = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ ping:true }) });
    if(!resp.ok) throw new Error('çŠ¶æ€ '+resp.status);
    const j = await resp.json();
    alert('åç«¯å“åº” OKï¼š' + (j.msg || j.status || JSON.stringify(j)));
    // save to localStorage
    localStorage.setItem(BACKEND_KEY, url);
  }catch(e){ alert('è¿æ¥å¤±è´¥ï¼š' + e.message); }
  testBackend.disabled = false; testBackend.textContent='æµ‹è¯•åç«¯è¿æ¥';
});

document.getElementById('personaCancel').addEventListener('click', ()=> closeModal(personaModal));
document.getElementById('personaSave').addEventListener('click', ()=> {
  state.ai.name = aiName.value || state.ai.name;
  state.ai.gender = aiGender.value || state.ai.gender;
  state.ai.role = aiRole.value || state.ai.role;
  state.ai.style = aiStyle.value || state.ai.style;
  state.ai.catch = aiCatch.value || state.ai.catch;
  // bubble colors
  state.bubbleTheme.userColor = userColorInput.value || state.bubbleTheme.userColor;
  state.bubbleTheme.aiColor = aiColorInput.value || state.bubbleTheme.aiColor;
  // backend url save
  if(backendUrl.value && backendUrl.value.trim()) localStorage.setItem(BACKEND_KEY, backendUrl.value.trim());
  applyBubbleTheme();
  saveState(state);
  closeModal(personaModal);
  renderHeader(); renderMessages();
});

/* =========================
   Background & avatar logic
   ========================= */
function openBg(){ bgModal.style.display='flex'; bgModal.setAttribute('aria-hidden','false'); }
async function saveBg(){
  if(bgFile.files && bgFile.files[0]) state.background = await fileToDataUrl(bgFile.files[0]);
  else if(bgUrl.value && bgUrl.value.trim()) state.background = bgUrl.value.trim();
  if(avatarFile.files && avatarFile.files[0]) state.me.avatar = await fileToDataUrl(avatarFile.files[0]);
  if(aiAvatarFile.files && aiAvatarFile.files[0]) state.ai.avatar = await fileToDataUrl(aiAvatarFile.files[0]);
  saveState(state); applyBackground(); renderHeader(); renderMessages(); closeModal(bgModal);
}
document.getElementById('bgCancel').addEventListener('click', ()=> closeModal(bgModal));
document.getElementById('bgSave').addEventListener('click', ()=> saveBg());

function applyBackground(){ const frame = document.querySelector('.frame'); if(state.background) frame.style.backgroundImage = `url('${state.background}')`, frame.style.backgroundSize='cover'; else frame.style.backgroundImage=''; }

function fileToDataUrl(file){ return new Promise((resolve,reject)=>{ const r=new FileReader(); r.onload=()=>resolve(r.result); r.onerror=e=>reject(e); r.readAsDataURL(file); }); }

/* =========================
   Contacts & groups
   ========================= */
function renderContacts(){
  const el = document.getElementById('contactsList'); el.innerHTML='';
  state.contacts.forEach(c=>{
    const row = document.createElement('div'); row.style.display='flex'; row.style.alignItems='center'; row.style.gap='12px'; row.style.padding='8px 0';
    row.innerHTML = `<div style="width:48px;height:48px;border-radius:10px;overflow:hidden"><img src="${escapeAttr(c.avatar||defaultAvatar('contact'))}" style="width:100%;height:100%;object-fit:cover"></div><div style="flex:1"><div style="font-weight:700">${escapeHtml(c.name)}</div><div style="font-size:12px;color:var(--muted)">è”ç³»äºº ID: ${escapeHtml(c.id)}</div></div><div><button class="smallBtn">èŠä¸€èŠ</button></div>`;
    row.querySelector('button').addEventListener('click', ()=> openConversationWith(c.id));
    el.appendChild(row);
  });
}
function openConversationWith(contactId){
  const convKey = 'conv_'+contactId;
  if(!state.conversations[convKey]) state.conversations[convKey] = { members: ['me', contactId], messages: [], name: state.contacts.find(c=>c.id===contactId).name };
  state.activeConv = convKey;
  saveState(state); renderHeader(); renderMessages();
  document.querySelector('.tab[data-tab="chats"]').click();
}

/* group builder */
function openGroupBuilder(){ groupMembers.innerHTML=''; for(let i=0;i<8;i++){ const div=document.createElement('div'); div.style.padding='8px'; div.style.border='1px dashed rgba(0,0,0,0.05)'; div.style.borderRadius='8px'; div.innerHTML = `<div style="font-size:13px;margin-bottom:6px">æˆå‘˜ ${i+1} åå­—</div><input type="text" data-idx="${i}" placeholder="${i===0? 'ä½  (ä¿ç•™)': 'ä¾‹å¦‚ï¼šå¥½å‹'+(i)}" style="width:100%;padding:8px;border-radius:6px;border:1px solid rgba(0,0,0,0.06)">`; groupMembers.appendChild(div); } groupModal.style.display='flex'; }
document.getElementById('groupCancel').addEventListener('click', ()=> closeModal(groupModal));
document.getElementById('groupCreate').addEventListener('click', ()=> createGroup());
function createGroup(){
  const inputs = groupMembers.querySelectorAll('input'); const names=[]; for(const inp of inputs){ const v=inp.value.trim(); if(v) names.push(v); }
  if(names.length<2){ alert('ç¾¤èŠè‡³å°‘éœ€è¦ 2 äººï¼ˆå«ä½ ï¼‰'); return; } if(names.length>8){ alert('æœ€å¤šæ”¯æŒ 8 äºº'); return; }
  const gid='g'+Date.now(); const members=[]; for(let i=0;i<names.length;i++){ const nm=names[i]; if(i===0){ members.push('me'); continue; } if(nm.toLowerCase().includes('ai')||nm.includes('NIE')){ members.push('ai'); continue; } const cid='c'+Date.now()+'_'+i; const c={id:cid,name:nm,avatar:''}; state.contacts.push(c); members.push(cid); }
  const conv={ members, messages: [], name: groupNameInput.value.trim() || ('ç¾¤èŠ '+(Object.keys(state.conversations).length+1)) };
  state.conversations[gid]=conv; state.activeConv=gid; saveState(state); closeModal(groupModal); renderContacts(); renderHeader(); renderMessages();
}

/* =========================
   Backend & utils
   ========================= */
async function testBackendUrl(url){
  // small helper - send ping
  try{
    const res = await fetch(url, { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ ping:true }) });
    return await res.json();
  }catch(e){ throw e; }
}

/* test backend button handled earlier */

function escapeAttr(s){ return (s||'').replaceAll('"','&quot;'); }

/* small helpers for colors already above: lighten & readableTextColor */

// initial render
applyBackground(); renderContacts(); renderHeader(); renderMessages(); renderFeed();

/* persist on unload */
window.addEventListener('beforeunload', ()=> saveState(state) );

</script>
</body>
</html>
