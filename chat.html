<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NIEaiphone â€” è”ç³»äººç¾åŒ–</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#f4e8fb; --bg2:#eddffb;
  --card: rgba(255,255,255,0.96);
  --accent1:#9b86e6; --accent2:#7a64d0;
  --muted:#7b6c88; --text:#2f2436;
  --surface: #ffffff;
  --btn-bg: linear-gradient(135deg,var(--accent1),var(--accent2));
  --btn-border: rgba(0,0,0,0.04);
  --shadow: 0 18px 40px rgba(40,24,60,0.06);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Quicksand",system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text)}
a{color:inherit;text-decoration:none}

/* App frame */
.app{width:94%;max-width:420px;margin:12px auto;border-radius:24px;background:var(--card);padding:12px;box-shadow:var(--shadow);overflow:hidden}
.header{display:flex;align-items:center;gap:12px;padding:6px}
.btn-icon{width:44px;height:44px;border-radius:12px;border:1px solid var(--btn-border);display:flex;align-items:center;justify-content:center;background:transparent;cursor:pointer;flex-shrink:0}
.titleArea{flex:1}
.title{font-weight:700;font-size:18px;margin:0}
.subtitle{font-size:12px;color:var(--muted);margin-top:4px}

/* top actions group */
.actions{display:flex;gap:10px}
.actionBtn{padding:8px 12px;border-radius:12px;background:rgba(255,255,255,0.98);border:1px solid var(--btn-border);cursor:pointer;min-width:84px;text-align:center;font-weight:600;box-shadow: 0 6px 18px rgba(30,14,60,0.03)}
.actionBtn.primary{background:var(--btn-bg);color:#fff;border:none;box-shadow:0 12px 30px rgba(122,100,208,0.18)}

/* main area */
.main{margin-top:10px;display:flex;flex-direction:column;gap:10px}
.pane{background:var(--surface);border-radius:14px;padding:12px;min-height:56vh;max-height:74vh;overflow:auto;position:relative}

/* CONTACTS GRID (beautified) */
.contactsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding-top:8px}
.contactCard{background:linear-gradient(180deg,rgba(255,255,255,0.9),rgba(250,248,255,0.9));border-radius:14px;display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;cursor:pointer;transition:transform .18s,box-shadow .18s;border:1px solid rgba(0,0,0,0.02)}
.contactCard:hover{transform:translateY(-6px);box-shadow:0 22px 40px rgba(30,14,60,0.06)}
.iconWrap{width:64px;height:64px;border-radius:14px;background:#fff;display:flex;align-items:center;justify-content:center;box-shadow:0 6px 18px rgba(20,12,40,0.04);overflow:hidden}
.iconWrap img{width:56px;height:56px;object-fit:cover;border-radius:8px}
.contactLabel{font-size:13px;font-weight:600;color:var(--text)}

/* empty state */
.emptyState{padding:18px;border-radius:12px;border:1px dashed rgba(0,0,0,0.04);text-align:center;color:var(--muted)}

/* footer small controls */
.footerControls{display:flex;gap:8px;justify-content:center;padding-top:10px}

/* modal base */
.modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:1200;padding:12px}
.modal{width:100%;max-width:560px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 30px 80px rgba(10,10,20,0.45);max-height:86vh;overflow:auto}
.formRow{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.formRow label{width:96px;color:var(--muted);font-size:13px}
.formRow input[type=text], .formRow input[type=file], .formRow select, .formRow textarea{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
.modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

/* ensure big touch targets */
button, .actionBtn, .btn-icon { -webkit-tap-highlight-color: transparent; touch-action: manipulation; }

/* small screens tweak */
@media (max-width:420px){
  .contactsGrid{grid-template-columns:repeat(3,1fr);gap:10px}
  .iconWrap{width:56px;height:56px}
}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="NIEaiphone">
    <div class="header">
      <button class="btn-icon" id="goBack" title="è¿”å›">â†</button>
      <div class="titleArea">
        <div class="title">NIEaiphone</div>
        <div class="subtitle">ç‚¹å‡»è”ç³»äººè¿›å…¥èŠå¤©ï¼Œæˆ–åˆ›å»ºæ–°çš„è”ç³»äºº/ç¾¤èŠ</div>
      </div>
      <div class="actions">
        <button class="actionBtn" id="openFeedBtn">æœ‹å‹åœˆ</button>
        <button class="actionBtn" id="addContactBtn">æ·»åŠ è”ç³»äºº</button>
        <button class="actionBtn" id="addGroupBtn">åˆ›å»ºç¾¤èŠ</button>
      </div>
    </div>

    <div class="main">
      <div class="pane" id="contactsPane" aria-live="polite">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">è”ç³»äºº</div>
          <div style="font-size:13px;color:var(--muted)">æœ€è¿‘äº’åŠ¨ä¼šæ˜¾ç¤ºåœ¨ä¸Šæ–¹</div>
        </div>

        <!-- Grid -->
        <div id="contactsGrid" class="contactsGrid"></div>

        <div id="emptyState" class="emptyState hidden" style="margin-top:12px">
          ä½ è¿˜æ²¡æœ‰è”ç³»äººã€‚ç‚¹å‡»â€œæ·»åŠ è”ç³»äººâ€å¼€å§‹åˆ›å»ºï¼Œæˆ–ä½¿ç”¨â€œåˆ›å»ºç¾¤èŠâ€å¿«é€Ÿç”Ÿæˆä¸€ä¸ªæ¼”ç¤ºç¾¤ã€‚
        </div>

        <div class="footerControls" style="margin-top:12px">
          <button class="actionBtn" id="exportBtn">å¯¼å‡ºæ•°æ®</button>
          <button class="actionBtn" id="importBtn">å¯¼å…¥æ•°æ®</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Contact Modal -->
  <div class="modalWrap" id="contactModal" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="contactTitle">
      <h3 id="contactTitle">æ·»åŠ è”ç³»äºº</h3>
      <div class="formRow"><label>åå­—</label><input type="text" id="contactName" placeholder="å§“å"></div>
      <div class="formRow"><label>å¤´åƒæ–‡ä»¶</label><input type="file" id="contactFile" accept="image/*"></div>
      <div class="formRow"><label>æˆ–å¤´åƒ URL</label><input type="text" id="contactUrl" placeholder="å›¾ç‰‡é“¾æ¥"></div>
      <div class="modalActions">
        <button class="actionBtn" id="contactCancel">å–æ¶ˆ</button>
        <button class="actionBtn primary" id="contactSave">ä¿å­˜</button>
      </div>
    </div>
  </div>

  <!-- Group Modal -->
  <div class="modalWrap" id="groupModal" aria-hidden="true">
    <div class="modal" role="dialog">
      <h3>åˆ›å»ºç¾¤èŠï¼ˆæœ€å¤š 8 äººï¼‰</h3>
      <div class="formRow"><label>ç¾¤å</label><input type="text" id="groupName" placeholder="ç¾¤èŠåç§°"></div>
      <div class="formRow"><label>ç¾¤å¤´åƒ</label><input type="file" id="groupFile" accept="image/*"></div>
      <div style="font-size:13px;color:var(--muted);margin-bottom:8px">é€‰æ‹©æˆå‘˜ï¼ˆç‚¹å‡»é€‰æ‹©ï¼‰</div>
      <div id="groupContacts" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
      <div class="modalActions">
        <button class="actionBtn" id="groupCancel">å–æ¶ˆ</button>
        <button class="actionBtn primary" id="groupCreate">åˆ›å»º</button>
      </div>
    </div>
  </div>

<script>
/* --------------------------
   ç®€æ´ç‰ˆé€»è¾‘ï¼šè”ç³»äººæ¸²æŸ“ + æŒ‰é’®åŠŸèƒ½
   - è¿™ä¸ªæ–‡ä»¶ä¿®å¤äº†åŸæ¥æŒ‰é’®â€œç‚¹ä¸äº†â€çš„é—®é¢˜ï¼ˆé®æŒ¡/å±‚çº§/disabledï¼‰
   - æ‰€æœ‰æŒ‰é’®ç»‘å®šäº‹ä»¶ï¼Œmodal ä½¿ç”¨ display flex/none
---------------------------*/

const STATE_KEY = 'nie_demo_v1';
const DEFAULT = {
  contacts: [
    { id:'ai', name:'ä¸ AI èŠå¤©', avatar: '' }
  ],
  conversations: {}
};
let state = loadState();

// DOM refs
const contactsGrid = document.getElementById('contactsGrid');
const emptyState = document.getElementById('emptyState');
const contactModal = document.getElementById('contactModal');
const groupModal = document.getElementById('groupModal');

document.getElementById('addContactBtn').addEventListener('click', ()=> openContactModal());
document.getElementById('contactCancel').addEventListener('click', ()=> closeModal(contactModal));
document.getElementById('contactSave').addEventListener('click', ()=> saveContactFromModal());
document.getElementById('addGroupBtn').addEventListener('click', ()=> openGroupModal());
document.getElementById('groupCancel').addEventListener('click', ()=> closeModal(groupModal));
document.getElementById('groupCreate').addEventListener('click', ()=> createGroupFromModal());
document.getElementById('openFeedBtn').addEventListener('click', ()=> alert('æœ‹å‹åœˆå…¥å£ï¼ˆæ¼”ç¤ºï¼‰ â€” ç¨åä¼šè·³è½¬åˆ°æœ‹å‹åœˆé¡µé¢'));
document.getElementById('exportBtn').addEventListener('click', ()=> exportData());
document.getElementById('importBtn').addEventListener('click', ()=> importData());

// simple functions
function loadState(){
  try{
    const raw = localStorage.getItem(STATE_KEY);
    if(!raw){ localStorage.setItem(STATE_KEY, JSON.stringify(DEFAULT)); return structuredClone(DEFAULT); }
    return JSON.parse(raw);
  }catch(e){ console.error(e); localStorage.setItem(STATE_KEY, JSON.stringify(DEFAULT)); return structuredClone(DEFAULT); }
}
function saveState(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }

function renderContacts(){
  contactsGrid.innerHTML = '';
  if(!state.contacts || state.contacts.length === 0){
    emptyState.classList.remove('hidden');
  } else {
    emptyState.classList.add('hidden');
  }
  // show AI first
  const sorted = [...state.contacts];
  for(const c of sorted){
    const card = document.createElement('div');
    card.className = 'contactCard';
    card.dataset.id = c.id;
    const av = c.avatar || defaultAvatar();
    card.innerHTML = `<div class="iconWrap"><img src="${escapeAttr(av)}" alt=""></div><div class="contactLabel">${escapeHtml(c.name)}</div>`;
    card.addEventListener('click', ()=> {
      // open chat demo
      alert('æ‰“å¼€èŠå¤©ï¼š' + c.name + '\nï¼ˆæ¼”ç¤ºï¼‰');
    });
    contactsGrid.appendChild(card);
  }
}

function defaultAvatar(){
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect rx='36' width='100%' height='100%' fill='white'/><text x='50%' y='50%' font-size='110' text-anchor='middle' dominant-baseline='central'>ğŸ™‚</text></svg>`);
}

function escapeHtml(s){ if(!s) return ''; return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function escapeAttr(s){ return (s||'').replaceAll('"','&quot;'); }

// modal helpers
function showModal(el){ el.style.display = 'flex'; el.setAttribute('aria-hidden','false'); }
function closeModal(el){ el.style.display = 'none'; el.setAttribute('aria-hidden','true'); }

// contact modal flow
function openContactModal(){
  document.getElementById('contactName').value = '';
  document.getElementById('contactFile').value = '';
  document.getElementById('contactUrl').value = '';
  showModal(contactModal);
}
async function saveContactFromModal(){
  const name = document.getElementById('contactName').value.trim();
  if(!name) return alert('è¯·è¾“å…¥åå­—');
  let avatar = '';
  const fileInput = document.getElementById('contactFile');
  const urlInput = document.getElementById('contactUrl').value.trim();
  if(fileInput.files && fileInput.files[0]){
    avatar = await fileToDataUrl(fileInput.files[0]);
  } else if(urlInput){
    avatar = urlInput;
  }
  const id = 'c' + Date.now();
  state.contacts = state.contacts || [];
  state.contacts.push({ id, name, avatar });
  saveState();
  renderContacts();
  closeModal(contactModal);
}

// group modal
function openGroupModal(){
  // populate with current contacts (checkboxes)
  const list = document.getElementById('groupContacts');
  list.innerHTML = '';
  const all = state.contacts || [];
  for(const c of all){
    const box = document.createElement('label');
    box.style.display='flex'; box.style.flexDirection='column'; box.style.alignItems='center'; box.style.gap='6px';
    const id = 'gchk_' + c.id;
    box.innerHTML = `<input type="checkbox" id="${id}" value="${escapeAttr(c.id)}"><div style="font-size:13px">${escapeHtml(c.name)}</div>`;
    list.appendChild(box);
  }
  document.getElementById('groupName').value = '';
  document.getElementById('groupFile').value = '';
  showModal(groupModal);
}
async function createGroupFromModal(){
  const name = document.getElementById('groupName').value.trim() || ('ç¾¤èŠ' + (Math.floor(Math.random()*90)+10));
  const checked = Array.from(document.querySelectorAll('#groupContacts input[type=checkbox]:checked')).map(i=>i.value);
  if(checked.length < 1) return alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæˆå‘˜');
  if(checked.length + 1 > 8) return alert('æœ€å¤š 8 äººï¼ˆå«ä½ ï¼‰');
  let avatar = '';
  if(document.getElementById('groupFile').files && document.getElementById('groupFile').files[0]){
    avatar = await fileToDataUrl(document.getElementById('groupFile').files[0]);
  }
  const gid = 'g' + Date.now();
  // add a contact representing the group
  state.contacts.push({ id: gid, name, avatar: avatar || defaultAvatar() });
  saveState(); renderContacts(); closeModal(groupModal);
  alert('ç¾¤èŠåˆ›å»ºæˆåŠŸï¼š' + name + '\nï¼ˆå·²æ·»åŠ åˆ°è”ç³»äººï¼‰');
}

// file helper
function fileToDataUrl(file){
  return new Promise((resolve,reject)=>{
    const fr = new FileReader();
    fr.onload = ()=> resolve(fr.result);
    fr.onerror = e => reject(e);
    fr.readAsDataURL(file);
  });
}

// export / import
function exportData(){
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], { type:'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'nie_backup_'+Date.now()+'.json'; a.click();
  URL.revokeObjectURL(url);
}
function importData(){
  const input = document.createElement('input'); input.type='file'; input.accept='application/json';
  input.onchange = async (e)=>{
    const f = e.target.files[0]; if(!f) return;
    const text = await f.text();
    try{
      const j = JSON.parse(text);
      if(j.contacts) state.contacts = j.contacts;
      if(j.conversations) state.conversations = j.conversations;
      saveState(); renderContacts(); alert('å¯¼å…¥æˆåŠŸ');
    }catch(err){ alert('å¯¼å…¥å¤±è´¥ï¼š'+err.message); }
  };
  input.click();
}

// initial render
renderContacts();

// ensure buttons clickable on mobile (prevent accidental overlay)
document.body.addEventListener('touchstart', ()=>{}, {passive:true});

</script>
</body>
</html>
