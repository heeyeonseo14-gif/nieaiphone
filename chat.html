<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>NIEaiphone ¬∑ ËÅäÂ§©</title>

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#f4e8fb;
  --bg2:#f0e7fb;
  --card:#ffffff;
  --text:#2f2436;
  --muted:#7b6c88;

  --accent1:#9b86e6;
  --accent2:#7a64d0;

  --user-bubble:#ffd6e6;
  --ai-bubble:#d7c8ff;
}

*{box-sizing:border-box}
html,body{
  height:100%;
  margin:0;
  font-family:"Quicksand",system-ui,-apple-system,Segoe UI,Roboto,Arial;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
  color:var(--text);
}

.app{
  width:96%;
  max-width:480px;
  margin:8px auto;
  border-radius:22px;
  padding:14px;
  min-height:86vh;
  display:flex;
  flex-direction:column;
  overflow:hidden;
}

/* ---------- Header ---------- */
.header{
  display:flex;
  align-items:center;
  gap:10px;
}
.back{
  width:44px;
  height:44px;
  border-radius:14px;
  border:none;
  background:#fff;
  font-size:18px;
  cursor:pointer;
}
.h-title{
  flex:1;
  text-align:center;
  font-weight:700;
  font-size:18px;
}
.top-actions{
  display:flex;
  gap:8px;
}
.action{
  padding:8px 12px;
  border-radius:14px;
  background:#fff;
  border:none;
  font-weight:600;
  cursor:pointer;
  box-shadow:0 6px 16px rgba(0,0,0,.06);
}

/* ---------- Main ---------- */
.main{
  margin-top:10px;
  flex:1;
  display:flex;
  flex-direction:column;
  min-height:0;
}
.pane{
  background:rgba(255,255,255,.98);
  border-radius:18px;
  padding:12px;
  flex:1;
  overflow:auto;
  position:relative;
}
.hidden{display:none!important}

/* ---------- Contacts ---------- */
.contactsGrid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}
.contactCard{
  background:linear-gradient(180deg,#fff,#fbf8ff);
  border-radius:16px;
  padding:12px 8px;
  display:flex;
  flex-direction:column;
  align-items:center;
  gap:6px;
  cursor:pointer;
  position:relative;
}
.contactCard .deleteBtn{
  position:absolute;
  top:6px;
  right:6px;
  border:none;
  background:none;
  color:#c35;
  font-size:14px;
  cursor:pointer;
}
.iconWrap{
  width:64px;
  height:64px;
  border-radius:14px;
  overflow:hidden;
  background:#fff;
}
.iconWrap img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.contactName{
  font-size:13px;
  font-weight:700;
  text-align:center;
}

/* ---------- Chat ---------- */
.chatHeader{
  display:flex;
  align-items:center;
  gap:10px;
  border-bottom:1px solid rgba(0,0,0,.04);
  padding-bottom:8px;
}
.chatAvatar{
  width:50px;
  height:50px;
  border-radius:14px;
  overflow:hidden;
}
.chatAvatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.chatInfo{flex:1}
.chatTitle{font-weight:700}
.chatSub{font-size:12px;color:var(--muted)}

.messages{
  flex:1;
  padding:10px 4px;
  display:flex;
  flex-direction:column;
  gap:12px;
  overflow:auto;
}
.msgRow{
  display:flex;
  gap:8px;
  align-items:flex-end;
}
.msgRow.mine{justify-content:flex-end}
.msgAvatar{
  width:34px;
  height:34px;
  border-radius:10px;
  overflow:hidden;
}
.msgAvatar img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.bubble{
  max-width:78%;
  padding:10px 14px;
  border-radius:16px;
  font-size:15px;
  line-height:1.45;
}
.bubble.user{
  background:var(--user-bubble);
  border-bottom-right-radius:6px;
}
.bubble.ai{
  background:var(--ai-bubble);
  border-bottom-left-radius:6px;
}

/* ---------- Composer ---------- */
.fixedComposer{
  position:sticky;
  bottom:0;
  padding-top:8px;
}
.composer{
  display:flex;
  gap:8px;
}
textarea{
  flex:1;
  min-height:46px;
  max-height:120px;
  resize:none;
  border-radius:14px;
  border:1px solid rgba(0,0,0,.06);
  padding:10px;
}
.send{
  padding:10px 16px;
  border-radius:14px;
  border:none;
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  color:#fff;
  font-weight:700;
  cursor:pointer;
}

/* ---------- Feed ---------- */
.feedItem{
  background:#fff;
  border-radius:14px;
  padding:12px;
  margin-bottom:10px;
}
.postActions{
  display:flex;
  gap:8px;
  margin-top:8px;
}
.likeList{
  font-size:12px;
  color:var(--muted);
  margin-top:4px;
}

/* ---------- Bottom ---------- */
.bottomBar{
  display:flex;
  justify-content:center;
  gap:10px;
  padding-top:10px;
}
.userBtn{
  padding:8px 14px;
  border-radius:999px;
  background:#fff;
  border:none;
  font-weight:700;
  cursor:pointer;
}

/* ---------- Modals ---------- */
.modalWrap{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.45);
  display:none;
  align-items:center;
  justify-content:center;
  z-index:200;
}
.modalWrap.show{display:flex}
.modal{
  width:92%;
  max-width:520px;
  background:#fff;
  border-radius:20px;
  padding:16px;
  max-height:86vh;
  overflow:auto;
}
.formRow{
  display:flex;
  gap:8px;
  align-items:center;
  margin-bottom:10px;
}
.formRow label{
  width:90px;
  font-size:13px;
  color:var(--muted);
}
.formRow input,
.formRow textarea,
.formRow select{
  flex:1;
  padding:8px;
  border-radius:10px;
  border:1px solid rgba(0,0,0,.06);
}
.modalActions{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:12px;
}

/* ---------- Toast ---------- */
.toast{
  position:fixed;
  bottom:26px;
  left:50%;
  transform:translateX(-50%);
  background:linear-gradient(135deg,var(--accent1),var(--accent2));
  color:#fff;
  padding:10px 16px;
  border-radius:999px;
  display:none;
  z-index:999;
}

/* ---------- Confirm ---------- */
.confirmBox{
  background:#fff;
  padding:16px;
  border-radius:18px;
  width:90%;
  max-width:420px;
}
.confirmBtns{
  display:flex;
  justify-content:flex-end;
  gap:10px;
  margin-top:12px;
}

</style>
</head>

<body>
<div class="app">
  <script>
document.addEventListener('DOMContentLoaded',()=>{

/* ================== Âü∫Á°ÄÁä∂ÊÄÅ ================== */
const STATE_KEY = 'nie_chat_state_v7';
const FEED_KEY  = 'nie_chat_feed_v7';

const DEFAULT_STATE = {
  me:{ name:'‰Ω†', avatar:'', role:'' },
  ai:{
    name:'Â∞èNIE',
    avatar:'',
    gender:'neutral',
    role:'',
    style:'',
    replyCount:1,
    actions:false
  },
  bubble:{ user:'#ffd6e6', ai:'#d7c8ff' },
  background:'',
  contacts:[],
  conversations:{},
  active:null,
  feedAuto:false
};

function deepClone(v){ return JSON.parse(JSON.stringify(v)); }

/* ===== ÂÆâÂÖ® loadÔºà‰∏ç‰ºöË¶ÜÁõñÂ∑≤ÊúâÊï∞ÊçÆÔºâ ===== */
function loadState(){
  try{
    const raw = localStorage.getItem(STATE_KEY);
    if(!raw){
      localStorage.setItem(STATE_KEY,JSON.stringify(DEFAULT_STATE));
      return deepClone(DEFAULT_STATE);
    }
    const p = JSON.parse(raw);
    return {
      ...deepClone(DEFAULT_STATE),
      ...p,
      me:{...DEFAULT_STATE.me,...(p.me||{})},
      ai:{...DEFAULT_STATE.ai,...(p.ai||{})},
      bubble:{...DEFAULT_STATE.bubble,...(p.bubble||{})}
    };
  }catch(e){
    console.error(e);
    localStorage.setItem(STATE_KEY,JSON.stringify(DEFAULT_STATE));
    return deepClone(DEFAULT_STATE);
  }
}

function saveState(){
  localStorage.setItem(STATE_KEY,JSON.stringify(state));
  applyBubbleColors();
  applyBackground();
}

/* ================== ÂÖ®Â±Ä ================== */
let state = loadState();
let autoTimer = null;

/* ================== DOM ================== */
const contactsGrid = document.getElementById('contactsGrid');
const contactsPane = document.getElementById('contactsPane');
const chatPane     = document.getElementById('chatPane');
const feedPane     = document.getElementById('feedPane');
const messagesEl   = document.getElementById('messages');
const txtInput     = document.getElementById('txtInput');
const chatTitle    = document.getElementById('chatTitle');
const chatAvatar   = document.querySelector('#chatAvatar img');
const toastEl      = document.getElementById('toast');

/* ================== Â∑•ÂÖ∑ ================== */
function defaultAvatar(){
  return 'data:image/svg+xml;utf8,'+encodeURIComponent(
    `<svg xmlns="http://www.w3.org/2000/svg" width="256" height="256">
      <rect rx="40" width="100%" height="100%" fill="white"/>
      <text x="50%" y="50%" font-size="110" text-anchor="middle" dominant-baseline="central">üíú</text>
    </svg>`
  );
}
function escapeHtml(s){
  return (s||'').replace(/[&<>]/g,m=>({ '&':'&amp;','<':'&lt;','>':'&gt;' }[m]));
}
function showToast(t){
  toastEl.textContent=t;
  toastEl.style.display='block';
  setTimeout(()=>toastEl.style.display='none',1500);
}
function fileToDataUrl(f){
  return new Promise(res=>{
    const r=new FileReader();
    r.onload=()=>res(r.result);
    r.readAsDataURL(f);
  });
}

/* ================== Ê†∑ÂºèÂ∫îÁî® ================== */
function applyBubbleColors(){
  document.documentElement.style.setProperty('--user-bubble',state.bubble.user);
  document.documentElement.style.setProperty('--ai-bubble',state.bubble.ai);
}
function applyBackground(){
  document.querySelectorAll('.pane').forEach(p=>{
    if(state.background){
      p.style.backgroundImage=`url('${state.background}')`;
      p.style.backgroundSize='cover';
    }else{
      p.style.backgroundImage='';
    }
  });
}

/* ================== ËÅîÁ≥ª‰∫∫ ================== */
function ensureAI(){
  if(!state.contacts.find(c=>c.id==='ai')){
    state.contacts.unshift({
      id:'ai',
      name:state.ai.name,
      avatar:state.ai.avatar||defaultAvatar(),
      role:state.ai.role
    });
    state.conversations['ai']={ members:['me','ai'], messages:[] };
    saveState();
  }
}
ensureAI();

function renderContacts(){
  contactsGrid.innerHTML='';
  state.contacts.forEach(c=>{
    const d=document.createElement('div');
    d.className='contactCard';
    d.innerHTML=`
      <button class="deleteBtn">‚úï</button>
      <div class="iconWrap"><img src="${c.avatar||defaultAvatar()}"></div>
      <div class="contactName">${escapeHtml(c.name)}</div>
    `;
    d.onclick=()=>openChat(c.id);
    d.querySelector('.deleteBtn').onclick=e=>{
      e.stopPropagation();
      deleteContact(c.id);
    };
    contactsGrid.appendChild(d);
  });
}

function deleteContact(id){
  if(id==='ai') return;
  state.contacts=state.contacts.filter(c=>c.id!==id);
  delete state.conversations[id];
  saveState();
  renderContacts();
  showToast('Â∑≤Âà†Èô§');
}

/* ================== ËÅäÂ§© ================== */
function openChat(id){
  state.active=id;
  const c=state.contacts.find(x=>x.id===id);
  chatTitle.textContent=c.name;
  chatAvatar.src=c.avatar||defaultAvatar();
  contactsPane.classList.add('hidden');
  feedPane.classList.add('hidden');
  chatPane.classList.remove('hidden');
  renderMessages();
  saveState();
}

function renderMessages(){
  messagesEl.innerHTML='';
  const conv=state.conversations[state.active];
  if(!conv) return;
  conv.messages.forEach(m=>{
    const row=document.createElement('div');
    row.className='msgRow'+(m.from==='me'?' mine':'');
    const avatar=document.createElement('div');
    avatar.className='msgAvatar';
    const img=document.createElement('img');
    img.src=(m.from==='me'?state.me.avatar:state.contacts.find(c=>c.id===m.from)?.avatar)||defaultAvatar();
    avatar.appendChild(img);
    const bubble=document.createElement('div');
    bubble.className='bubble '+(m.from==='me'?'user':'ai');
    bubble.innerHTML=escapeHtml(m.text).replace(/\n/g,'<br>');
    if(m.from==='me'){ row.append(bubble,avatar); }
    else{ row.append(avatar,bubble); }
    messagesEl.appendChild(row);
  });
  messagesEl.scrollTop=messagesEl.scrollHeight;
}

function pushMessage(from,text){
  const conv=state.conversations[state.active];
  conv.messages.push({from,text,ts:Date.now()});
  saveState();
}

/* ================== ÂèëÈÄÅ ================== */
document.getElementById('sendBtn').onclick=sendMsg;
txtInput.onkeydown=e=>{
  if(e.key==='Enter'&&!e.shiftKey){e.preventDefault();sendMsg();}
};

async function sendMsg(){
  const t=txtInput.value.trim();
  if(!t) return;
  txtInput.value='';
  pushMessage('me',t);
  renderMessages();

  await new Promise(r=>setTimeout(r,300));
  const replies=generateReplies(t);
  replies.forEach(r=>pushMessage('ai',r));
  renderMessages();
}

/* ================== AI Êú¨Âú∞ÁîüÊàêÔºà‰∏çÈáçÂ§ç / ‰∏çÊö¥Èú≤‰∫∫ËÆæÔºâ ================== */
function generateReplies(userText){
  const count=Math.max(1,Math.min(20,state.ai.replyCount));
  const base=[
    'ÊàëÂú®Âê¨„ÄÇ',
    'ÂóØÔºåÊàëÊòéÁôΩ‰∫Ü„ÄÇ',
    'Âê¨‰Ω†Ëøô‰πàËØ¥ÔºåÊàëËÉΩÁêÜËß£„ÄÇ',
    'ÊàëÁü•ÈÅì‰Ω†ÁöÑÊÑèÊÄù‰∫Ü„ÄÇ',
    '‰Ω†ËØ¥ÁöÑÊàëËÆ∞‰Ωè‰∫Ü„ÄÇ'
  ];
  const out=[];
  for(let i=0;i<count;i++){
    let s=base[(i+Math.floor(Math.random()*base.length))%base.length];
    if(state.ai.actions) s=`Ôºà‰ªñËΩªËΩªÁúãÂêë‰Ω†Ôºâ${s}`;
    out.push(s);
  }
  return [...new Set(out)];
}
 /* ================== ËøîÂõû / ÂàáÊç¢ ================== */
document.getElementById('btnBack').onclick=()=>{
  window.location.href='home.html';
};
document.getElementById('backContacts').onclick=showContacts;
document.getElementById('btnFeed').onclick=openFeed;

function showContacts(){
  state.active=null;
  chatPane.classList.add('hidden');
  feedPane.classList.add('hidden');
  contactsPane.classList.remove('hidden');
  saveState();
}

/* ================== ÊúãÂèãÂúà ================== */
function loadFeed(){
  try{return JSON.parse(localStorage.getItem(FEED_KEY)||'[]');}
  catch{return []}
}
function saveFeed(list){
  localStorage.setItem(FEED_KEY,JSON.stringify(list));
}

function openFeed(){
  contactsPane.classList.add('hidden');
  chatPane.classList.add('hidden');
  feedPane.classList.remove('hidden');
  renderFeed();
}

function renderFeed(){
  const box=document.getElementById('feedList');
  box.innerHTML='';
  const list=loadFeed();
  list.slice().reverse().forEach(p=>{
    const el=document.createElement('div');
    el.className='feedItem';
    el.innerHTML=`
      <div style="display:flex;gap:8px">
        <div class="msgAvatar"><img src="${p.avatar||defaultAvatar()}"></div>
        <div>
          <div style="font-weight:700">${escapeHtml(p.name)}</div>
          <div style="font-size:12px;color:#888">${new Date(p.ts).toLocaleString()}</div>
        </div>
      </div>
      <div style="margin-top:8px">${escapeHtml(p.text)}</div>
      <div class="postActions">
        <button class="action" data-like="${p.id}">Ëµû (${p.likes.length})</button>
        <button class="action" data-del="${p.id}">Âà†Èô§</button>
      </div>
      <div class="likeList">${p.likes.join('„ÄÅ')}</div>
    `;
    box.appendChild(el);
  });

  box.querySelectorAll('[data-like]').forEach(b=>{
    b.onclick=()=>toggleLike(b.dataset.like);
  });
  box.querySelectorAll('[data-del]').forEach(b=>{
    b.onclick=()=>deletePost(b.dataset.del);
  });
}

document.getElementById('publishBtn').onclick=()=>{
  const t=document.getElementById('postText').value.trim();
  if(!t) return showToast('ËØ∑ËæìÂÖ•ÂÜÖÂÆπ');
  const list=loadFeed();
  list.push({
    id:'p'+Date.now(),
    name:state.me.name,
    avatar:state.me.avatar||defaultAvatar(),
    text:t,
    likes:[],
    ts:Date.now()
  });
  saveFeed(list);
  document.getElementById('postText').value='';
  renderFeed();
  showToast('Â∑≤ÂèëÂ∏É');
};

document.getElementById('aiPostBtn').onclick=()=>{
  const list=loadFeed();
  list.push({
    id:'p'+Date.now(),
    name:state.ai.name,
    avatar:state.ai.avatar||defaultAvatar(),
    text:state.ai.style||'‰ªäÂ§©‰πüÊÉ≥Âíå‰Ω†ËØ¥Âè•ËØù„ÄÇ',
    likes:[],
    ts:Date.now()
  });
  saveFeed(list);
  renderFeed();
  showToast('AI Â∑≤Âèë‰∏ÄÊù°');
};

function toggleLike(id){
  const list=loadFeed();
  const p=list.find(x=>x.id===id);
  if(!p) return;
  const me=state.me.name;
  const i=p.likes.indexOf(me);
  if(i>=0) p.likes.splice(i,1);
  else p.likes.push(me);
  saveFeed(list);
  renderFeed();
}

function deletePost(id){
  const list=loadFeed().filter(x=>x.id!==id);
  saveFeed(list);
  renderFeed();
  showToast('Â∑≤Âà†Èô§');
}

/* ================== ËÆæÁΩÆ ================== */
document.getElementById('openProfileBtn').onclick=()=>{
  document.getElementById('meName').value=state.me.name;
  document.getElementById('meRole').value=state.me.role;
  showModal('profileModal');
};
document.getElementById('profileSave').onclick=async()=>{
  state.me.name=document.getElementById('meName').value||state.me.name;
  state.me.role=document.getElementById('meRole').value||'';
  const f=document.getElementById('meAvatarFile').files[0];
  if(f) state.me.avatar=await fileToDataUrl(f);
  saveState();
  closeModal('profileModal');
  renderContacts();
  showToast('Â∑≤‰øùÂ≠ò');
};

document.getElementById('openAi').onclick=()=>{
  document.getElementById('aiName').value=state.ai.name;
  document.getElementById('aiRole').value=state.ai.role;
  document.getElementById('aiReplyCount').value=state.ai.replyCount;
  document.getElementById('aiActionsEnabled').checked=state.ai.actions;
  document.getElementById('userColor').value=state.bubble.user;
  document.getElementById('aiColor').value=state.bubble.ai;
  showModal('aiModal');
};

document.getElementById('aiSave').onclick=async()=>{
  state.ai.name=document.getElementById('aiName').value||state.ai.name;
  state.ai.role=document.getElementById('aiRole').value||'';
  state.ai.replyCount=parseInt(document.getElementById('aiReplyCount').value)||1;
  state.ai.actions=document.getElementById('aiActionsEnabled').checked;
  const f=document.getElementById('aiAvatarFile').files[0];
  if(f) state.ai.avatar=await fileToDataUrl(f);
  state.bubble.user=document.getElementById('userColor').value;
  state.bubble.ai=document.getElementById('aiColor').value;
  const ai=state.contacts.find(c=>c.id==='ai');
  if(ai){ ai.name=state.ai.name; ai.avatar=state.ai.avatar||ai.avatar; }
  saveState();
  renderContacts();
  closeModal('aiModal');
  showToast('Â∑≤‰øùÂ≠ò');
};

/* ================== ËÉåÊôØ ================== */
document.getElementById('changeBgBtn').onclick=()=>{
  showModal('bgModal');
};
document.getElementById('bgSet').onclick=async()=>{
  const f=document.getElementById('bgFile').files[0];
  if(f) state.background=await fileToDataUrl(f);
  saveState();
  closeModal('bgModal');
  showToast('ËÉåÊôØÂ∑≤Êõ¥Êñ∞');
};

/* ================== Modal util ================== */
function showModal(id){
  document.getElementById(id).classList.add('show');
}
function closeModal(id){
  document.getElementById(id).classList.remove('show');
}
document.querySelectorAll('.modalWrap').forEach(m=>{
  m.onclick=e=>{ if(e.target===m) m.classList.remove('show'); };
});

/* ================== ÂàùÂßãÂåñ ================== */
applyBubbleColors();
applyBackground();
renderContacts();
renderFeed();
showContacts();

});
</script>
</body>
</html>
