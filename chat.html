<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>èŠå¤© â€” NIEaiphone</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --page-bg1:#f4e8fb; --page-bg2:#eedffb;
  --card-bg: rgba(255,255,255,0.95);
  --accent1:#9b86e6; --accent2:#7a64d0;
  --muted:#7b6c88; --text:#2f2436;
  --user-color:#ffd6e6; --ai-color:#d7c8ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Quicksand",system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--page-bg1),var(--page-bg2));color:var(--text);-webkit-font-smoothing:antialiased}
.app{width:94%;max-width:420px;margin:12px auto;border-radius:20px;background:var(--card-bg);padding:12px;box-shadow:0 18px 50px rgba(40,24,60,0.06);overflow:hidden}
.header{display:flex;align-items:center;gap:10px}
.back{width:44px;height:44px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;background:white}
.h-title{flex:1;font-weight:700;font-size:18px}
.top-actions{display:flex;gap:8px}
.action{padding:8px 12px;border-radius:12px;background:white;border:1px solid rgba(0,0,0,0.04);cursor:pointer;font-weight:600;min-width:76px;text-align:center;box-shadow:0 6px 18px rgba(20,12,50,0.03)}
.action.primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 14px 30px rgba(122,100,208,0.15)}
.main{margin-top:10px}
.pane{background:rgba(255,255,255,0.98);border-radius:14px;padding:12px;min-height:60vh;max-height:76vh;overflow:auto;position:relative}

/* contacts */
.contactsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding-top:6px}
.contactCard{background:linear-gradient(180deg,rgba(255,255,255,0.98),#fbf8ff);border-radius:14px;display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;cursor:pointer;transition:transform .18s,box-shadow .18s;border:1px solid rgba(0,0,0,0.02)}
.contactCard:hover{transform:translateY(-6px);box-shadow:0 22px 40px rgba(30,14,60,0.06)}
.iconWrap{width:68px;height:68px;border-radius:14px;background:linear-gradient(180deg,#fff,#faf8ff);display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:0 8px 22px rgba(20,10,40,0.04)}
.iconWrap img{width:60px;height:60px;object-fit:cover;border-radius:10px}
.contactName{font-size:13px;font-weight:700;color:var(--text)}

/* empty */
.empty{padding:18px;border-radius:10px;border:1px dashed rgba(0,0,0,0.04);text-align:center;color:var(--muted);margin-top:8px}

/* chat pane */
.chatHeader{display:flex;align-items:center;gap:12px;padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.04);margin-bottom:8px}
.chatAvatar{width:52px;height:52px;border-radius:12px;overflow:hidden}
.chatAvatar img{width:100%;height:100%;object-fit:cover}
.chatInfo{flex:1}
.chatTitle{font-weight:700}
.chatSub{font-size:12px;color:var(--muted)}
.chatActions{display:flex;gap:8px}

/* messages */
.messages{padding:12px;display:flex;flex-direction:column;gap:12px;min-height:36vh}
.msgRow{display:flex;gap:10px;align-items:flex-end;transition:transform .26s cubic-bezier(.2,.9,.4,1),opacity .26s}
.msgRow.enter{transform:translateY(6px);opacity:0}
.msgRow.enter.show{transform:translateY(0);opacity:1}
.msgRow.mine{justify-content:flex-end}
.msgAvatar{width:36px;height:36px;border-radius:8px;overflow:hidden}
.msgAvatar img{width:100%;height:100%;object-fit:cover}

/* bubble styles improved */
.bubble{max-width:78%;padding:10px 14px;border-radius:16px;font-size:14px;line-height:1.5;box-shadow:0 10px 30px rgba(34,18,60,0.06)}
.bubble.user{background:linear-gradient(180deg,#fff0f5,var(--user-color));color:#3b1a2f;border-bottom-right-radius:6px}
.bubble.ai{background:linear-gradient(180deg,#f3eeff,var(--ai-color));color:#2b1b3a;border-bottom-left-radius:6px}

/* typing dots */
.dots{display:inline-block;height:12px}
.dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin:0 3px;opacity:.25;animation:dots 1s infinite}
.dot:nth-child(1){animation-delay:0s}
.dot:nth-child(2){animation-delay:.12s}
.dot:nth-child(3){animation-delay:.24s}
@keyframes dots{0%{opacity:.2;transform:translateY(0)}50%{opacity:1;transform:translateY(-6px)}100%{opacity:.2;transform:translateY(0)}}

/* composer */
.composer{display:flex;gap:8px;align-items:end;padding-top:8px;border-top:1px solid rgba(0,0,0,0.03)}
textarea{flex:1;min-height:48px;max-height:120px;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);resize:none}
.send{padding:10px 14px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;border:none;cursor:pointer}

/* feed bottom button */
.feedBottom{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;padding:10px 18px;border-radius:999px;box-shadow:0 12px 30px rgba(122,100,208,0.18);cursor:pointer;border:none;z-index:60}

/* modal */
.modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:120; padding:12px}
.modal{width:100%;max-width:520px;background:#fff;border-radius:12px;padding:14px;box-shadow:0 30px 80px rgba(10,10,20,0.45);max-height:86vh;overflow:auto}
.formRow{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.formRow label{width:90px;color:var(--muted);font-size:13px}
.formRow input[type=text], .formRow input[type=file], .formRow select{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
.modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

/* small */
.hidden{display:none}
@media (max-width:420px){
  .contactsGrid{grid-template-columns:repeat(3,1fr);gap:10px}
  .iconWrap{width:56px;height:56px}
  .feedBottom{left:50%}
}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="NIE èŠå¤©åº”ç”¨">
    <div class="header">
      <button class="back" id="btnBack">â†</button>
      <div class="h-title">èŠå¤©</div>
      <div class="top-actions">
        <button class="action" id="btnFeed">æœ‹å‹åœˆ</button>
        <button class="action" id="btnAdd">æ·»åŠ è”ç³»äºº</button>
        <button class="action" id="btnGroup">åˆ›å»ºç¾¤èŠ</button>
      </div>
    </div>

    <div class="main">
      <div id="contactsPane" class="pane">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">è”ç³»äºº</div>
          <div style="font-size:13px;color:var(--muted)">ç‚¹å‡»è”ç³»äººè¿›å…¥èŠå¤©</div>
        </div>

        <div id="contactsGrid" class="contactsGrid"></div>

        <div id="emptyHint" class="empty hidden">å½“å‰æ²¡æœ‰è”ç³»äººã€‚ç‚¹å‡»â€œæ·»åŠ è”ç³»äººâ€å¼€å§‹åˆ›å»ºï¼Œæˆ–ç”¨â€œåˆ›å»ºç¾¤èŠâ€å¿«é€Ÿç”Ÿæˆä¸€ä¸ªç¤ºä¾‹ç¾¤ã€‚</div>
      </div>

      <!-- chat pane -->
      <div id="chatPane" class="pane hidden">
        <div class="chatHeader">
          <div class="chatAvatar" id="chatAvatar"><img src="" alt=""></div>
          <div class="chatInfo">
            <div class="chatTitle" id="chatTitle">å¯¹è¯</div>
            <div class="chatSub" id="chatSub">å•èŠ Â· äººæ•°ï¼š1</div>
          </div>
          <div class="chatActions">
            <button class="action" id="openAi">AI è®¾ç½®</button>
            <button class="action" id="backContacts">è¿”å›</button>
          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="composer">
          <textarea id="txtInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰"></textarea>
          <button class="send" id="sendBtn">å‘é€</button>
        </div>
      </div>

      <!-- feed pane -->
      <div id="feedPane" class="pane hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">æœ‹å‹åœˆ</div>
          <div style="font-size:13px;color:var(--muted)">AI å¯å‘åŠ¨æ€ Â· æ”¯æŒç‚¹èµ/è¯„è®ºï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</div>
        </div>
        <div style="margin-bottom:10px">
          <textarea id="postText" placeholder="åœ¨æœ‹å‹åœˆè¯´ç‚¹ä»€ä¹ˆ..." style="width:100%;height:64px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);padding:8px"></textarea>
          <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:8px">
            <button class="action" id="publishBtn">å‘å¸ƒ</button>
            <button class="action" id="aiPostBtn">AI å‘ä¸€æ¡</button>
            <button class="action" id="closeFeedBtn">å…³é—­</button>
          </div>
        </div>
        <div id="feedList"></div>
      </div>

    </div>
  </div>

  <!-- modals -->
  <div class="modalWrap" id="contactModal"><div class="modal">
    <h3>æ·»åŠ è”ç³»äºº</h3>
    <div class="formRow"><label>åå­—</label><input type="text" id="contactName" placeholder="åå­—"></div>
    <div class="formRow"><label>å¤´åƒæ–‡ä»¶</label><input type="file" id="contactFile" accept="image/*"></div>
    <div class="formRow"><label>æˆ–å¤´åƒ URL</label><input type="text" id="contactURL" placeholder="å›¾ç‰‡ URL"></div>
    <div class="modalActions"><button class="action" id="contactCancel">å–æ¶ˆ</button><button class="action primary" id="contactSave">ä¿å­˜</button></div>
  </div></div>

  <div class="modalWrap" id="groupModal"><div class="modal">
    <h3>åˆ›å»ºç¾¤èŠï¼ˆæœ€å¤š 8 äººï¼‰</h3>
    <div class="formRow"><label>ç¾¤å</label><input type="text" id="groupName" placeholder="ç¾¤åç§°"></div>
    <div class="formRow"><label>ç¾¤å¤´åƒ</label><input type="file" id="groupFile" accept="image/*"></div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:8px">ä»è”ç³»äººä¸­é€‰æ‹©æˆå‘˜</div>
    <div id="groupContacts" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
    <div class="modalActions"><button class="action" id="groupCancel">å–æ¶ˆ</button><button class="action primary" id="groupCreate">åˆ›å»º</button></div>
  </div></div>

<script>
/* ---- state & helpers ---- */
const STATE_KEY = 'nie_simple_v2';
const FEED_KEY = 'nie_feed_v1';
const DEFAULT = {
  me: { name: 'ä½ ', avatar: '' },
  ai: { name: 'å°NIE', avatar: '' },
  contacts: [ { id:'ai', name:'ä¸ AI èŠå¤©', avatar:'' } ],
  conversations: { 'ai': { members:['me','ai'], messages:[] } }
};
let state = loadState();

function loadState(){ try{ const s=localStorage.getItem(STATE_KEY); if(!s){ localStorage.setItem(STATE_KEY, JSON.stringify(DEFAULT)); return structuredClone(DEFAULT);} return JSON.parse(s);}catch(e){console.error(e); localStorage.setItem(STATE_KEY, JSON.stringify(DEFAULT)); return structuredClone(DEFAULT);} }
function saveState(){ localStorage.setItem(STATE_KEY, JSON.stringify(state)); }
function loadFeed(){ try{ return JSON.parse(localStorage.getItem(FEED_KEY)||'[]'); }catch(e){return [];} }
function saveFeed(f){ localStorage.setItem(FEED_KEY, JSON.stringify(f)); }

/* ---- DOM refs ---- */
const contactsGrid = document.getElementById('contactsGrid');
const contactsPane = document.getElementById('contactsPane');
const chatPane = document.getElementById('chatPane');
const feedPane = document.getElementById('feedPane');
const emptyHint = document.getElementById('emptyHint');
const btnAdd = document.getElementById('btnAdd');
const btnGroup = document.getElementById('btnGroup');
const btnFeed = document.getElementById('btnFeed');
const btnBack = document.getElementById('btnBack');

/* chat refs */
const chatAvatar = document.getElementById('chatAvatar').querySelector('img');
const chatTitle = document.getElementById('chatTitle');
const chatSub = document.getElementById('chatSub');
const messagesEl = document.getElementById('messages');
const txtInput = document.getElementById('txtInput');
const sendBtn = document.getElementById('sendBtn');

/* modals & feed */
const contactModal = document.getElementById('contactModal');
const contactName = document.getElementById('contactName');
const contactFile = document.getElementById('contactFile');
const contactURL = document.getElementById('contactURL');
const contactCancel = document.getElementById('contactCancel');
const contactSave = document.getElementById('contactSave');

const groupModal = document.getElementById('groupModal');
const groupContacts = document.getElementById('groupContacts');
const groupName = document.getElementById('groupName');
const groupFile = document.getElementById('groupFile');
const groupCancel = document.getElementById('groupCancel');
const groupCreate = document.getElementById('groupCreate');

const postText = document.getElementById('postText');
const publishBtn = document.getElementById('publishBtn');
const aiPostBtn = document.getElementById('aiPostBtn');
const feedList = document.getElementById('feedList');
const closeFeedBtn = document.getElementById('closeFeedBtn');

/* ---- events ---- */
btnAdd.addEventListener('click', ()=> openContactModal());
contactCancel.addEventListener('click', ()=> closeModal(contactModal));
contactSave.addEventListener('click', ()=> saveContact());
btnGroup.addEventListener('click', ()=> openGroupModal());
groupCancel.addEventListener('click', ()=> closeModal(groupModal));
groupCreate.addEventListener('click', ()=> createGroup());
btnFeed.addEventListener('click', ()=> openFeed());
btnBack.addEventListener('click', ()=> location.href='home.html');
publishBtn.addEventListener('click', ()=> publishPost());
aiPostBtn.addEventListener('click', ()=> aiPublish());
closeFeedBtn.addEventListener('click', ()=> closeFeed());

sendBtn.addEventListener('click', ()=> sendMsg());
txtInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); } });

/* ---- initial render ---- */
renderContacts();
applyEmptyHint();
renderFeed();

/* ----- functions ----- */
function renderContacts(){
  contactsGrid.innerHTML = '';
  (state.contacts || []).forEach(c=>{
    const el = document.createElement('div'); el.className='contactCard'; el.dataset.id = c.id;
    const av = c.avatar || defaultAvatar();
    el.innerHTML = `<div class="iconWrap"><img src="${av}" alt=""></div><div class="contactName">${escapeHtml(c.name)}</div>`;
    el.addEventListener('click', ()=> openConversation(c.id));
    contactsGrid.appendChild(el);
  });
}
function applyEmptyHint(){ if(!state.contacts || state.contacts.length===0) emptyHint.classList.remove('hidden'); else emptyHint.classList.add('hidden'); }

function defaultAvatar(){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect rx='36' width='100%' height='100%' fill='white'/><text x='50%' y='50%' font-size='110' text-anchor='middle' dominant-baseline='central'>ğŸ™‚</text></svg>`); }

function escapeHtml(s){ if(!s) return ''; return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* open chat */
function openConversation(id){
  state.active = id;
  // ensure conversation exists
  state.conversations[id] = state.conversations[id] || { members: id==='ai' ? ['me','ai'] : ['me', id], messages: [] };
  // render header
  const target = state.contacts.find(c=>c.id===id) || (id==='ai' ? { name: state.ai.name || 'AI', avatar: state.ai.avatar || defaultAvatar() } : { name:'ç¾¤èŠ', avatar: defaultAvatar() });
  chatTitle.textContent = target.name;
  chatSub.textContent = (state.conversations[id].members?.length>1 ? 'ç¾¤èŠ Â· äººæ•°ï¼š' + state.conversations[id].members.length : 'å•èŠ Â· äººæ•°ï¼š1');
  chatAvatar.src = target.avatar || defaultAvatar();
  // show chat pane
  contactsPane.classList.add('hidden'); chatPane.classList.remove('hidden'); feedPane.classList.add('hidden');
  renderMessages();
}

/* back to contacts */
document.getElementById('backContacts').addEventListener('click', ()=> { contactsPane.classList.remove('hidden'); chatPane.classList.add('hidden'); feedPane.classList.add('hidden'); state.active = null; });

/* messages render */
function renderMessages(){
  messagesEl.innerHTML = '';
  const conv = state.conversations[state.active] || { messages: [] };
  conv.messages.forEach(m=>{
    const row = document.createElement('div'); row.className = 'msgRow' + (m.from==='me' ? ' mine' : '');
    const avat = document.createElement('div'); avat.className = 'msgAvatar'; const img=document.createElement('img');
    if(m.from==='me') img.src = state.me.avatar || defaultAvatar(); else if(m.from==='ai') img.src = state.ai.avatar || defaultAvatar(); else { const c = state.contacts.find(x=>x.id===m.from); img.src = c ? (c.avatar||defaultAvatar()) : defaultAvatar(); }
    img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; avat.appendChild(img);
    const bubble = document.createElement('div'); bubble.className='bubble ' + (m.from==='me' ? 'user' : 'ai');
    if(m.temp){ bubble.innerHTML = '<span class="dots"><span class="dot"></span><span class="dot"></span><span class="dot"></span></span>'; }
    else bubble.innerHTML = escapeHtml(m.text).replaceAll('\\n','<br>');
    if(m.from==='me'){ row.appendChild(bubble); row.appendChild(avat); } else { row.appendChild(avat); row.appendChild(bubble); }
    messagesEl.appendChild(row);
    row.classList.add('enter'); setTimeout(()=>row.classList.add('show'), 10);
  });
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

/* send */
async function sendMsg(){
  const text = txtInput.value.trim(); if(!text) return;
  const id = state.active || 'ai';
  pushMessage(id, { from:'me', text, ts: Date.now() });
  txtInput.value=''; renderMessages();
  pushMessage(id, { from:'ai', text:'', temp:true, ts: Date.now() }); renderMessages();
  try{
    const reply = await generateReply(text, id);
    // remove temp
    const conv = state.conversations[id]; if(conv.messages.length && conv.messages[conv.messages.length-1].temp) conv.messages.pop();
    pushMessage(id, { from:'ai', text: reply, ts: Date.now() });
    saveState(); renderMessages();
  } catch(err){
    console.error(err); const conv = state.conversations[id]; if(conv.messages.length && conv.messages[conv.messages.length-1].temp) conv.messages.pop();
    pushMessage(id, { from:'ai', text:'å‡ºé”™ï¼š' + (err.message||'æœªçŸ¥'), ts: Date.now() }); saveState(); renderMessages();
  }
}
function pushMessage(convId, msg){
  state.conversations[convId] = state.conversations[convId] || { members:['me','ai'], messages:[] };
  state.conversations[convId].messages.push(msg); saveState();
}

/* simple local reply (demo) */
async function generateReply(user, convId){
  await new Promise(r=>setTimeout(r, 500 + Math.random()*700));
  if(/ä½ å¥½|å—¨|hi/.test(user)) return (state.ai?.name||'å°NIE') + 'ï¼šä½ å¥½ï½';
  if(/ç¬‘è¯/.test(user)) return 'æœ‰ä¸€ä¸ªç¨‹åºå‘˜èµ°è¿›å’–å•¡é¦†ï¼Œè¯´ï¼šæˆ‘æ¥è°ƒè¯•ã€‚';
  return 'ï¼ˆæ¼”ç¤ºå›å¤ï¼‰' + user.split('').reverse().join('').slice(0,140);
}

/* ---- add contact modal ---- */
function openContactModal(){ contactName.value=''; contactFile.value=''; contactURL.value=''; showModal(contactModal); }
async function saveContact(){
  const name = contactName.value.trim(); if(!name) return alert('è¯·è¾“å…¥åå­—');
  let avatar = '';
  if(contactFile.files && contactFile.files[0]) avatar = await fileToDataUrl(contactFile.files[0]);
  else if(contactURL.value.trim()) avatar = contactURL.value.trim();
  const id = 'c' + Date.now();
  state.contacts.push({ id, name, avatar }); saveState(); renderContacts(); applyEmptyHint(); closeModal(contactModal);
}

/* ---- group modal ---- */
function openGroupModal(){
  groupContacts.innerHTML='';
  // list existing contacts
  const list = state.contacts || [];
  list.forEach(c=>{
    const div = document.createElement('div'); div.style.padding='8px'; div.style.border='1px solid rgba(0,0,0,0.04)'; div.style.borderRadius='8px'; div.style.textAlign='center';
    div.innerHTML = `<label style="display:flex;flex-direction:column;align-items:center;gap:6px"><input type="checkbox" value="${c.id}"><div style="font-size:13px">${escapeHtml(c.name)}</div></label>`;
    groupContacts.appendChild(div);
  });
  groupName.value=''; groupFile.value=''; showModal(groupModal);
}
async function createGroup(){
  const checked = Array.from(groupContacts.querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value);
  if(checked.length < 1) return alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä½æˆå‘˜');
  if(checked.length + 1 > 8) return alert('æœ€å¤šæ”¯æŒ 8 äºº');
  const name = groupName.value.trim() || ('ç¾¤èŠ ' + (Math.floor(Math.random()*90)+10));
  let avatar = '';
  if(groupFile.files && groupFile.files[0]) avatar = await fileToDataUrl(groupFile.files[0]);
  const gid = 'g' + Date.now();
  state.conversations[gid] = { members: ['me', ...checked], messages: [], name };
  state.contacts.push({ id: gid, name, avatar: avatar || defaultAvatar() });
  saveState(); renderContacts(); applyEmptyHint(); closeModal(groupModal);
  alert('ç¾¤èŠå·²åˆ›å»ºï¼š' + name);
}

/* ---- feed functions ---- */
function openFeed(){ contactsPane.classList.add('hidden'); chatPane.classList.add('hidden'); feedPane.classList.remove('hidden'); renderFeed(); }
function closeFeed(){ feedPane.classList.add('hidden'); contactsPane.classList.remove('hidden'); chatPane.classList.add('hidden'); }

async function publishPost(){
  const t = postText.value.trim(); if(!t) return alert('è¯·è¾“å…¥å†…å®¹');
  const posts = loadFeed();
  posts.push({ id:'p'+Date.now(), name: state.me.name, avatar: state.me.avatar||defaultAvatar(), text:t, likes:[], comments:[], ts:Date.now() });
  saveFeed(posts); postText.value=''; renderFeed(); alert('å‘å¸ƒæˆåŠŸ');
}
async function aiPublish(){
  const posts = loadFeed();
  posts.push({ id:'p'+Date.now(), name: state.ai.name||'AI', avatar: state.ai.avatar||defaultAvatar(), text: 'AIï¼šä»Šå¤©ä¹Ÿæƒ³å’Œä½ è¯´ç‚¹å¿ƒé‡Œè¯ï½', likes:[], comments:[], ts:Date.now() });
  saveFeed(posts); renderFeed(); alert('AI å·²å‘å¸ƒä¸€æ¡åŠ¨æ€');
}
function renderFeed(){
  const list = loadFeed(); feedList.innerHTML = '';
  for(let i=list.length-1;i>=0;i--){
    const p = list[i];
    const node = document.createElement('div'); node.style.padding='12px'; node.style.borderBottom='1px solid rgba(0,0,0,0.03)';
    node.innerHTML = `<div style="display:flex;gap:10px;align-items:center"><div style="width:44px;height:44px;border-radius:10px;overflow:hidden"><img src="${p.avatar||defaultAvatar()}" style="width:100%;height:100%;object-fit:cover"></div><div><div style="font-weight:700">${escapeHtml(p.name)}</div><div style="font-size:12px;color:var(--muted)">${new Date(p.ts).toLocaleString()}</div></div></div><div style="margin-top:8px">${escapeHtml(p.text)}</div><div style="margin-top:8px;display:flex;gap:8px"><button class="action" data-id="${p.id}" data-action="like">èµ (${p.likes?.length||0})</button><button class="action" data-id="${p.id}" data-action="comment">è¯„è®º (${p.comments?.length||0})</button></div>`;
    feedList.appendChild(node);
  }
  // bind actions
  feedList.querySelectorAll('button').forEach(b=>{
    b.addEventListener('click', (e)=>{
      const id = b.dataset.id; const act = b.dataset.action;
      if(act==='like') toggleLike(id); else openComment(id);
    });
  });
}
function toggleLike(id){
  const list = loadFeed(); const p = list.find(x=>x.id===id); if(!p) return;
  const me = state.me.name || 'ä½ '; p.likes = p.likes || [];
  const ix = p.likes.indexOf(me); if(ix>=0) p.likes.splice(ix,1); else p.likes.push(me);
  saveFeed(list); renderFeed();
}
function openComment(id){
  const txt = prompt('è¾“å…¥è¯„è®ºï¼š'); if(!txt) return;
  const list = loadFeed(); const p = list.find(x=>x.id===id); if(!p) return;
  p.comments = p.comments || []; p.comments.push({ name: state.me.name || 'ä½ ', text: txt, ts: Date.now() });
  saveFeed(list); renderFeed();
}

/* ---- misc helpers ---- */
function showModal(el){ el.style.display='flex'; el.setAttribute('aria-hidden','false'); }
function closeModal(el){ el.style.display='none'; el.setAttribute('aria-hidden','true'); }
async function fileToDataUrl(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror= rej; fr.readAsDataURL(file); }); }

/* ---- contact save & utils ----- */
async function saveContact(){
  const name = contactName.value.trim(); if(!name) return alert('è¯·è¾“å…¥åå­—');
  let avatar = '';
  if(contactFile.files && contactFile.files[0]) avatar = await fileToDataUrl(contactFile.files[0]);
  else if(contactURL.value.trim()) avatar = contactURL.value.trim();
  const id = 'c'+Date.now();
  state.contacts.push({ id, name, avatar }); saveState(); renderContacts(); applyEmptyHint(); closeModal(contactModal);
}

/* file to data url used above */
async function fileToDataUrl(file){ return new Promise((resolve,reject)=>{ const fr=new FileReader(); fr.onload = ()=> resolve(fr.result); fr.onerror = reject; fr.readAsDataURL(file); }); }

/* feed persistence */
function loadFeed(){ try{ return JSON.parse(localStorage.getItem(FEED_KEY)||'[]'); }catch(e){return [];} }
function saveFeed(list){ localStorage.setItem(FEED_KEY, JSON.stringify(list)); }

/* export simple for debug (not shown in UI) */
function exportState(){
  const blob = new Blob([JSON.stringify(state,null,2)],{type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'nie_state.json'; a.click();
  URL.revokeObjectURL(url);
}

/* utility functions */
function escapeHtml(s){ if(!s) return ''; return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
function defaultAvatar(){ return 'data:image/svg+xml;utf8,' + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect rx='36' width='100%' height='100%' fill='white'/><text x='50%' y='50%' font-size='110' text-anchor='middle' dominant-baseline='central'>ğŸ™‚</text></svg>`); }

/* prevent overlay issues on mobile */
document.body.addEventListener('touchstart', ()=>{}, {passive:true});

/* ensure initial data exists */
if(!state.contacts || state.contacts.length===0) state.contacts = DEFAULT.contacts;
if(!state.conversations) state.conversations = DEFAULT.conversations;
saveState(); renderContacts(); applyEmptyHint(); renderFeed();

</script>
</body>
</html>
