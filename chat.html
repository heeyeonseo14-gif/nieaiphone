<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>NIEaiphone â€” Chat</title>

<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">

<style>
:root{
  --bg1:#f4e8fb;
  --bg2:#efe6fb;
  --card:#ffffff;
  --text:#2f2436;
  --muted:#7b6c88;
  --accent:#9b86e6;
  --user-bubble:#ffd6e6;
  --ai-bubble:#d7c8ff;
}
*{box-sizing:border-box}
html,body{
  margin:0;height:100%;
  font-family:"Quicksand",system-ui,-apple-system;
  background:linear-gradient(180deg,var(--bg1),var(--bg2));
}
.app{
  width:96%;
  max-width:480px;
  margin:10px auto;
  min-height:88vh;
  display:flex;
  flex-direction:column;
}
.header{
  display:flex;
  align-items:center;
  gap:10px;
}
.back{
  width:42px;height:42px;
  border-radius:12px;
  border:none;
  background:#fff;
  cursor:pointer;
  font-size:18px;
}
.h-title{flex:1;font-weight:700;font-size:18px}
.action{
  padding:8px 12px;
  border-radius:12px;
  border:none;
  background:#fff;
  cursor:pointer;
  font-weight:600;
}
.main{flex:1;margin-top:10px}
.pane{
  background:rgba(255,255,255,.97);
  border-radius:16px;
  padding:12px;
  height:100%;
  overflow:auto;
}
.hidden{display:none}
.contactsGrid{
  display:grid;
  grid-template-columns:repeat(3,1fr);
  gap:12px;
}
.contactCard{
  background:#fff;
  border-radius:14px;
  padding:10px;
  text-align:center;
  cursor:pointer;
  position:relative;
}
.contactCard img{
  width:60px;height:60px;
  border-radius:12px;
  object-fit:cover;
}
.contactName{margin-top:6px;font-size:13px;font-weight:700}
.del{
  position:absolute;
  top:6px;right:6px;
  border:none;
  background:none;
  cursor:pointer;
  color:#c66;
}
.chatHeader{
  display:flex;
  align-items:center;
  gap:10px;
  border-bottom:1px solid #eee;
  padding-bottom:8px;
}
.chatHeader img{
  width:46px;height:46px;
  border-radius:12px;
}
.messages{
  margin-top:10px;
  display:flex;
  flex-direction:column;
  gap:10px;
}
.msgRow{display:flex;gap:8px}
.msgRow.mine{justify-content:flex-end}
.bubble{
  max-width:75%;
  padding:10px 14px;
  border-radius:16px;
  font-size:15px;
}
.user{background:var(--user-bubble)}
.ai{background:var(--ai-bubble)}
.composer{
  display:flex;
  gap:8px;
  margin-top:10px;
}
textarea{
  flex:1;
  resize:none;
  padding:10px;
  border-radius:12px;
  border:1px solid #ddd;
}
.send{
  border:none;
  border-radius:12px;
  background:var(--accent);
  color:#fff;
  padding:10px 14px;
}
.bottomBar{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top:8px;
}
.toast{
  position:fixed;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  background:var(--accent);
  color:#fff;
  padding:10px 16px;
  border-radius:20px;
  display:none;
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <button class="back" id="btnBack">â†</button>
    <div class="h-title">èŠå¤©</div>
    <button class="action" id="btnAdd">ï¼‹</button>
  </div>

  <div class="main">
    <div id="contactsPane" class="pane">
      <div class="contactsGrid" id="contactsGrid"></div>
    </div>

    <div id="chatPane" class="pane hidden">
      <div class="chatHeader">
        <img id="chatAvatar">
        <div id="chatTitle"></div>
      </div>
      <div class="messages" id="messages"></div>
      <div class="composer">
        <textarea id="txt"></textarea>
        <button class="send" id="send">å‘é€</button>
      </div>
    </div>
  </div>

  <div class="bottomBar">
    <button class="action" id="openProfile">æˆ‘çš„è®¾ç½®</button>
    <button class="action" id="openBg">æ›´æ¢èƒŒæ™¯</button>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
/* =======================
   å…¨å±€çŠ¶æ€ & å­˜å‚¨
======================= */
const KEY="nie_chat_final_v1";
const DEF={
  me:{name:"ä½ ",avatar:""},
  contacts:[],
  conv:{},
  bg:""
};
let state=load();

function load(){
  try{return JSON.parse(localStorage.getItem(KEY))||structuredClone(DEF)}
  catch{return structuredClone(DEF)}
}
function save(){
  localStorage.setItem(KEY,JSON.stringify(state));
}

/* =======================
   DOM
======================= */
const grid=document.getElementById("contactsGrid");
const contactsPane=document.getElementById("contactsPane");
const chatPane=document.getElementById("chatPane");
const chatTitle=document.getElementById("chatTitle");
const chatAvatar=document.getElementById("chatAvatar");
const msgs=document.getElementById("messages");
const txt=document.getElementById("txt");
const toast=document.getElementById("toast");

/* =======================
   åˆå§‹åŒ–
======================= */
document.getElementById("btnBack").onclick=()=>location.href="home.html";
document.getElementById("send").onclick=sendMsg;
document.getElementById("btnAdd").onclick=addContact;

applyBg();
renderContacts();

/* =======================
   è”ç³»äºº
======================= */
function renderContacts(){
  grid.innerHTML="";
  state.contacts.forEach(c=>{
    const d=document.createElement("div");
    d.className="contactCard";
    d.innerHTML=`
      <button class="del">âœ•</button>
      <img src="${c.avatar||defAvatar()}">
      <div class="contactName">${c.name}</div>
    `;
    d.onclick=()=>openChat(c.id);
    d.querySelector(".del").onclick=e=>{
      e.stopPropagation();
      delContact(c.id);
    };
    grid.appendChild(d);
  });
}

function addContact(){
  const name=prompt("åå­—ï¼Ÿ");
  if(!name)return;
  const id="c"+Date.now();
  state.contacts.push({id,name,avatar:defAvatar()});
  state.conv[id]=[];
  save();renderContacts();
}

function delContact(id){
  state.contacts=state.contacts.filter(c=>c.id!==id);
  delete state.conv[id];
  save();renderContacts();
}

/* =======================
   èŠå¤©
======================= */
let active=null;
function openChat(id){
  active=id;
  const c=state.contacts.find(c=>c.id===id);
  chatTitle.textContent=c.name;
  chatAvatar.src=c.avatar;
  contactsPane.classList.add("hidden");
  chatPane.classList.remove("hidden");
  renderMsgs();
}

function renderMsgs(){
  msgs.innerHTML="";
  (state.conv[active]||[]).forEach(m=>{
    const r=document.createElement("div");
    r.className="msgRow "+(m.from==="me"?"mine":"");
    r.innerHTML=`<div class="bubble ${m.from==="me"?"user":"ai"}">${m.text}</div>`;
    msgs.appendChild(r);
  });
  msgs.scrollTop=msgs.scrollHeight;
}

function sendMsg(){
  if(!txt.value.trim())return;
  state.conv[active].push({from:"me",text:txt.value});
  const reply=genReply();
  state.conv[active].push({from:"ai",text:reply});
  txt.value="";
  save();renderMsgs();
}

function genReply(){
  const arr=[
    "æˆ‘åœ¨å¬ã€‚",
    "å—¯ï¼Œæˆ‘æ˜ç™½ä½ çš„æ„æ€ã€‚",
    "ä½ è¯´çš„æˆ‘è®°ä½äº†ã€‚",
    "å¬ä½ è¿™ä¹ˆè¯´ï¼Œæˆ‘æœ‰ç‚¹æ„Ÿè§¦ã€‚"
  ];
  return arr[Math.floor(Math.random()*arr.length)];
}

/* =======================
   èƒŒæ™¯
======================= */
function applyBg(){
  if(state.bg){
    document.querySelectorAll(".pane").forEach(p=>{
      p.style.backgroundImage=`url(${state.bg})`;
      p.style.backgroundSize="cover";
    });
  }
}
document.getElementById("openBg").onclick=()=>{
  const u=prompt("è¾“å…¥èƒŒæ™¯å›¾ç‰‡ URL");
  if(u){state.bg=u;save();applyBg();}
};

/* =======================
   å·¥å…·
======================= */
function defAvatar(){
  return "data:image/svg+xml;utf8,"+
  encodeURIComponent("<svg xmlns='http://www.w3.org/2000/svg' width='100' height='100'><text x='50%' y='55%' font-size='48' text-anchor='middle'>ğŸ™‚</text></svg>");
}
</script>
</body>
</html>
