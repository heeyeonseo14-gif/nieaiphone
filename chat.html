<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>NIEaiphone â€” èŠå¤© & æœ‹å‹åœˆï¼ˆdemoï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#f4e8fb; --bg2:#f0e7fb;
  --card:#fff; --muted:#7b6c88; --text:#2f2436;
  --accent1:#9b86e6; --accent2:#7a64d0;
  --user-bubble:#ffd6e6; --ai-bubble:#d7c8ff;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Quicksand",system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
.app{width:96%;max-width:480px;margin:8px auto;border-radius:20px;background:transparent;padding:14px;box-shadow:0 18px 50px rgba(40,24,60,0.06);overflow:hidden;min-height:86vh;display:flex;flex-direction:column}
.header{display:flex;align-items:center;gap:10px}
.back{width:44px;height:44px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;background:white;flex-shrink:0}
.h-title{flex:1;font-weight:700;font-size:18px}
.top-actions{display:flex;gap:8px}
.action{padding:8px 12px;border-radius:12px;background:white;border:1px solid rgba(0,0,0,0.04);cursor:pointer;font-weight:600;min-width:72px;text-align:center;box-shadow:0 6px 18px rgba(20,12,50,0.03)}
.action.primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 14px 30px rgba(122,100,208,0.15)}
.main{margin-top:10px;display:flex;flex-direction:column;flex:1;min-height:0}
.pane{background:rgba(255,255,255,0.98);border-radius:14px;padding:12px;flex:1;overflow:auto;position:relative;min-height:0;transition:background .28s,background-image .28s,box-shadow .28s}

/* hidden helper (fix for previous bug) */
.hidden{display:none !important}

/* contacts grid */
.contactsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding-top:6px}
.contactCard{background:linear-gradient(180deg,rgba(255,255,255,0.98),#fbf8ff);border-radius:14px;display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;cursor:pointer;transition:transform .18s,box-shadow .18s;border:1px solid rgba(0,0,0,0.02)}
.contactCard:hover{transform:translateY(-6px);box-shadow:0 22px 40px rgba(30,14,60,0.06)}
.iconWrap{width:68px;height:68px;border-radius:14px;background:linear-gradient(180deg,#fff,#faf8ff);display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:0 8px 22px rgba(20,10,40,0.04)}
.iconWrap img{width:60px;height:60px;object-fit:cover;border-radius:10px}
.contactName{font-size:13px;font-weight:700;color:var(--text);text-align:center}

/* chat header & messages */
.chatHeader{display:flex;align-items:center;gap:12px;padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.04);margin-bottom:8px}
.chatAvatar{width:52px;height:52px;border-radius:12px;overflow:hidden;flex-shrink:0}
.chatAvatar img{width:100%;height:100%;object-fit:cover}
.chatInfo{flex:1;min-width:0}
.chatTitle{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chatSub{font-size:12px;color:var(--muted);margin-top:4px}
.chatActions{display:flex;gap:8px}

/* messages */
.messages{padding:8px;display:flex;flex-direction:column;gap:12px;min-height:0;flex:1;overflow:auto}
.msgRow{display:flex;gap:10px;align-items:flex-end;transition:transform .26s,opacity .26s}
.msgRow.mine{justify-content:flex-end}
.msgAvatar{width:36px;height:36px;border-radius:8px;overflow:hidden}
.msgAvatar img{width:100%;height:100%;object-fit:cover}
.bubble{max-width:78%;padding:10px 14px;border-radius:16px;font-size:15px;line-height:1.45;box-shadow:0 10px 30px rgba(34,18,60,0.06)}
.bubble.user{background:linear-gradient(180deg,#fff0f5,var(--user-bubble));color:#3b1a2f;border-bottom-right-radius:6px}
.bubble.ai{background:linear-gradient(180deg,#f3eeff,var(--ai-bubble));color:#2b1b3a;border-bottom-left-radius:6px}

/* composer å›ºå®š */
.fixedComposer{position:sticky;bottom:10px;background:transparent;padding:10px 0;margin-top:8px}
.composer{display:flex;gap:8px;align-items:end;padding-top:8px;border-top:1px solid rgba(0,0,0,0.03)}
textarea{flex:1;min-height:48px;max-height:140px;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);resize:none}
.send{padding:10px 14px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;border:none;cursor:pointer}

/* feed */
.feedList{display:flex;flex-direction:column;gap:10px}
.feedItem{padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.03);background:#fff}
.feedMeta{display:flex;gap:10px;align-items:center}
.postActions{display:flex;gap:8px;margin-top:8px}
.likeList{font-size:12px;color:var(--muted);margin-top:6px}

/* bottom */
.bottomBar{display:flex;gap:8px;align-items:center;justify-content:center;padding-top:10px}
.userBtn{padding:8px 12px;border-radius:999px;background:white;border:1px solid rgba(0,0,0,0.04);cursor:pointer;font-weight:700}

/* modal */
.modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:220;padding:12px;pointer-events:none}
.modalWrap.show{display:flex;pointer-events:auto}
.modal{width:100%;max-width:560px;background:#fff;border-radius:14px;padding:14px;box-shadow:0 30px 80px rgba(10,10,20,0.45);max-height:86vh;overflow:auto;pointer-events:auto}
.formRow{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.formRow label{width:94px;color:var(--muted);font-size:13px}
.formRow input[type=text], .formRow input[type=file], .formRow select, .formRow textarea{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
.formRow textarea{min-height:80px;max-height:240px;resize:vertical}
.modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}

/* cute comment modal */
.commentModal .modal{max-width:420px;border-radius:18px;padding:18px}
.commentModal h3{margin:0 0 8px 0}
.commentModal textarea{width:100%;height:96px;border-radius:10px;padding:10px;border:1px solid rgba(0,0,0,0.06);font-size:14px}

/* small screens */
@media (max-width:420px){
  .contactsGrid{grid-template-columns:repeat(3,1fr);gap:10px}
  .iconWrap{width:56px;height:56px}
}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="NIE èŠå¤©åº”ç”¨">
    <div class="header">
      <button class="back" id="btnBack">â†</button>
      <div class="h-title" id="titleMain">èŠå¤©</div>
      <div class="top-actions" id="topActions">
        <button class="action" id="btnFeed">æœ‹å‹åœˆ</button>
        <button class="action" id="btnAdd">æ·»åŠ è”ç³»äºº</button>
        <button class="action" id="btnGroup">åˆ›å»ºç¾¤èŠ</button>
      </div>
    </div>

    <div class="main">
      <!-- CONTACTS -->
      <div id="contactsPane" class="pane">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700" id="contactsTitle">è”ç³»äºº</div>
          <div style="font-size:13px;color:var(--muted)">ç‚¹å‡»è¿›å…¥èŠå¤©</div>
        </div>
        <div id="contactsGrid" class="contactsGrid"></div>
        <div id="emptyHint" style="margin-top:14px;color:var(--muted);font-size:15px">å½“å‰æ²¡æœ‰è”ç³»äººï¼Œç‚¹å‡»â€œæ·»åŠ è”ç³»äººâ€å¼€å§‹ã€‚</div>
      </div>

      <!-- CHAT -->
      <div id="chatPane" class="pane hidden" role="region" aria-live="polite">
        <div class="chatHeader">
          <div class="chatAvatar" id="chatAvatar"><img src="" alt=""></div>
          <div class="chatInfo">
            <div class="chatTitle" id="chatTitle">å¯¹è¯</div>
            <div class="chatSub" id="chatSub"></div>
          </div>
          <div class="chatActions" id="chatActions">
            <button class="action" id="openAi">ä»–çš„è®¾å®š</button>
            <button class="action" id="backContacts">è¿”å›</button>
          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="fixedComposer">
          <div class="composer">
            <textarea id="txtInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰"></textarea>
            <button class="send" id="sendBtn">å‘é€</button>
          </div>
        </div>
      </div>

      <!-- FEED -->
      <div id="feedPane" class="pane hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">æœ‹å‹åœˆ</div>
          <div style="font-size:13px;color:var(--muted)">AI å¯å‘åŠ¨æ€ Â· æ”¯æŒç‚¹èµ/è¯„è®ºï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</div>
        </div>

        <div style="margin-bottom:10px">
          <textarea id="postText" placeholder="åœ¨æœ‹å‹åœˆè¯´ç‚¹ä»€ä¹ˆ..." style="width:100%;height:64px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);padding:8px"></textarea>
          <div style="display:flex;gap:8px;justify-content:flex-start;margin-top:8px;flex-wrap:wrap">
            <button class="action" id="publishBtn">å‘å¸ƒ</button>
            <button class="action" id="aiPostBtn">AI å‘ä¸€æ¡</button>
            <label style="display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;background:#fff;border:1px solid rgba(0,0,0,0.04)"><input type="checkbox" id="autoPostSwitch"> AI è‡ªåŠ¨å‘</label>
            <button class="action" id="closeFeedBtn">å…³é—­</button>
          </div>
        </div>

        <div id="feedList" class="feedList"></div>
      </div>
    </div>

    <div class="bottomBar" id="bottomBar">
      <button class="userBtn" id="openProfileBtn">æˆ‘çš„è®¾ç½®</button>
      <button class="userBtn" id="changeBgBtn">æ›´æ¢èƒŒæ™¯</button>
    </div>
  </div>

  <!-- Modals -->
  <div class="modalWrap" id="contactModal"><div class="modal" role="dialog">
    <h3>æ·»åŠ è”ç³»äºº</h3>
    <div class="formRow"><label>åå­—</label><input type="text" id="contactName" placeholder="åå­—"></div>
    <div class="formRow"><label>å¤´åƒæ–‡ä»¶</label><input type="file" id="contactFile" accept="image/*"></div>
    <div class="formRow"><label>æˆ–å¤´åƒ URL</label><input type="text" id="contactURL" placeholder="å›¾ç‰‡ URL"></div>
    <div class="modalActions"><button class="action" id="contactCancel">å–æ¶ˆ</button><button class="action primary" id="contactSave">ä¿å­˜</button></div>
  </div></div>

  <div class="modalWrap" id="groupModal"><div class="modal" role="dialog">
    <h3>åˆ›å»ºç¾¤èŠï¼ˆæœ€å¤š 8 äººï¼‰</h3>
    <div class="formRow"><label>ç¾¤å</label><input type="text" id="groupName" placeholder="ç¾¤åç§°"></div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:8px">ä»è”ç³»äººä¸­é€‰æ‹©æˆå‘˜</div>
    <div id="groupContacts" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px"></div>
    <div class="modalActions"><button class="action" id="groupCancel">å–æ¶ˆ</button><button class="action primary" id="groupCreate">åˆ›å»º</button></div>
  </div></div>

  <div class="modalWrap" id="aiModal"><div class="modal" role="dialog">
    <h3>ä»–çš„è®¾å®š</h3>
    <div class="formRow"><label>AI åç§°</label><input type="text" id="aiName"></div>
    <div class="formRow"><label>æ€§åˆ«</label><select id="aiGender"><option value="neutral">ä¸­æ€§</option><option value="female">å¥³</option><option value="male">ç”·</option></select></div>
    <div class="formRow"><label>äººè®¾</label><textarea id="aiRole" placeholder="å†™ä¸‹ AI çš„äººè®¾ï¼ˆå¯ä»¥å¤šè¡Œï¼‰"></textarea></div>
    <div class="formRow"><label>é£æ ¼/ä¹ æƒ¯</label><textarea id="aiStyleCatch" placeholder="ä¾‹å¦‚ï¼šä¿çš®ï¼›å¸¸ç”¨è¯­ï¼šå—¯å“¼ã€å¥½å“’..."></textarea></div>
    <div class="formRow"><label>AI å¤´åƒ</label><input type="file" id="aiAvatarFile" accept="image/*"></div>
    <div class="formRow"><label>å›å¤æ¡æ•°</label><input type="number" id="aiReplyCount" min="1" max="20" value="1" style="width:120px"></div>
    <div class="formRow"><label>åŠ¨ä½œ/å¿ƒç†</label><div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="aiActionsEnabled"><span style="font-size:13px;color:var(--muted)">å¼€å¯åå›å¤ä¼šå¸¦åŠ¨ä½œ/å¿ƒç†æè¿°</span></div></div>
    <div class="formRow"><label>ç”¨æˆ·æ°”æ³¡</label><input type="color" id="userColor" value="#ffd6e6"></div>
    <div class="formRow"><label>AI æ°”æ³¡</label><input type="color" id="aiColor" value="#d7c8ff"></div>
    <div class="modalActions"><button class="action" id="aiCancel">å–æ¶ˆ</button><button class="action primary" id="aiSave">ä¿å­˜</button></div>
  </div></div>

  <div class="modalWrap commentModal" id="commentModal"><div class="modal" role="dialog">
    <h3>å†™è¯„è®º</h3>
    <div style="font-size:13px;color:var(--muted);margin-bottom:8px" id="commentTargetInfo"></div>
    <textarea id="commentText" placeholder="è¯´ç‚¹ç”œç”œçš„å§ï½"></textarea>
    <div class="modalActions"><button class="action" id="commentCancel">å–æ¶ˆ</button><button class="action primary" id="commentConfirm">ç¡®å®š</button></div>
  </div></div>

  <div class="modalWrap" id="profileModal"><div class="modal" role="dialog">
    <h3>æˆ‘çš„è®¾ç½®</h3>
    <div class="formRow"><label>æˆ‘çš„åå­—</label><input type="text" id="meName"></div>
    <div class="formRow"><label>æˆ‘çš„å¤´åƒ</label><input type="file" id="meAvatarFile" accept="image/*"></div>
    <div class="formRow"><label>æˆ–å¤´åƒ URL</label><input type="text" id="meAvatarUrl" placeholder="å›¾ç‰‡ URL"></div>
    <div class="formRow"><label>æˆ‘çš„äººè®¾</label><textarea id="meRole" placeholder="å†™ä¸‹ä½ å¸Œæœ› AI çŸ¥é“çš„ä½ ï¼Œä¾‹å¦‚ï¼šçˆ±å¬æ•…äº‹ã€å–œæ¬¢å®‰é™..."></textarea></div>
    <div class="modalActions"><button class="action" id="profileCancel">å–æ¶ˆ</button><button class="action primary" id="profileSave">ä¿å­˜</button></div>
  </div></div>

  <div class="modalWrap" id="bgModal"><div class="modal" role="dialog">
    <h3>æ›´æ¢èŠå¤©èƒŒæ™¯</h3>
    <div class="formRow"><label>å›¾ç‰‡æ–‡ä»¶</label><input type="file" id="bgFile" accept="image/*"></div>
    <div class="formRow"><label>æˆ–èƒŒæ™¯ URL</label><input type="text" id="bgUrl" placeholder="å›¾ç‰‡ URLï¼ˆç•™ç©ºå¯å–æ¶ˆï¼‰"></div>
    <div class="modalActions"><button class="action" id="bgCancel">å–æ¶ˆ</button><button class="action primary" id="bgSet">è®¾ç½®</button></div>
  </div></div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

  const STATE_KEY = 'nie_full_v4';
  const FEED_KEY = 'nie_feed_v2';
  const DEFAULT = {
    me:{name:'ä½ ',avatar:'',role:''},
    ai:{name:'å°NIE',avatar:'',gender:'neutral',role:'æ¸©æŸ”çš„åŠ©æ‰‹',style:'å‹å¥½',catch:'',replyCount:1,actionsEnabled:false},
    bubble:{user:'#ffd6e6',ai:'#d7c8ff'},
    background:'',
    contacts:[],
    conversations:{},
    active:null,
    feedAuto:false,
    feedAutoInterval:60000
  };
  let state = loadState();
  let autoPostTimer = null;

  /* DOM refs */
  const contactsGrid = document.getElementById('contactsGrid');
  const emptyHint = document.getElementById('emptyHint');
  const contactsPane = document.getElementById('contactsPane');
  const chatPane = document.getElementById('chatPane');
  const feedPane = document.getElementById('feedPane');
  const topActions = document.getElementById('topActions');
  const bottomBar = document.getElementById('bottomBar');
  const chatAvatarImg = document.querySelector('#chatAvatar img');
  const chatTitle = document.getElementById('chatTitle');
  const chatSub = document.getElementById('chatSub');
  const messagesEl = document.getElementById('messages');
  const txtInput = document.getElementById('txtInput');

  /* bind */
  document.getElementById('btnAdd').addEventListener('click', ()=> openContactModal());
  document.getElementById('contactCancel').addEventListener('click', ()=> closeModal('contactModal'));
  document.getElementById('contactSave').addEventListener('click', ()=> saveContact());
  document.getElementById('btnGroup').addEventListener('click', ()=> openGroupModal());
  document.getElementById('groupCancel').addEventListener('click', ()=> closeModal('groupModal'));
  document.getElementById('groupCreate').addEventListener('click', ()=> createGroup());
  document.getElementById('btnFeed').addEventListener('click', ()=> openFeed());
  document.getElementById('closeFeedBtn').addEventListener('click', ()=> closeFeed());
  document.getElementById('publishBtn').addEventListener('click', ()=> publishPost());
  document.getElementById('aiPostBtn').addEventListener('click', ()=> aiPublish());
  document.getElementById('openAi').addEventListener('click', ()=> openAiModal());
  document.getElementById('aiCancel').addEventListener('click', ()=> closeModal('aiModal'));
  document.getElementById('aiSave').addEventListener('click', ()=> saveAiSettings());
  document.getElementById('openProfileBtn').addEventListener('click', ()=> openProfileModal());
  document.getElementById('profileCancel').addEventListener('click', ()=> closeModal('profileModal'));
  document.getElementById('profileSave').addEventListener('click', ()=> saveProfile());
  document.getElementById('backContacts').addEventListener('click', ()=> showContacts());
  document.getElementById('sendBtn').addEventListener('click', ()=> sendMsg());
  txtInput.addEventListener('keydown', (e)=> { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); } });
  document.getElementById('changeBgBtn').addEventListener('click', ()=> openBgModal());
  document.getElementById('bgCancel').addEventListener('click', ()=> closeModal('bgModal'));
  document.getElementById('bgSet').addEventListener('click', ()=> setBackgroundFromModal());

  document.getElementById('commentCancel').addEventListener('click', ()=> closeModal('commentModal'));
  document.getElementById('commentConfirm').addEventListener('click', ()=> commentConfirm());

  document.getElementById('contactModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('contactModal'); });
  document.getElementById('groupModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('groupModal'); });
  document.getElementById('aiModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('aiModal'); });
  document.getElementById('profileModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('profileModal'); });
  document.getElementById('bgModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('bgModal'); });
  document.getElementById('commentModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('commentModal'); });

  document.getElementById('autoPostSwitch').addEventListener('change', (e)=> toggleAutoPost(e.target.checked));

  /* state load/save */
  function loadState(){ try{ const raw = localStorage.getItem(STATE_KEY); if(!raw){ localStorage.setItem(STATE_KEY, JSON.stringify(DEFAULT)); return structuredClone(DEFAULT); } const parsed = JSON.parse(raw); if(!parsed || typeof parsed !== 'object'){ localStorage.setItem(STATE_KEY, JSON.stringify(DEFAULT)); return structuredClone(DEFAULT); } const merged = {...DEFAULT, ...parsed}; merged.me = {...DEFAULT.me, ...(parsed.me||{})}; merged.ai = {...DEFAULT.ai, ...(parsed.ai||{})}; merged.bubble = {...DEFAULT.bubble, ...(parsed.bubble||{})}; merged.contacts = Array.isArray(parsed.contacts) ? parsed.contacts : DEFAULT.contacts.slice(); merged.conversations = parsed.conversations && typeof parsed.conversations === 'object' ? parsed.conversations : {}; return merged; }catch(e){ console.error(e); localStorage.setItem(STATE_KEY, JSON.stringify(DEFAULT)); return structuredClone(DEFAULT); } }
  function saveState(){ try{ localStorage.setItem(STATE_KEY, JSON.stringify(state)); applyBubbleColors(); applyBackground(); }catch(e){ console.error(e); } }

  /* ensure at least one AI contact if empty */
  if(!Array.isArray(state.contacts) || state.contacts.length === 0){
    const id = 'ai_' + Date.now();
    const avatar = state.ai.avatar || defaultAvatar();
    state.contacts = [ { id, name: state.ai.name || 'å°NIE', avatar } ];
    state.conversations[id] = state.conversations[id] || { members:['me', id], messages:[] };
    saveState();
  }

  /* render contacts */
  function renderContacts(){ contactsGrid.innerHTML = ''; (state.contacts||[]).forEach(c=>{ const el = document.createElement('div'); el.className='contactCard'; el.dataset.id=c.id; const av = c.avatar || defaultAvatar(); el.innerHTML = `<div class="iconWrap"><img src="${escapeAttr(av)}" alt=""></div><div class="contactName">${escapeHtml(c.name)}</div>`; el.addEventListener('click', ()=> openConversation(c.id)); contactsGrid.appendChild(el); }); applyEmptyHint(); }
  function applyEmptyHint(){ if(!state.contacts || state.contacts.length===0) emptyHint.style.display='block'; else emptyHint.style.display='none'; }

  /* open conversation */
  function openConversation(id){
    state.active = id;
    state.conversations[id] = state.conversations[id] || { members:['me', id], messages:[] };
    const target = (state.contacts||[]).find(x=>x.id===id) || { name: (state.ai && state.ai.name)||'å¯¹æ–¹', avatar: state.ai.avatar||defaultAvatar() };
    chatTitle.textContent = target.name;
    chatSub.textContent = ''; // single chat show noäººæ•°
    chatAvatarImg.src = target.avatar || defaultAvatar();
    topActions.style.display='none'; bottomBar.style.display='none';
    contactsPane.classList.add('hidden'); chatPane.classList.remove('hidden'); feedPane.classList.add('hidden');
    renderMessages();
  }

  function showContacts(){ state.active=null; chatPane.classList.add('hidden'); feedPane.classList.add('hidden'); contactsPane.classList.remove('hidden'); topActions.style.display=''; bottomBar.style.display=''; saveState(); }

  /* messages */
  function renderMessages(){ messagesEl.innerHTML=''; const conv = state.conversations[state.active]||{messages:[]}; conv.messages.forEach(m=>{ const row=document.createElement('div'); row.className='msgRow'+(m.from==='me'?' mine':''); const avat=document.createElement('div'); avat.className='msgAvatar'; const img=document.createElement('img'); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover'; if(m.from==='me') img.src = state.me.avatar || defaultAvatar(); else { const c=state.contacts.find(x=>x.id===m.from); img.src = c ? (c.avatar||defaultAvatar()) : (state.ai.avatar||defaultAvatar()); } avat.appendChild(img); const bubble=document.createElement('div'); bubble.className='bubble ' + (m.from==='me'?'user':'ai'); bubble.innerHTML = escapeHtml(m.text).replaceAll('\\n','<br>'); if(m.from==='me'){ row.appendChild(bubble); row.appendChild(avat); } else { row.appendChild(avat); row.appendChild(bubble); } messagesEl.appendChild(row); }); messagesEl.scrollTop = messagesEl.scrollHeight; }

  function pushMessage(convId,msg){ state.conversations[convId] = state.conversations[convId] || { members:['me'], messages:[] }; state.conversations[convId].messages.push(msg); saveState(); }

  async function sendMsg(){
    const raw = txtInput.value.trim(); if(!raw) return;
    const id = state.active || (state.contacts[0] && state.contacts[0].id); if(!id) return alert('è¯·å…ˆæ·»åŠ è”ç³»äºº');
    pushMessage(id, { from:'me', text:raw, ts:Date.now() });
    txtInput.value=''; renderMessages();
    pushMessage(id, { from:'ai', text:'ï¼ˆå¯¹æ–¹æ­£åœ¨è¾“å…¥...ï¼‰', ts:Date.now(), temp:true });
    renderMessages();
    const replies = await requestReply(raw, id);
    // remove temp
    const conv = state.conversations[id]; if(conv && conv.messages.length && conv.messages[conv.messages.length-1].temp) conv.messages.pop();
    replies.forEach(r=> pushMessage(id, { from:'ai', text:r, ts:Date.now() }));
    renderMessages();
  }

  /* fake / backend reply */
  async function requestReply(userText, convId){
    const backend = localStorage.getItem('chat_backend_url');
    const persona = {...state.ai};
    const replyCount = Math.max(1, Math.min(20, (persona.replyCount||1)));
    const actionsEnabled = !!persona.actionsEnabled;
    if(backend){
      try{
        const res = await fetch(backend, {method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify({message:userText,persona})});
        if(!res.ok) throw new Error('åç«¯è¿”å› '+res.status);
        const j = await res.json();
        let text = j.reply || j.text || (j.choices && j.choices[0]?.message?.content) || JSON.stringify(j);
        let parts = (text+'').split(/\n{1,}|\.\s+/).map(s=>s.trim()).filter(Boolean);
        while(parts.length < replyCount) parts.push(parts[parts.length-1]||text);
        if(actionsEnabled) parts = parts.map(p=>`ï¼ˆä»–ç¬‘äº†ç¬‘ï¼‰${p}`);
        return parts.slice(0,replyCount);
      }catch(e){ console.warn('backend err',e); }
    }
    await new Promise(r=>setTimeout(r, 300 + Math.random()*400));
    let base = userText.includes('ç¬‘è¯') ? 'æœ‰ä¸ªå°ç¬‘è¯ï¼š...' : `ï¼ˆæ¼”ç¤ºï¼‰å…³äºã€Œ${userText}ã€æˆ‘æƒ³è¯´ï¼š${userText}`;
    let parts = base.split(/[,ï¼Œã€‚ï¼›\n]+/).filter(Boolean);
    if(parts.length===0) parts=[base];
    while(parts.length < replyCount) parts.push(parts[parts.length-1]);
    if(actionsEnabled) parts = parts.map(p=>`ï¼ˆä»–ç¬‘äº†ç¬‘ï¼‰${p}`);
    return parts.slice(0,replyCount);
  }

  /* FEED */
  function loadFeed(){ try{ return JSON.parse(localStorage.getItem(FEED_KEY)||'[]'); }catch(e){ return []; } }
  function saveFeed(list){ localStorage.setItem(FEED_KEY, JSON.stringify(list)); }
  function renderFeed(){
    const root = document.getElementById('feedList'); root.innerHTML=''; const list = loadFeed();
    for(let i=list.length-1;i>=0;i--){
      const p = list[i];
      const el = document.createElement('div'); el.className='feedItem';
      el.innerHTML = `<div class="feedMeta"><div style="width:44px;height:44px;border-radius:10px;overflow:hidden;background:#fff"><img src="${escapeAttr(p.avatar||defaultAvatar())}" style="width:100%;height:100%;object-fit:cover"></div><div style="flex:1"><div style="font-weight:700">${escapeHtml(p.name)}</div><div style="font-size:12px;color:var(--muted)">${new Date(p.ts).toLocaleString()}</div></div></div><div style="margin-top:8px">${escapeHtml(p.text)}</div><div class="postActions"><button class="action" data-id="${p.id}" data-act="like">èµ (${p.likes?.length||0})</button><button class="action" data-id="${p.id}" data-act="comment">è¯„è®º (${p.comments?.length||0})</button></div>`;
      // show like list
      const likeLine = document.createElement('div'); likeLine.className='likeList';
      const names = (p.likes||[]).join('ã€');
      likeLine.innerHTML = names ? `èµï¼š${escapeHtml(names)}` : '';
      el.appendChild(likeLine);
      if(p.comments && p.comments.length){
        const cwrap = document.createElement('div'); cwrap.style.marginTop='8px';
        p.comments.forEach(c=> cwrap.innerHTML += `<div style="font-size:13px;border-top:1px dashed rgba(0,0,0,0.03);padding:6px 0"><strong>${escapeHtml(c.name)}</strong>ï¼š${escapeHtml(c.text)}<div style="font-size:11px;color:var(--muted)">${new Date(c.ts).toLocaleString()}</div></div>`);
        el.appendChild(cwrap);
      }
      root.appendChild(el);
    }
    // bind buttons
    root.querySelectorAll('button').forEach(b=> b.addEventListener('click', (ev)=>{
      const id = ev.currentTarget.dataset.id, act = ev.currentTarget.dataset.act;
      if(act==='like') toggleLike(id);
      else openCommentModal(id);
    }));
  }

  function publishPost(){
    const t = document.getElementById('postText').value.trim(); if(!t) return alert('è¯·è¾“å…¥å†…å®¹'); const list = loadFeed();
    list.push({ id:'p'+Date.now(), name: state.me.name||'ä½ ', avatar: state.me.avatar||defaultAvatar(), text:t, likes:[], comments:[], ts:Date.now() });
    saveFeed(list); document.getElementById('postText').value=''; renderFeed();
  }
  function aiPublish(){
    const list = loadFeed();
    list.push({ id:'p'+Date.now(), name: state.ai.name||'å°NIE', avatar: state.ai.avatar||defaultAvatar(), text: (state.ai.catch||'ä»Šå¤©ä¹Ÿæƒ³å’Œä½ è¯´ç‚¹å¿ƒé‡Œè¯ï½'), likes:[], comments:[], ts:Date.now() });
    saveFeed(list); renderFeed();
  }
  function toggleLike(id){
    const list = loadFeed(); const p = list.find(x=>x.id===id); if(!p) return;
    const me = state.me.name || 'ä½ '; p.likes = p.likes || []; const idx = p.likes.indexOf(me); if(idx>=0) p.likes.splice(idx,1); else p.likes.push(me); saveFeed(list); renderFeed();
  }

  /* comment modal */
  let commentTarget = null;
  function openCommentModal(id){
    commentTarget = id;
    const post = loadFeed().find(x=>x.id===id);
    document.getElementById('commentTargetInfo').textContent = post ? `${post.name} Â· ${new Date(post.ts).toLocaleString()}` : '';
    document.getElementById('commentText').value = '';
    showModal('commentModal');
  }
  function commentConfirm(){
    const text = document.getElementById('commentText').value.trim(); if(!text) return alert('è¯·è¾“å…¥è¯„è®º'); const list = loadFeed(); const p = list.find(x=>x.id===commentTarget); if(!p) return closeModal('commentModal');
    p.comments = p.comments || []; p.comments.push({ name: state.me.name||'ä½ ', text, ts:Date.now() }); saveFeed(list); renderFeed(); closeModal('commentModal');
  }

  function openFeed(){ contactsPane.classList.add('hidden'); chatPane.classList.add('hidden'); feedPane.classList.remove('hidden'); renderFeed(); document.getElementById('autoPostSwitch').checked = !!state.feedAuto; }
  function closeFeed(){ feedPane.classList.add('hidden'); contactsPane.classList.remove('hidden'); chatPane.classList.add('hidden'); topActions.style.display=''; bottomBar.style.display=''; saveState(); }

  function toggleAutoPost(on){
    state.feedAuto = !!on; saveState();
    if(autoPostTimer) { clearInterval(autoPostTimer); autoPostTimer = null; }
    if(on){ autoPostTimer = setInterval(()=> aiPublish(), state.feedAutoInterval || 60000); }
  }

  /* modals util */
  function showModal(id){ const el = document.getElementById(id); el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
  function closeModal(id){ const el = document.getElementById(id); el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

  /* ai modal */
  function openAiModal(){
    document.getElementById('aiName').value = state.ai.name || '';
    document.getElementById('aiGender').value = state.ai.gender || 'neutral';
    document.getElementById('aiRole').value = state.ai.role || '';
    document.getElementById('aiStyleCatch').value = (state.ai.style ? state.ai.style + (state.ai.catch ? 'ï¼›' + state.ai.catch : '') : state.ai.catch || '');
    document.getElementById('userColor').value = state.bubble.user || '#ffd6e6';
    document.getElementById('aiColor').value = state.bubble.ai || '#d7c8ff';
    document.getElementById('aiReplyCount').value = state.ai.replyCount || 1;
    document.getElementById('aiActionsEnabled').checked = !!state.ai.actionsEnabled;
    showModal('aiModal');
  }
  async function saveAiSettings(){
    state.ai.name = document.getElementById('aiName').value.trim() || state.ai.name;
    state.ai.gender = document.getElementById('aiGender').value;
    state.ai.role = document.getElementById('aiRole').value.trim();
    const sc = document.getElementById('aiStyleCatch').value.trim();
    if(sc.includes('ï¼›')||sc.includes(';')||sc.includes(',')){ const parts=sc.split(/ï¼›|;|,/).map(s=>s.trim()).filter(Boolean); state.ai.style=parts[0]||state.ai.style; state.ai.catch=parts.slice(1).join('ï¼›')||state.ai.catch; } else { state.ai.style=sc||state.ai.style; state.ai.catch=sc||state.ai.catch; }
    const f = document.getElementById('aiAvatarFile').files; if(f && f[0]) state.ai.avatar = await fileToDataUrl(f[0]);
    state.bubble.user = document.getElementById('userColor').value || state.bubble.user;
    state.bubble.ai = document.getElementById('aiColor').value || state.bubble.ai;
    let rc = parseInt(document.getElementById('aiReplyCount').value) || 1; rc = Math.max(1, Math.min(20, rc)); state.ai.replyCount = rc;
    state.ai.actionsEnabled = !!document.getElementById('aiActionsEnabled').checked;
    // update AI contact if exists
    const aiContact = (state.contacts||[]).find(c=>String(c.id).startsWith('ai_'));
    if(aiContact){ aiContact.name = state.ai.name || aiContact.name; aiContact.avatar = state.ai.avatar || aiContact.avatar; }
    saveState(); closeModal('aiModal'); alert('å·²ä¿å­˜ä»–çš„è®¾å®š');
    renderContacts();
  }

  /* profile */
  function openProfileModal(){ document.getElementById('meName').value = state.me.name || ''; document.getElementById('meRole').value = state.me.role || ''; document.getElementById('meAvatarUrl').value = ''; showModal('profileModal'); }
  async function saveProfile(){
    state.me.name = document.getElementById('meName').value.trim() || state.me.name;
    state.me.role = document.getElementById('meRole').value.trim();
    const f = document.getElementById('meAvatarFile').files;
    if(f && f[0]) state.me.avatar = await fileToDataUrl(f[0]);
    else if(document.getElementById('meAvatarUrl').value.trim()) state.me.avatar = document.getElementById('meAvatarUrl').value.trim();
    saveState(); closeModal('profileModal'); alert('å·²ä¿å­˜ä¸ªäººè®¾ç½®');
  }

  /* contact/group */
  function openContactModal(){ document.getElementById('contactName').value=''; document.getElementById('contactFile').value=''; document.getElementById('contactURL').value=''; showModal('contactModal'); }
  async function saveContact(){ const name=document.getElementById('contactName').value.trim(); if(!name) return alert('è¯·è¾“å…¥åå­—'); let avatar=''; if(document.getElementById('contactFile').files && document.getElementById('contactFile').files[0]) avatar = await fileToDataUrl(document.getElementById('contactFile').files[0]); else if(document.getElementById('contactURL').value.trim()) avatar = document.getElementById('contactURL').value.trim(); const id='c'+Date.now(); state.contacts.push({ id, name, avatar }); state.conversations[id] = state.conversations[id] || { members:['me', id], messages:[] }; saveState(); renderContacts(); closeModal('contactModal'); }
  function openGroupModal(){ const list = document.getElementById('groupContacts'); list.innerHTML=''; (state.contacts||[]).forEach(c=>{ const el=document.createElement('div'); el.style.textAlign='center'; el.style.padding='6px'; el.innerHTML = `<label style="display:flex;flex-direction:column;align-items:center;gap:6px"><input type="checkbox" value="${c.id}"><div style="font-size:13px">${escapeHtml(c.name)}</div></label>`; list.appendChild(el); }); document.getElementById('groupName').value=''; showModal('groupModal'); }
  async function createGroup(){ const checked = Array.from(document.querySelectorAll('#groupContacts input[type=checkbox]:checked')).map(i=>i.value); if(checked.length<1) return alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä½æˆå‘˜'); if(checked.length+1>8) return alert('æœ€å¤š 8 äºº'); const name=document.getElementById('groupName').value.trim() || ('ç¾¤èŠ'+Math.floor(Math.random()*90+10)); const gid='g'+Date.now(); state.conversations[gid] = { members:['me', ...checked], messages:[], name }; state.contacts.push({ id:gid, name, avatar: defaultAvatar() }); saveState(); renderContacts(); closeModal('groupModal'); alert('ç¾¤èŠåˆ›å»ºæˆåŠŸ'); }

  /* background modal */
  function openBgModal(){ document.getElementById('bgFile').value=''; document.getElementById('bgUrl').value=''; showModal('bgModal'); }
  async function setBackgroundFromModal(){
    const f = document.getElementById('bgFile').files;
    if(f && f[0]) state.background = await fileToDataUrl(f[0]);
    else if(document.getElementById('bgUrl').value.trim()) state.background = document.getElementById('bgUrl').value.trim();
    else { state.background = ''; }
    saveState(); closeModal('bgModal'); alert('å·²è®¾ç½®èŠå¤©å¡ç‰‡èƒŒæ™¯'); applyBackground();
  }

  /* !! IMPORTANT FIXED: apply background to .pane (inner white card), not outer .app */
  function applyBackground(){
    const panes = document.querySelectorAll('.pane');
    panes.forEach(p=>{
      if(state.background){
        // use background image on the white card
        p.style.backgroundImage = `url('${escapeAttr(state.background)}')`;
        p.style.backgroundSize = 'cover';
        p.style.backgroundPosition = 'center';
        p.style.backgroundRepeat = 'no-repeat';
        // make card semi-opaque so text is readable (optional)
        p.style.backgroundColor = 'rgba(255,255,255,0.6)';
      } else {
        p.style.backgroundImage = '';
        p.style.backgroundColor = 'rgba(255,255,255,0.98)';
      }
    });
  }

  function applyBubbleColors(){ document.documentElement.style.setProperty('--user-bubble', state.bubble.user || '#ffd6e6'); document.documentElement.style.setProperty('--ai-bubble', state.bubble.ai || '#d7c8ff'); }

  /* utils */
  function defaultAvatar(){ return 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect rx='36' width='100%' height='100%' fill='white'/><text x='50%' y='50%' font-size='110' text-anchor='middle' dominant-baseline='central'>ğŸ™‚</text></svg>`); }
  function escapeHtml(s){ if(!s) return ''; return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function escapeAttr(s){ return (s||'').replaceAll('"','&quot;'); }
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload = ()=> res(fr.result); fr.onerror = rej; fr.readAsDataURL(file); }); }

  /* initial render & restore auto */
  renderContacts(); applyEmptyHint(); applyBubbleColors(); applyBackground(); renderFeed(); saveState();
  // å…³é”®ä¿®å¤ï¼šæ‰“å¼€é¡µé¢é»˜è®¤å›åˆ°è”ç³»äººé¢æ¿ï¼ˆé¿å…å¤šé¢æ¿å †å ï¼‰
  showContacts();

  if(state.feedAuto) toggleAutoPost(true);

  /* helper for debug if needed */
  window._NIE = { state, saveState, renderContacts, renderFeed, loadFeed };

  /* renderContacts/others defined earlier in file scope when needed (kept above) */

}); // DOMContentLoaded
</script>
</body>
</html>
