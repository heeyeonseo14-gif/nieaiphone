<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
<title>NIEaiphone â€” èŠå¤©ï¼ˆä¿®æ­£ç‰ˆï¼‰</title>
<link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --bg1:#f4e8fb; --bg2:#f0e7fb;
  --card:#fff; --muted:#7b6c88; --text:#2f2436;
  --accent1:#9b86e6; --accent2:#7a64d0;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:"Quicksand",system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));color:var(--text);-webkit-font-smoothing:antialiased}
.app{width:96%;max-width:480px;margin:8px auto;border-radius:20px;background:transparent;padding:14px;box-shadow:0 18px 50px rgba(40,24,60,0.06);overflow:hidden;min-height:86vh;display:flex;flex-direction:column}
.header{display:flex;align-items:center;gap:10px}
.back{width:44px;height:44px;border-radius:12px;border:1px solid rgba(0,0,0,0.04);display:flex;align-items:center;justify-content:center;cursor:pointer;background:white;flex-shrink:0}
.h-title{flex:1;font-weight:700;font-size:18px}
.top-actions{display:flex;gap:8px}
.action{padding:8px 12px;border-radius:12px;background:white;border:1px solid rgba(0,0,0,0.04);cursor:pointer;font-weight:600;min-width:72px;text-align:center;box-shadow:0 6px 18px rgba(20,12,50,0.03)}
.action.primary{background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;border:none;box-shadow:0 14px 30px rgba(122,100,208,0.15)}
.main{margin-top:10px;display:flex;flex-direction:column;flex:1;min-height:0}
.pane{background:rgba(255,255,255,0.98);border-radius:14px;padding:12px;flex:1;overflow:auto;position:relative;min-height:0;transition:background .28s,background-image .28s,box-shadow .28s}
.hidden{display:none !important}
.contactsGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding-top:6px}
.contactCard{background:linear-gradient(180deg,rgba(255,255,255,0.98),#fbf8ff);border-radius:14px;display:flex;flex-direction:column;align-items:center;gap:8px;padding:12px;cursor:pointer;transition:transform .18s,box-shadow .18s;border:1px solid rgba(0,0,0,0.02)}
.iconWrap{width:68px;height:68px;border-radius:14px;background:linear-gradient(180deg,#fff,#faf8ff);display:flex;align-items:center;justify-content:center;overflow:hidden;box-shadow:0 8px 22px rgba(20,10,40,0.04)}
.iconWrap img{width:60px;height:60px;object-fit:cover;border-radius:10px}
.contactName{font-size:13px;font-weight:700;color:var(--text);text-align:center}
.chatHeader{display:flex;align-items:center;gap:12px;padding-bottom:8px;border-bottom:1px solid rgba(0,0,0,0.04);margin-bottom:8px}
.chatAvatar{width:52px;height:52px;border-radius:12px;overflow:hidden;flex-shrink:0}
.chatAvatar img{width:100%;height:100%;object-fit:cover}
.chatInfo{flex:1;min-width:0}
.chatTitle{font-weight:700;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chatSub{font-size:12px;color:var(--muted);margin-top:4px}
.chatActions{display:flex;gap:8px}
.messages{padding:8px;display:flex;flex-direction:column;gap:12px;min-height:0;flex:1;overflow:auto}
.msgRow{display:flex;gap:10px;align-items:flex-end;transition:transform .26s,opacity .26s}
.msgRow.mine{justify-content:flex-end}
.msgAvatar{width:36px;height:36px;border-radius:8px;overflow:hidden}
.msgAvatar img{width:100%;height:100%;object-fit:cover}
.bubble{max-width:78%;padding:10px 14px;border-radius:16px;font-size:15px;line-height:1.45;box-shadow:0 10px 30px rgba(34,18,60,0.06)}
.bubble.user{background:linear-gradient(180deg,#fff0f5,#ffd6e6);color:#3b1a2f;border-bottom-right-radius:6px}
.bubble.ai{background:linear-gradient(180deg,#f3eeff,#d7c8ff);color:#2b1b3a;border-bottom-left-radius:6px}
.fixedComposer{position:sticky;bottom:10px;background:transparent;padding:10px 0;margin-top:8px}
.composer{display:flex;gap:8px;align-items:end;padding-top:8px;border-top:1px solid rgba(0,0,0,0.03)}
textarea{flex:1;min-height:48px;max-height:140px;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);resize:none}
.send{padding:10px 14px;border-radius:12px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:white;border:none;cursor:pointer}
.feedList{display:flex;flex-direction:column;gap:10px}
.feedItem{padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.03);background:#fff}
.postActions{display:flex;gap:8px;margin-top:8px}
.likeList{font-size:12px;color:var(--muted);margin-top:6px}
.bottomBar{display:flex;gap:8px;align-items:center;justify-content:center;padding-top:10px}
.userBtn{padding:8px 12px;border-radius:999px;background:white;border:1px solid rgba(0,0,0,0.04);cursor:pointer;font-weight:700}
.modalWrap{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.36);z-index:220;padding:12px;pointer-events:none}
.modalWrap.show{display:flex;pointer-events:auto}
.modal{width:100%;max-width:560px;background:#fff;border-radius:14px;padding:14px;box-shadow:0 30px 80px rgba(10,10,20,0.45);max-height:86vh;overflow:auto;pointer-events:auto}
.formRow{display:flex;gap:8px;align-items:center;margin-bottom:10px}
.formRow label{width:94px;color:var(--muted);font-size:13px}
.formRow input[type=text], .formRow input[type=file], .formRow select, .formRow textarea{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
.formRow textarea{min-height:80px;max-height:240px;resize:vertical}
.modalActions{display:flex;gap:8px;justify-content:flex-end;margin-top:8px}
.commentModal .modal{max-width:420px;border-radius:18px;padding:18px}
.commentModal h3{margin:0 0 8px 0}
.toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:linear-gradient(135deg,var(--accent1),var(--accent2));color:#fff;padding:10px 16px;border-radius:18px;box-shadow:0 10px 30px rgba(30,18,80,0.18);z-index:999;display:none;pointer-events:none}
@media (max-width:420px){
  .contactsGrid{grid-template-columns:repeat(3,1fr);gap:10px}
  .iconWrap{width:56px;height:56px}
}
</style>
</head>
<body>
  <div class="app" role="application" aria-label="NIE èŠå¤©åº”ç”¨">
    <div class="header">
      <button class="back" id="btnBack">â†</button>
      <div class="h-title" id="titleMain">èŠå¤©</div>
      <div class="top-actions" id="topActions">
        <button class="action" id="btnFeed">æœ‹å‹åœˆ</button>
        <button class="action" id="btnAdd">æ·»åŠ è”ç³»äºº</button>
        <button class="action" id="btnGroup">åˆ›å»ºç¾¤èŠ</button>
      </div>
    </div>

    <div class="main">
      <div id="contactsPane" class="pane">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700" id="contactsTitle">è”ç³»äºº</div>
          <div style="font-size:13px;color:var(--muted)">ç‚¹å‡»è¿›å…¥èŠå¤©</div>
        </div>
        <div id="contactsGrid" class="contactsGrid"></div>
        <div id="emptyHint" style="margin-top:14px;color:var(--muted);font-size:15px">å½“å‰æ²¡æœ‰è”ç³»äººï¼Œç‚¹å‡»â€œæ·»åŠ è”ç³»äººâ€å¼€å§‹ã€‚</div>
      </div>

      <div id="chatPane" class="pane hidden" role="region" aria-live="polite">
        <div class="chatHeader">
          <div class="chatAvatar" id="chatAvatar"><img src="" alt=""></div>
          <div class="chatInfo">
            <div class="chatTitle" id="chatTitle">å¯¹è¯</div>
            <div class="chatSub" id="chatSub"></div>
          </div>
          <div class="chatActions" id="chatActions">
            <button class="action" id="openAi">ä»–çš„è®¾å®š</button>
            <button class="action" id="backContacts">è¿”å›</button>
          </div>
        </div>

        <div id="messages" class="messages"></div>

        <div class="fixedComposer">
          <div class="composer">
            <textarea id="txtInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰"></textarea>
            <button class="send" id="sendBtn">å‘é€</button>
          </div>
        </div>
      </div>

      <div id="feedPane" class="pane hidden">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
          <div style="font-weight:700">æœ‹å‹åœˆ</div>
          <div style="font-size:13px;color:var(--muted)">AI å¯å‘åŠ¨æ€ Â· æ”¯æŒç‚¹èµ/è¯„è®ºï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</div>
        </div>

        <div style="margin-bottom:10px">
          <textarea id="postText" placeholder="åœ¨æœ‹å‹åœˆè¯´ç‚¹ä»€ä¹ˆ..." style="width:100%;height:64px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);padding:8px"></textarea>
          <div style="display:flex;gap:8px;justify-content:flex-start;margin-top:8px;flex-wrap:wrap">
            <button class="action" id="publishBtn">å‘å¸ƒ</button>
            <button class="action" id="aiPostBtn">AI å‘ä¸€æ¡</button>
            <label style="display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;background:#fff;border:1px solid rgba(0,0,0,0.04)"><input type="checkbox" id="autoPostSwitch"> AI è‡ªåŠ¨å‘</label>
            <button class="action" id="closeFeedBtn">å…³é—­</button>
          </div>
        </div>

        <div id="feedList" class="feedList"></div>
      </div>
    </div>

    <div class="bottomBar" id="bottomBar">
      <button class="userBtn" id="openProfileBtn">æˆ‘çš„è®¾ç½®</button>
      <button class="userBtn" id="changeBgBtn">æ›´æ¢èƒŒæ™¯</button>
    </div>
  </div>

  <!-- Modals -->
  <div class="modalWrap" id="contactModal"><div class="modal" role="dialog">
    <h3>æ·»åŠ è”ç³»äºº</h3>
    <div class="formRow"><label>åå­—</label><input type="text" id="contactName" placeholder="åå­—"></div>
    <div class="formRow"><label>å¤´åƒæ–‡ä»¶</label><input type="file" id="contactFile" accept="image/*"></div>
    <div class="formRow"><label>æˆ–å¤´åƒ URL</label><input type="text" id="contactURL" placeholder="å›¾ç‰‡ URL"></div>
    <div class="formRow"><label>äººè®¾ (role)</label><input type="text" id="contactRole" placeholder="ä¾‹å¦‚ï¼šæ¸©æŸ”ã€å‚²å¨‡..."></div>
    <div class="modalActions"><button class="action" id="contactCancel">å–æ¶ˆ</button><button class="action primary" id="contactSave">ä¿å­˜</button></div>
  </div></div>

  <div class="modalWrap" id="groupModal"><div class="modal" role="dialog">
    <h3>åˆ›å»ºç¾¤èŠï¼ˆæœ€å¤š 8 äººï¼‰</h3>
    <div class="formRow"><label>ç¾¤å</label><input type="text" id="groupName" placeholder="ç¾¤åç§°"></div>
    <div style="font-size:13px;color:var(--muted);margin-bottom:8px">ä»è”ç³»äººä¸­é€‰æ‹©æˆå‘˜</div>
    <div id="groupContacts" style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:8px"></div>
    <div id="groupMemberRoles" style="margin-top:8px;margin-bottom:8px"></div>
    <div class="modalActions"><button class="action" id="groupCancel">å–æ¶ˆ</button><button class="action primary" id="groupCreate">åˆ›å»º</button></div>
  </div></div>

  <div class="modalWrap" id="aiModal"><div class="modal" role="dialog">
    <h3 id="aiModalTitle">ä»–çš„è®¾å®š</h3>
    <div id="aiSingleWrap">
      <div class="formRow"><label>AI åç§°</label><input type="text" id="aiName"></div>
      <div class="formRow"><label>æ€§åˆ«</label><select id="aiGender"><option value="neutral">ä¸­æ€§</option><option value="female">å¥³</option><option value="male">ç”·</option></select></div>
      <div class="formRow"><label>äººè®¾ï¼ˆä»…ä½œä¸ºç”Ÿæˆæç¤ºï¼‰</label><textarea id="aiRole" placeholder="å†™ä¸‹ AI çš„äººè®¾ï¼ˆå¯ä»¥å¤šè¡Œï¼‰"></textarea></div>
      <div class="formRow"><label>é£æ ¼/ä¹ æƒ¯</label><textarea id="aiStyleCatch" placeholder="ä¾‹å¦‚ï¼šä¿çš®ï¼›å¸¸ç”¨è¯­ï¼šå—¯å“¼ã€å¥½å“’..."></textarea></div>
      <div class="formRow"><label>AI å¤´åƒ</label><input type="file" id="aiAvatarFile" accept="image/*"></div>
      <div class="formRow"><label>å›å¤æ¡æ•°</label><input type="number" id="aiReplyCount" min="1" max="20" value="1" style="width:120px"></div>
      <div class="formRow"><label>åŠ¨ä½œ/å¿ƒç†</label><div style="display:flex;align-items:center;gap:8px"><input type="checkbox" id="aiActionsEnabled"><span style="font-size:13px;color:var(--muted)">å¼€å¯åå›å¤ä¼šå¸¦åŠ¨ä½œ/å¿ƒç†æè¿°</span></div></div>
      <div class="formRow"><label>ç”¨æˆ·æ°”æ³¡</label><input type="color" id="userColor" value="#ffd6e6"></div>
      <div class="formRow"><label>AI æ°”æ³¡</label><input type="color" id="aiColor" value="#d7c8ff"></div>
    </div>

    <div id="aiGroupWrap" style="display:none;margin-top:8px">
      <div style="font-weight:700;margin-bottom:8px">ç¾¤èŠæˆå‘˜äººè®¾ï¼ˆå¯åˆ†åˆ«è®¾ç½®ï¼‰</div>
      <div id="aiGroupMembersList"></div>
    </div>

    <div class="modalActions"><button class="action" id="aiCancel">å–æ¶ˆ</button><button class="action primary" id="aiSave">ä¿å­˜</button></div>
  </div></div>

  <div class="modalWrap commentModal" id="commentModal"><div class="modal" role="dialog">
    <h3>å†™è¯„è®º</h3>
    <div style="font-size:13px;color:var(--muted);margin-bottom:8px" id="commentTargetInfo"></div>
    <textarea id="commentText" placeholder="è¯´ç‚¹ç”œç”œçš„å§ï½"></textarea>
    <div class="modalActions"><button class="action" id="commentCancel">å–æ¶ˆ</button><button class="action primary" id="commentConfirm">ç¡®å®š</button></div>
  </div></div>

  <div class="modalWrap" id="profileModal"><div class="modal" role="dialog">
    <h3>æˆ‘çš„è®¾ç½®</h3>
    <div class="formRow"><label>æˆ‘çš„åå­—</label><input type="text" id="meName"></div>
    <div class="formRow"><label>æˆ‘çš„å¤´åƒ</label><input type="file" id="meAvatarFile" accept="image/*"></div>
    <div class="formRow"><label>æˆ–å¤´åƒ URL</label><input type="text" id="meAvatarUrl" placeholder="å›¾ç‰‡ URL"></div>
    <div class="formRow"><label>æˆ‘çš„äººè®¾</label><textarea id="meRole"></textarea></div>
    <div class="modalActions"><button class="action" id="profileCancel">å–æ¶ˆ</button><button class="action primary" id="profileSave">ä¿å­˜</button></div>
  </div></div>

  <div class="modalWrap" id="bgModal"><div class="modal" role="dialog">
    <h3>æ›´æ¢èŠå¤©èƒŒæ™¯ï¼ˆä»…æ›¿æ¢ç™½è‰²å¡ç‰‡ï¼‰</h3>
    <div class="formRow"><label>å›¾ç‰‡æ–‡ä»¶</label><input type="file" id="bgFile" accept="image/*"></div>
    <div class="formRow"><label>æˆ–èƒŒæ™¯ URL</label><input type="text" id="bgUrl" placeholder="å›¾ç‰‡ URLï¼ˆç•™ç©ºå¯å–æ¶ˆï¼‰"></div>
    <div class="modalActions"><button class="action" id="bgCancel">å–æ¶ˆ</button><button class="action primary" id="bgSet">è®¾ç½®</button></div>
  </div></div>

  <div class="toast" id="toast"></div>

<script>
document.addEventListener('DOMContentLoaded', ()=>{

  const STATE_KEY = 'nie_full_v6_fix';
  const FEED_KEY = 'nie_feed_v4';
  const DEFAULT = {
    me:{name:'ä½ ',avatar:'',role:''},
    ai:{name:'å°NIE',avatar:'',gender:'neutral',role:'',style:'å‹å¥½',catch:'',replyCount:1,actionsEnabled:false},
    bubble:{user:'#ffd6e6',ai:'#d7c8ff'},
    background:'',
    contacts:[],
    conversations:{},
    active:null,
    feedAuto:false,
    feedAutoInterval:60000
  };

  function loadState(){
    try{
      const raw = localStorage.getItem(STATE_KEY);
      if(!raw){ localStorage.setItem(STATE_KEY, JSON.stringify(DEFAULT)); return structuredClone(DEFAULT); }
      const parsed = JSON.parse(raw);
      // åšå®Œæ•´åˆå¹¶ï¼Œä¸è¦†ç›–å·²ä¿å­˜å­—æ®µ
      const merged = {...DEFAULT, ...parsed};
      merged.me = {...DEFAULT.me, ...(parsed.me||{})};
      merged.ai = {...DEFAULT.ai, ...(parsed.ai||{})};
      merged.bubble = {...DEFAULT.bubble, ...(parsed.bubble||{})};
      merged.contacts = Array.isArray(parsed.contacts) ? parsed.contacts : DEFAULT.contacts.slice();
      merged.conversations = parsed.conversations && typeof parsed.conversations === 'object' ? parsed.conversations : {};
      merged.background = parsed.background || DEFAULT.background;
      merged.active = parsed.active || null;
      merged.feedAuto = !!parsed.feedAuto;
      return merged;
    }catch(e){
      console.error('loadState err',e);
      localStorage.setItem(STATE_KEY, JSON.stringify(DEFAULT));
      return structuredClone(DEFAULT);
    }
  }

  function saveState(){
    try{
      localStorage.setItem(STATE_KEY, JSON.stringify(state));
      applyBubbleColors();
      applyBackground();
    }catch(e){ console.error(e); }
  }

  let state = loadState();
  let autoPostTimer = null;

  /* DOM refs */
  const contactsGrid = document.getElementById('contactsGrid');
  const emptyHint = document.getElementById('emptyHint');
  const contactsPane = document.getElementById('contactsPane');
  const chatPane = document.getElementById('chatPane');
  const feedPane = document.getElementById('feedPane');
  const topActions = document.getElementById('topActions');
  const bottomBar = document.getElementById('bottomBar');
  const chatAvatarImg = document.querySelector('#chatAvatar img');
  const chatTitle = document.getElementById('chatTitle');
  const chatSub = document.getElementById('chatSub');
  const messagesEl = document.getElementById('messages');
  const txtInput = document.getElementById('txtInput');
  const toastEl = document.getElementById('toast');

  /* bind ui */
  document.getElementById('btnAdd').addEventListener('click', ()=> openContactModal());
  document.getElementById('contactCancel').addEventListener('click', ()=> closeModal('contactModal'));
  document.getElementById('contactSave').addEventListener('click', ()=> saveContact());
  document.getElementById('btnGroup').addEventListener('click', ()=> openGroupModal());
  document.getElementById('groupCancel').addEventListener('click', ()=> closeModal('groupModal'));
  document.getElementById('groupCreate').addEventListener('click', ()=> createGroup());
  document.getElementById('btnFeed').addEventListener('click', ()=> openFeed());
  document.getElementById('closeFeedBtn').addEventListener('click', ()=> closeFeed());
  document.getElementById('publishBtn').addEventListener('click', ()=> publishPost());
  document.getElementById('aiPostBtn').addEventListener('click', ()=> aiPublish());
  document.getElementById('openAi').addEventListener('click', ()=> openAiModal());
  document.getElementById('aiCancel').addEventListener('click', ()=> closeModal('aiModal'));
  document.getElementById('aiSave').addEventListener('click', ()=> saveAiSettings());
  document.getElementById('openProfileBtn').addEventListener('click', ()=> openProfileModal());
  document.getElementById('profileCancel').addEventListener('click', ()=> closeModal('profileModal'));
  document.getElementById('profileSave').addEventListener('click', ()=> saveProfile());
  document.getElementById('backContacts').addEventListener('click', ()=> showContacts());
  document.getElementById('sendBtn').addEventListener('click', ()=> sendMsg());
  txtInput.addEventListener('keydown', (e)=> { if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); } });
  document.getElementById('changeBgBtn').addEventListener('click', ()=> openBgModal());
  document.getElementById('bgCancel').addEventListener('click', ()=> closeModal('bgModal'));
  document.getElementById('bgSet').addEventListener('click', ()=> setBackgroundFromModal());

  document.getElementById('commentCancel').addEventListener('click', ()=> closeModal('commentModal'));
  document.getElementById('commentConfirm').addEventListener('click', ()=> commentConfirm());

  document.getElementById('contactModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('contactModal'); });
  document.getElementById('groupModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('groupModal'); });
  document.getElementById('aiModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('aiModal'); });
  document.getElementById('profileModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('profileModal'); });
  document.getElementById('bgModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('bgModal'); });
  document.getElementById('commentModal').addEventListener('click', (e)=> { if(e.target === e.currentTarget) closeModal('commentModal'); });

  document.getElementById('autoPostSwitch').addEventListener('change', (e)=> toggleAutoPost(e.target.checked));

  /* initial: ensure at least one AI contact exists (but do not overwrite saved avatar/background) */
  (function ensureDefaultAI(){
    if(!Array.isArray(state.contacts) || state.contacts.length === 0){
      const id = 'ai_' + Date.now();
      const avatar = state.ai.avatar && state.ai.avatar.length>10 ? state.ai.avatar : defaultAvatar();
      state.contacts = [ { id, name: state.ai.name || 'å°NIE', avatar: avatar, role: state.ai.role || '' } ];
      state.conversations[id] = state.conversations[id] || { members:['me', id], messages:[] };
      saveState();
    } else {
      // if there is an ai_ contact but no avatar, sync from state.ai.avatar if exists
      const aiIndex = state.contacts.findIndex(c=>String(c.id).startsWith('ai_'));
      if(aiIndex>=0 && state.ai.avatar && state.ai.avatar.length>10){
        // replace contact object to avoid accidental shared refs
        const old = state.contacts[aiIndex];
        state.contacts[aiIndex] = { id: old.id, name: state.ai.name||old.name, avatar: state.ai.avatar, role: old.role||state.ai.role||'' };
        saveState();
      }
    }
  })();

  /* render contacts */
  function renderContacts(){
    contactsGrid.innerHTML = '';
    (state.contacts||[]).forEach(c=>{
      const el = document.createElement('div'); el.className='contactCard'; el.dataset.id=c.id;
      const av = c.avatar || defaultAvatar();
      el.innerHTML = `<div class="iconWrap"><img src="${escapeAttr(av)}" alt=""></div><div class="contactName">${escapeHtml(c.name)}</div>`;
      el.addEventListener('click', ()=> openConversation(c.id));
      contactsGrid.appendChild(el);
    });
    applyEmptyHint();
  }
  function applyEmptyHint(){ emptyHint.style.display = (!state.contacts || state.contacts.length===0) ? 'block':'none'; }

  /* open conversation */
  function openConversation(id){
    state.active = id;
    state.conversations[id] = state.conversations[id] || { members:['me', id], messages:[], name: (state.contacts.find(c=>c.id===id)?.name || 'å¯¹æ–¹') };
    const target = (state.contacts||[]).find(x=>x.id===id) || { name: state.ai.name||'å¯¹æ–¹', avatar: state.ai.avatar||defaultAvatar() };
    chatTitle.textContent = target.name;
    chatSub.textContent = ''; // don't show groupäººæ•° in single view
    chatAvatarImg.src = target.avatar || defaultAvatar();
    topActions.style.display='none'; bottomBar.style.display='none';
    contactsPane.classList.add('hidden'); chatPane.classList.remove('hidden'); feedPane.classList.add('hidden');
    renderMessages();
    saveState();
  }

  function showContacts(){ state.active=null; chatPane.classList.add('hidden'); feedPane.classList.add('hidden'); contactsPane.classList.remove('hidden'); topActions.style.display=''; bottomBar.style.display=''; saveState(); }

  /* render messages */
  function renderMessages(){
    messagesEl.innerHTML='';
    const conv = state.conversations[state.active]||{messages:[]};
    conv.messages.forEach(m=>{
      const row=document.createElement('div'); row.className='msgRow'+(m.from==='me'?' mine':'');
      const avat=document.createElement('div'); avat.className='msgAvatar';
      const img=document.createElement('img'); img.style.width='100%'; img.style.height='100%'; img.style.objectFit='cover';
      if(m.from==='me') img.src = state.me.avatar || defaultAvatar();
      else {
        const c = state.contacts.find(x=>x.id===m.from);
        img.src = c ? (c.avatar||defaultAvatar()) : (state.ai.avatar||defaultAvatar());
      }
      avat.appendChild(img);
      const bubble=document.createElement('div'); bubble.className='bubble ' + (m.from==='me'?'user':'ai');
      bubble.innerHTML = escapeHtml(m.text).replaceAll('\\n','<br>');
      if(m.from==='me'){ row.appendChild(bubble); row.appendChild(avat); }
      else { row.appendChild(avat); row.appendChild(bubble); }
      messagesEl.appendChild(row);
    });
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function pushMessage(convId,msg){
    state.conversations[convId] = state.conversations[convId] || { members:['me'], messages:[] };
    state.conversations[convId].messages.push(msg);
    saveState();
  }

  async function sendMsg(){
    const raw = txtInput.value.trim(); if(!raw) return;
    const id = state.active || (state.contacts[0] && state.contacts[0].id);
    if(!id) return showToast('è¯·å…ˆæ·»åŠ è”ç³»äºº');
    pushMessage(id, { from:'me', text:raw, ts:Date.now() });
    txtInput.value=''; renderMessages();

    const conv = state.conversations[id] || { members:[] };
    // group message handling
    if(String(id).startsWith('g')){
      const members = conv.members.filter(m=>m!=='me');
      for(const memberId of members){
        await new Promise(r=>setTimeout(r, 200 + Math.random()*300));
        const replies = await requestReplyGroup(raw, id, memberId);
        replies.forEach(r=> pushMessage(id, { from: memberId, text: r, ts: Date.now() }));
        renderMessages();
      }
      return;
    }

    // single chat
    pushMessage(id, { from:'ai', text:'...', ts:Date.now(), temp:true });
    renderMessages();
    const replies = await requestReply(raw, id);
    const convArr = state.conversations[id];
    if(convArr && convArr.messages.length && convArr.messages[convArr.messages.length-1].temp) convArr.messages.pop();
    replies.forEach(r=> pushMessage(id, { from:'ai', text:r, ts:Date.now() }));
    renderMessages();
  }

  /* requestReplyï¼ˆä¸ä¼šæŠŠäººè®¾åŸæ–‡ç›´æ¥ä½œä¸ºå›å¤ï¼‰*/
  async function requestReply(userText, convId){
    const backend = localStorage.getItem('chat_backend_url');
    const persona = {...state.ai};
    const replyCount = Math.max(1, Math.min(20, (persona.replyCount||1)));
    const actionsEnabled = !!persona.actionsEnabled;
    if(backend){
      try{
        const payload = {message:userText, persona:{ name: persona.name, gender: persona.gender, role_desc: persona.role, style: persona.style, catch: persona.catch }};
        const res = await fetch(backend, {method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify(payload)});
        if(!res.ok) throw new Error('åç«¯è¿”å› '+res.status);
        const j = await res.json();
        let text = j.reply || j.text || (j.choices && j.choices[0]?.message?.content) || JSON.stringify(j);
        let parts = splitReplyParts(text, replyCount);
        if(actionsEnabled) parts = parts.map(p=>`ï¼ˆä»–ç¬‘äº†ç¬‘ï¼‰${p}`);
        return parts.slice(0,replyCount);
      }catch(e){ console.warn('backend err',e); showToast('åç«¯è¯·æ±‚å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°ç”Ÿæˆ'); }
    }

    // fallback æœ¬åœ°ç”Ÿæˆï¼ˆå®‰å…¨ï¼‰
    await new Promise(r=>setTimeout(r, 250 + Math.random()*300));
    const baseCandidates = [];
    if(/^(ä½ å¥½|hi|å—¨|hello)/i.test(userText)) baseCandidates.push('ä½ å¥½ï½å¾ˆé«˜å…´å’Œä½ è¯´è¯');
    if(userText.length < 8) baseCandidates.push(`ä½ è¯´çš„ã€Œ${userText}ã€æˆ‘å¬åˆ°äº†`);
    if(userText.length >= 8) baseCandidates.push(`æˆ‘æ³¨æ„åˆ°ä½ æåˆ°ã€Œ${userText.slice(0,40)}ã€`);
    if(baseCandidates.length===0) baseCandidates.push('å—¯ï¼Œæˆ‘çŸ¥é“äº†');
    const styleNotes = (persona.catch || persona.style || '').split(/[ï¼›;ï¼Œ,]/).map(s=>s.trim()).filter(Boolean);
    const pickStyle = styleNotes.length ? `ï¼ˆé£æ ¼ï¼š${styleNotes[0]}ï¼‰` : '';
    const parts = [];
    for(let i=0;i<replyCount;i++){
      const j = baseCandidates[i % baseCandidates.length];
      const p = pickStyle ? `${j} ${pickStyle}` : j;
      parts.push(p);
    }
    if(actionsEnabled) return parts.map(p=>`ï¼ˆä»–è½»è½»ä¸€ç¬‘ï¼‰${p}`);
    return parts;
  }

  function splitReplyParts(text, count){
    let parts = (text+'').split(/\n{1,}|\.\s+/).map(s=>s.trim()).filter(Boolean);
    if(parts.length===0) parts = [String(text).slice(0,200)];
    while(parts.length < count) parts.push(parts[parts.length-1]||parts[0]);
    return parts.slice(0,count);
  }

  /* group reply */
  async function requestReplyGroup(userText, convId, memberId){
    const member = state.contacts.find(c=>c.id===memberId) || { name:'TA' };
    const conv = state.conversations[convId] || {};
    const memberRoles = conv.memberRoles || {};
    const role = memberRoles[memberId] || (member && member.role) || '';
    await new Promise(r=>setTimeout(r, 200 + Math.random()*200));
    // åŸºç¡€å“åº”ï¼šä¸ç›´æ¥æŠŠäººè®¾å‘ä¸ºæ¶ˆæ¯
    const short = userText.length < 20 ? userText : userText.slice(0,30);
    const base = role ? `${short}` : `${short}`;
    return [ base ];
  }

  /* FEED */
  function loadFeed(){ try{ return JSON.parse(localStorage.getItem(FEED_KEY)||'[]'); }catch(e){ return []; } }
  function saveFeed(list){ localStorage.setItem(FEED_KEY, JSON.stringify(list)); }
  function renderFeed(){
    const root = document.getElementById('feedList'); root.innerHTML=''; const list = loadFeed();
    for(let i=list.length-1;i>=0;i--){
      const p = list[i];
      if(p.ownerId){
        const owner = state.contacts.find(c=>c.id===p.ownerId);
        if(owner){ p.name = owner.name; p.avatar = owner.avatar; }
      }
      const el = document.createElement('div'); el.className='feedItem';
      el.innerHTML = `<div class="feedMeta"><div style="width:44px;height:44px;border-radius:10px;overflow:hidden;background:#fff"><img src="${escapeAttr(p.avatar||defaultAvatar())}" style="width:100%;height:100%;object-fit:cover"></div><div style="flex:1"><div style="font-weight:700">${escapeHtml(p.name)}</div><div style="font-size:12px;color:var(--muted)">${new Date(p.ts).toLocaleString()}</div></div></div><div style="margin-top:8px">${escapeHtml(p.text)}</div><div class="postActions"><button class="action" data-id="${p.id}" data-act="like">èµ (${p.likes?.length||0})</button><button class="action" data-id="${p.id}" data-act="comment">è¯„è®º (${p.comments?.length||0})</button></div>`;
      const likeLine = document.createElement('div'); likeLine.className='likeList';
      const names = (p.likes||[]).join('ã€');
      likeLine.innerHTML = names ? `èµï¼š${escapeHtml(names)}` : '';
      el.appendChild(likeLine);
      if(p.comments && p.comments.length){
        const cwrap = document.createElement('div'); cwrap.style.marginTop='8px';
        p.comments.forEach(c=> cwrap.innerHTML += `<div style="font-size:13px;border-top:1px dashed rgba(0,0,0,0.03);padding:6px 0"><strong>${escapeHtml(c.name)}</strong>ï¼š${escapeHtml(c.text)}<div style="font-size:11px;color:var(--muted)">${new Date(c.ts).toLocaleString()}</div></div>`);
        el.appendChild(cwrap);
      }
      root.appendChild(el);
    }
    root.querySelectorAll('button').forEach(b=> b.addEventListener('click', (ev)=>{
      const id = ev.currentTarget.dataset.id, act = ev.currentTarget.dataset.act;
      if(act==='like') toggleLike(id);
      else openCommentModal(id);
    }));
  }

  function publishPost(){
    const t = document.getElementById('postText').value.trim(); if(!t) return showToast('è¯·è¾“å…¥å†…å®¹');
    const list = loadFeed();
    list.push({ id:'p'+Date.now(), ownerId: null, name: state.me.name||'ä½ ', avatar: state.me.avatar||defaultAvatar(), text:t, likes:[], comments:[], ts:Date.now() });
    saveFeed(list); document.getElementById('postText').value=''; renderFeed(); showToast('å·²å‘å¸ƒ');
  }

  function aiPublish(){
    const aiContact = state.contacts.find(c=>String(c.id).startsWith('ai_')) || state.contacts[0];
    const ownerId = aiContact ? aiContact.id : null;
    const list = loadFeed();
    list.push({ id:'p'+Date.now(), ownerId: ownerId, name: aiContact ? aiContact.name : state.ai.name, avatar: aiContact ? aiContact.avatar : state.ai.avatar||defaultAvatar(), text: (state.ai.catch||'ä»Šå¤©ä¹Ÿæƒ³å’Œä½ è¯´ç‚¹å¿ƒé‡Œè¯ï½'), likes:[], comments:[], ts:Date.now() });
    saveFeed(list); renderFeed(); showToast('AI å·²å‘ä¸€æ¡');
  }

  function toggleLike(id){
    const list = loadFeed(); const p = list.find(x=>x.id===id); if(!p) return;
    const me = state.me.name || 'ä½ '; p.likes = p.likes || []; const idx = p.likes.indexOf(me); if(idx>=0) p.likes.splice(idx,1); else p.likes.push(me); saveFeed(list); renderFeed();
  }

  /* comment modal */
  let commentTarget = null;
  function openCommentModal(id){
    commentTarget = id;
    const post = loadFeed().find(x=>x.id===id);
    document.getElementById('commentTargetInfo').textContent = post ? `${post.name} Â· ${new Date(post.ts).toLocaleString()}` : '';
    document.getElementById('commentText').value = '';
    showModal('commentModal');
  }
  function commentConfirm(){
    const text = document.getElementById('commentText').value.trim(); if(!text) return showToast('è¯·è¾“å…¥è¯„è®º');
    const list = loadFeed(); const p = list.find(x=>x.id===commentTarget); if(!p) return closeModal('commentModal');
    p.comments = p.comments || []; p.comments.push({ name: state.me.name||'ä½ ', text, ts:Date.now() }); saveFeed(list); renderFeed(); closeModal('commentModal'); showToast('å·²è¯„è®º');
  }

  function openFeed(){ contactsPane.classList.add('hidden'); chatPane.classList.add('hidden'); feedPane.classList.remove('hidden'); renderFeed(); document.getElementById('autoPostSwitch').checked = !!state.feedAuto; }
  function closeFeed(){ feedPane.classList.add('hidden'); contactsPane.classList.remove('hidden'); chatPane.classList.add('hidden'); topActions.style.display=''; bottomBar.style.display=''; saveState(); }

  function toggleAutoPost(on){
    state.feedAuto = !!on; saveState();
    if(autoPostTimer) { clearInterval(autoPostTimer); autoPostTimer = null; }
    if(on){ autoPostTimer = setInterval(()=> aiPublish(), state.feedAutoInterval || 60000); showToast('AI è‡ªåŠ¨å‘å·²å¼€å¯'); }
    else showToast('AI è‡ªåŠ¨å‘å·²å…³é—­');
  }

  /* modals */
  function showModal(id){ const el = document.getElementById(id); el.classList.add('show'); el.setAttribute('aria-hidden','false'); }
  function closeModal(id){ const el = document.getElementById(id); el.classList.remove('show'); el.setAttribute('aria-hidden','true'); }

  /* AI modal: å¦‚æœ active æ˜¯ç¾¤èŠï¼Œåˆ‡æ¢åˆ° group æ¨¡å¼ï¼ŒæŒ‰æˆå‘˜åˆ†åˆ«è®¾ç½® */
  function openAiModal(){
    const active = state.active;
    document.getElementById('aiSingleWrap').style.display = 'block';
    document.getElementById('aiGroupWrap').style.display = 'none';
    document.getElementById('aiModalTitle').textContent = 'ä»–çš„è®¾å®š';
    // å•äººé»˜è®¤å€¼
    document.getElementById('aiName').value = state.ai.name || '';
    document.getElementById('aiGender').value = state.ai.gender || 'neutral';
    document.getElementById('aiRole').value = state.ai.role || '';
    document.getElementById('aiStyleCatch').value = (state.ai.style ? state.ai.style + (state.ai.catch ? 'ï¼›' + state.ai.catch : '') : state.ai.catch || '');
    document.getElementById('userColor').value = state.bubble.user || '#ffd6e6';
    document.getElementById('aiColor').value = state.bubble.ai || '#d7c8ff';
    document.getElementById('aiReplyCount').value = state.ai.replyCount || 1;
    document.getElementById('aiActionsEnabled').checked = !!state.ai.actionsEnabled;

    // å¦‚æœå½“å‰æ‰“å¼€çš„æ˜¯ç¾¤èŠï¼ˆgid ä»¥ g å¼€å¤´ï¼‰ï¼Œå‡†å¤‡ç¾¤å†…è®¾ç½®é¢æ¿
    if(active && String(active).startsWith('g')){
      const conv = state.conversations[active] || { members:[] };
      const members = conv.members.filter(m=>m!=='me'); // ä¸æ˜¾ç¤ºâ€œæˆ‘â€
      const wrap = document.getElementById('aiGroupMembersList'); wrap.innerHTML='';
      members.forEach(mid=>{
        const contact = state.contacts.find(c=>c.id===mid) || { name:'æˆå‘˜', avatar: defaultAvatar(), role:'' };
        const row = document.createElement('div'); row.style.display='flex'; row.style.gap='10px'; row.style.alignItems='flex-start'; row.style.marginBottom='10px';
        row.innerHTML = `<div style="width:64px"><div style="width:56px;height:56px;border-radius:10px;overflow:hidden"><img src="${escapeAttr(contact.avatar||defaultAvatar())}" style="width:100%;height:100%;object-fit:cover"></div><input type="file" data-mid="${escapeAttr(mid)}" accept="image/*" style="margin-top:6px"></div><div style="flex:1"><div style="font-weight:700;margin-bottom:6px">${escapeHtml(contact.name)}</div><input type="text" data-mid="${escapeAttr(mid)}" placeholder="åœ¨ç¾¤å†…æ˜¾ç¤ºçš„åå­—ï¼ˆå¯é€‰ï¼‰" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06);margin-bottom:6px"><textarea data-mid="${escapeAttr(mid)}" placeholder="ç¾¤å†…äººè®¾ï¼ˆä»…ä½œä¸ºç”Ÿæˆæç¤ºï¼‰" style="width:100%;min-height:64px;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"></textarea></div>`;
        wrap.appendChild(row);
        // å¡«é»˜è®¤å€¼
        const nameInput = row.querySelector('input[type=text]');
        const textArea = row.querySelector('textarea');
        nameInput.value = contact.name || '';
        textArea.value = (conv.memberRoles && conv.memberRoles[mid]) ? conv.memberRoles[mid] : (contact.role || '');
      });
      document.getElementById('aiSingleWrap').style.display='none';
      document.getElementById('aiGroupWrap').style.display='block';
      document.getElementById('aiModalTitle').textContent = 'ç¾¤èŠï¼šæˆå‘˜è®¾å®š';
    }
    showModal('aiModal');
  }

  async function saveAiSettings(){
    const active = state.active;
    // å¦‚æœæ˜¯ç¾¤èŠæ¨¡å¼
    if(active && String(active).startsWith('g')){
      const conv = state.conversations[active] || {};
      conv.memberRoles = conv.memberRoles || {};
      // è¯»å–ç”¨æˆ·è¾“å…¥ï¼Œå¹¶åŒæ­¥åˆ° memberRoles ä¸ contactï¼ˆå¯æ›´æ–°åå­—/å¤´åƒï¼‰
      const wrap = document.getElementById('aiGroupMembersList');
      const fileInputs = wrap.querySelectorAll('input[type=file]');
      // å…ˆå¤„ç†æ–‡ä»¶ -> dataURLï¼ˆå¼‚æ­¥ï¼‰
      const filePromises = Array.from(fileInputs).map(inp=>{
        const f = inp.files && inp.files[0];
        if(!f) return Promise.resolve({mid: inp.dataset.mid, data: null});
        return fileToDataUrl(f).then(d=>({mid: inp.dataset.mid, data: d})).catch(()=>({mid: inp.dataset.mid, data:null}));
      });
      const results = await Promise.all(filePromises);
      // å¤„ç†æ¯ä¸ªæˆå‘˜è¾“å…¥æ¡†
      const textInputs = wrap.querySelectorAll('input[type=text]');
      const textareas = wrap.querySelectorAll('textarea');
      textInputs.forEach(inp=>{
        const mid = inp.dataset.mid; const v = inp.value.trim();
        if(v){
          const c = state.contacts.find(x=>x.id===mid);
          if(c) c.name = v;
        }
      });
      textareas.forEach(ta=>{
        const mid = ta.dataset.mid; const v = ta.value.trim();
        if(mid) conv.memberRoles[mid] = v;
      });
      // apply avatars from file upload results
      results.forEach(r=>{
        if(r.data){
          const c = state.contacts.find(x=>x.id===r.mid);
          if(c) c.avatar = r.data;
        }
      });
      // save conversation back
      state.conversations[active] = conv;
      saveState();
      renderContacts();
      closeModal('aiModal');
      showToast('ç¾¤èŠæˆå‘˜è®¾å®šå·²ä¿å­˜');
      return;
    }

    // å•äºº AI ä¿å­˜ï¼ˆä¼šåŒæ­¥æ›¿æ¢ ai_ è”ç³»äººå¯¹è±¡ï¼Œä¸ä¼šå½±å“å…¶ä»–è”ç³»äººï¼‰
    state.ai.name = document.getElementById('aiName').value.trim() || state.ai.name;
    state.ai.gender = document.getElementById('aiGender').value;
    state.ai.role = document.getElementById('aiRole').value.trim();
    const sc = document.getElementById('aiStyleCatch').value.trim();
    if(sc.includes('ï¼›')||sc.includes(';')||sc.includes(',')){ const parts=sc.split(/ï¼›|;|,/).map(s=>s.trim()).filter(Boolean); state.ai.style=parts[0]||state.ai.style; state.ai.catch=parts.slice(1).join('ï¼›')||state.ai.catch; } else { state.ai.style=sc||state.ai.style; state.ai.catch=sc||state.ai.catch; }
    const f = document.getElementById('aiAvatarFile').files;
    if(f && f[0]) state.ai.avatar = await fileToDataUrl(f[0]);
    state.bubble.user = document.getElementById('userColor').value || state.bubble.user;
    state.bubble.ai = document.getElementById('aiColor').value || state.bubble.ai;
    let rc = parseInt(document.getElementById('aiReplyCount').value) || 1; rc = Math.max(1, Math.min(20, rc)); state.ai.replyCount = rc;
    state.ai.actionsEnabled = !!document.getElementById('aiActionsEnabled').checked;

    // æ‰¾åˆ° ai_ è”ç³»äººå¹¶æ›¿æ¢å¯¹è±¡ï¼ˆæ„é€ æ–°å¯¹è±¡ï¼‰
    const aiContactIndex = state.contacts.findIndex(c=> String(c.id).startsWith('ai_'));
    if(aiContactIndex >= 0){
      const old = state.contacts[aiContactIndex];
      const newObj = { id: old.id, name: state.ai.name || old.name, avatar: state.ai.avatar || old.avatar, role: state.ai.role || old.role };
      state.contacts.splice(aiContactIndex, 1, newObj);
    }
    saveState();
    closeModal('aiModal');
    renderContacts();
    showToast('å·²ä¿å­˜ä»–çš„è®¾å®š');
  }

  /* profile */
  function openProfileModal(){ document.getElementById('meName').value = state.me.name || ''; document.getElementById('meRole').value = state.me.role || ''; document.getElementById('meAvatarUrl').value = ''; showModal('profileModal'); }
  async function saveProfile(){
    state.me.name = document.getElementById('meName').value.trim() || state.me.name;
    state.me.role = document.getElementById('meRole').value.trim();
    const f = document.getElementById('meAvatarFile').files;
    if(f && f[0]) state.me.avatar = await fileToDataUrl(f[0]);
    else if(document.getElementById('meAvatarUrl').value.trim()) state.me.avatar = document.getElementById('meAvatarUrl').value.trim();
    saveState(); closeModal('profileModal'); showToast('å·²ä¿å­˜ä¸ªäººè®¾ç½®'); renderContacts();
  }

  /* contact/group */
  function openContactModal(){
    document.getElementById('contactName').value=''; document.getElementById('contactFile').value=''; document.getElementById('contactURL').value=''; document.getElementById('contactRole').value='';
    showModal('contactModal');
  }

  async function saveContact(){
    const name=document.getElementById('contactName').value.trim();
    if(!name) return showToast('è¯·è¾“å…¥åå­—');
    let avatar='';
    if(document.getElementById('contactFile').files && document.getElementById('contactFile').files[0]) avatar = await fileToDataUrl(document.getElementById('contactFile').files[0]);
    else if(document.getElementById('contactURL').value.trim()) avatar = document.getElementById('contactURL').value.trim();
    const role = document.getElementById('contactRole').value.trim();
    const id = 'c' + Date.now() + '_' + Math.floor(Math.random()*999);
    const newContact = { id, name, avatar: avatar || defaultAvatar(), role };
    state.contacts.push(newContact);
    state.conversations[id] = state.conversations[id] || { members:['me', id], messages:[] };
    saveState();
    renderContacts();
    closeModal('contactModal');
    showToast('è”ç³»äººå·²ä¿å­˜');
  }

  function openGroupModal(){
    const list = document.getElementById('groupContacts'); list.innerHTML=''; (state.contacts||[]).forEach(c=>{ const el=document.createElement('div'); el.style.textAlign='center'; el.style.padding='6px'; el.innerHTML = `<label style="display:flex;flex-direction:column;align-items:center;gap:6px"><input type="checkbox" value="${c.id}"><div style="font-size:13px">${escapeHtml(c.name)}</div></label>`; list.appendChild(el); });
    document.getElementById('groupName').value=''; document.getElementById('groupMemberRoles').innerHTML=''; showModal('groupModal');
    list.querySelectorAll('input[type=checkbox]').forEach(ch=>{
      ch.addEventListener('change', ()=> renderGroupMemberRoles());
    });
  }

  function renderGroupMemberRoles(){
    const sel = Array.from(document.querySelectorAll('#groupContacts input[type=checkbox]:checked')).map(i=>i.value);
    const wrap = document.getElementById('groupMemberRoles'); wrap.innerHTML='';
    sel.forEach(id=>{
      const c = state.contacts.find(x=>x.id===id);
      const name = c ? c.name : id;
      const avatar = (c && c.avatar) ? c.avatar : defaultAvatar();
      const div = document.createElement('div'); div.style.display='flex'; div.style.gap='8px'; div.style.alignItems='center'; div.style.marginBottom='8px';
      div.innerHTML = `<div style="width:44px;height:44px;border-radius:8px;overflow:hidden"><img src="${escapeAttr(avatar)}" style="width:100%;height:100%;object-fit:cover"></div><div style="flex:1"><div style="font-weight:700">${escapeHtml(name)}</div><input type="text" placeholder="ç¾¤å†…äººè®¾ï¼ˆä¼šåœ¨ç¾¤å†…å›å¤ä¸­ä½œä¸ºæç¤ºä½¿ç”¨ï¼‰" data-id="${escapeAttr(id)}" style="width:100%;margin-top:6px;padding:6px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)"></div>`;
      wrap.appendChild(div);
    });
  }

  async function createGroup(){
    const checked = Array.from(document.querySelectorAll('#groupContacts input[type=checkbox]:checked')).map(i=>i.value);
    if(checked.length<1) return showToast('è¯·é€‰æ‹©è‡³å°‘ä¸€ä½æˆå‘˜');
    if(checked.length+1>8) return showToast('æœ€å¤š 8 äºº');
    const name=document.getElementById('groupName').value.trim() || ('ç¾¤èŠ'+Math.floor(Math.random()*90+10));
    const gid='g' + Date.now() + '_' + Math.floor(Math.random()*999);
    const memberRoles = {};
    Array.from(document.querySelectorAll('#groupMemberRoles input[type=text]')).forEach(inp=>{
      const id = inp.dataset.id; if(id) memberRoles[id] = inp.value.trim();
    });
    state.conversations[gid] = { members:['me', ...checked], messages:[], name, memberRoles };
    const groupContact = { id: gid, name, avatar: defaultAvatar(), role: 'ç¾¤èŠ' };
    state.contacts.push(groupContact);
    saveState(); renderContacts(); closeModal('groupModal'); showToast('ç¾¤èŠåˆ›å»ºæˆåŠŸ');
  }

  /* background */
  function openBgModal(){ document.getElementById('bgFile').value=''; document.getElementById('bgUrl').value=''; showModal('bgModal'); }
  async function setBackgroundFromModal(){
    const f = document.getElementById('bgFile').files;
    if(f && f[0]) state.background = await fileToDataUrl(f[0]);
    else if(document.getElementById('bgUrl').value.trim()) state.background = document.getElementById('bgUrl').value.trim();
    else { state.background = ''; }
    saveState(); closeModal('bgModal'); applyBackground(); showToast('å·²è®¾ç½®èŠå¤©å¡ç‰‡èƒŒæ™¯ï¼ˆä»…ç™½å¡ï¼‰');
  }

  function applyBackground(){
    const panes = document.querySelectorAll('.pane');
    panes.forEach(p=>{
      if(state.background){
        p.style.backgroundImage = `url('${escapeAttr(state.background)}')`;
        p.style.backgroundSize = 'cover';
        p.style.backgroundPosition = 'center';
        p.style.backgroundRepeat = 'no-repeat';
        p.style.backgroundColor = 'rgba(255,255,255,0.6)';
      } else {
        p.style.backgroundImage = '';
        p.style.backgroundColor = 'rgba(255,255,255,0.98)';
      }
    });
  }

  function applyBubbleColors(){ document.documentElement.style.setProperty('--user-bubble', state.bubble.user || '#ffd6e6'); document.documentElement.style.setProperty('--ai-bubble', state.bubble.ai || '#d7c8ff'); }

  /* utils */
  function defaultAvatar(){ return 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='256' height='256'><rect rx='36' width='100%' height='100%' fill='white'/><text x='50%' y='50%' font-size='110' text-anchor='middle' dominant-baseline='central'>ğŸ™‚</text></svg>`); }
  function escapeHtml(s){ if(!s) return ''; return (s+'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }
  function escapeAttr(s){ return (s||'').replaceAll('"','&quot;').replaceAll("'",''); }
  function fileToDataUrl(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload = ()=> res(fr.result); fr.onerror = rej; fr.readAsDataURL(file); }); }
  function showToast(msg, ms=1500){ toastEl.textContent = msg; toastEl.style.display = 'block'; toastEl.style.opacity = '1'; setTimeout(()=>{ toastEl.style.opacity = '0'; setTimeout(()=> toastEl.style.display='none', 250); }, ms); }

  /* initial render */
  renderContacts(); applyEmptyHint(); applyBubbleColors(); applyBackground(); renderFeed(); saveState();
  showContacts();
  if(state.feedAuto) toggleAutoPost(true);

  /* expose for debug */
  window._NIE = { state, saveState, renderContacts, renderFeed, loadFeed, showToast };

}); // DOMContentLoaded
</script>
</body>
</html>
