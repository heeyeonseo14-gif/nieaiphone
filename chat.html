<!doctype html>

<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Chat â€” NIE (ç¾¤ç»„æ”¯æŒ)</title>
<style>
  :root{--bg:#f3eaf8;--card:#fff;--accent:#8a5cf0;--muted:#888}
  body{margin:0;font-family:system-ui, "PingFang SC", "Microsoft Yahei";background:var(--bg);-webkit-font-smoothing:antialiased}
  .wrap{max-width:420px;margin:12px auto;padding:12px;border-radius:24px;background:linear-gradient(#fff,#fff);box-shadow:0 6px 20px rgba(0,0,0,.06);min-height:88vh}
  .topbar{display:flex;gap:8px;align-items:center;margin-bottom:12px}
  .tabs{display:flex;gap:10px;margin-left:8px}
  .tab{background:#fff;padding:8px 12px;border-radius:12px;box-shadow:0 3px 8px rgba(0,0,0,.06);font-weight:600}
  .contacts{margin-bottom:12px}
  .contact-item{display:inline-block;width:96px;padding:12px;background:var(--card);border-radius:12px;text-align:center;margin-right:12px;box-shadow:0 6px 20px rgba(0,0,0,.04);cursor:pointer}
  .contact-item img{width:64px;height:64px;border-radius:12px;object-fit:cover}
  .section{background:var(--card);padding:12px;border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.04);margin-bottom:12px}
  .chat-header{display:flex;align-items:center;gap:12px}
  .avatar{width:48px;height:48px;border-radius:12px;background:#eee;display:flex;align-items:center;justify-content:center}
  .title{font-weight:700}
  .controls{margin-left:auto;display:flex;gap:8px}
  .btn{padding:8px 12px;border-radius:999px;background:#fff;border:none;box-shadow:0 3px 8px rgba(0,0,0,.04);cursor:pointer}
  .msgs{padding:12px;min-height:300px;max-height:60vh;overflow:auto;background-size:160px 160px}
  .msg-row{display:flex;gap:12px;align-items:flex-start;margin-bottom:10px}
  .msg-row.me{justify-content:flex-end}
  .bubble{background:linear-gradient(#e9dfff,#d9c9ff);padding:12px;border-radius:16px;max-width:72%}
  .bubble.me{background:linear-gradient(#ffdfee,#ffcfe8)}
  .input-row{display:flex;gap:8px;align-items:center;margin-top:8px}
  textarea{flex:1;padding:12px;border-radius:12px;border:1px solid #eee;height:52px;resize:none}
  .send{background:linear-gradient(135deg,var(--accent),#b88df7);color:#fff;padding:10px 14px;border-radius:14px;border:none;cursor:pointer}
  .footer-buttons{display:flex;gap:12px;justify-content:center;margin-top:16px}
  .small{font-size:13px;color:var(--muted)}
  .modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.4);display:none;align-items:center;justify-content:center}
  .modal{background:var(--card);padding:18px;border-radius:14px;width:92%;max-width:480px;max-height:80vh;overflow:auto}
  .row{display:flex;gap:8px;align-items:center;margin-bottom:8px}
  label{width:100px;color:var(--muted)}
  input[type="text"], input[type="number"], textarea.settings{flex:1;padding:8px;border-radius:8px;border:1px solid #eee}
  input[type=file]{display:block}
  .actions{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}
  .chip{display:inline-block;padding:6px 10px;border-radius:999px;background:#fff;box-shadow:0 3px 8px rgba(0,0,0,.04);cursor:pointer}
  .member-card{display:flex;gap:8px;align-items:center;padding:8px;border-radius:10px;background:#faf7ff;margin-bottom:8px}
  .member-card img{width:56px;height:56px;border-radius:10px;object-fit:cover}
</style>
</head>
<body><div class="wrap" id="wrap">
  <div class="topbar">
    <div class="tab">â†</div>
    <div class="tab">èŠå¤©</div>
    <div class="tabs">
      <div class="tab">æœ‹å‹åœˆ</div>
      <div class="tab">æ·»åŠ è”ç³»äºº</div>
      <div class="tab" id="createGroupBtn">åˆ›å»ºç¾¤èŠ</div>
    </div>
  </div>  <div class="section contacts" id="contactsContainer">
    <h3>è”ç³»äºº / ç¾¤ç»„</h3>
    <div id="contactsList"></div>
  </div>  <div class="section">
    <div class="chat-header">
      <div class="avatar" id="currentAvatar">ğŸ™‚</div>
      <div>
        <div class="title" id="currentName">å¯¹è¯</div>
        <div class="small" id="currentSub">ç‚¹å‡»è¿›å…¥èŠå¤©</div>
      </div>
      <div class="controls">
        <button class="btn" id="openHisSetting">ä»–çš„è®¾å®š</button>
        <button class="btn" id="btnReturn">è¿”å›</button>
      </div>
    </div><div class="msgs" id="msgs"></div>

<div class="input-row">
  <textarea id="inputBox" placeholder="è¾“å…¥æ¶ˆæ¯ï¼Œ Enter å‘é€ (Shift+Enter æ¢è¡Œ)"></textarea>
  <button class="send" id="sendBtn">å‘é€</button>
</div>

  </div>  <div class="section">
    <h3>æœ‹å‹åœˆ <span class="small">AI å¯å‘åŠ¨æ€ Â· æ”¯æŒç‚¹èµ/è¯„è®ºï¼ˆæœ¬åœ°ä¿å­˜ï¼‰</span></h3>
    <textarea id="momentsInput" placeholder="åœ¨æœ‹å‹åœˆè¯´ç‚¹ä»€ä¹ˆ..." style="width:100%;height:80px;padding:12px;border-radius:12px;border:1px solid #eee"></textarea>
    <div style="margin-top:8px">
      <button class="chip" id="postBtn">å‘å¸ƒ</button>
      <button class="chip" id="aiPostBtn">AI å‘ä¸€æ¡</button>
      <label style="margin-left:8px"><input type="checkbox" id="aiAutoPost"> AI è‡ªåŠ¨å‘</label>
      <button class="chip" id="closeMoments">å…³é—­</button>
    </div>
    <div id="momentsList" style="margin-top:12px"></div>
  </div>  <div style="height:24px"></div>
  <div class="footer-buttons">
    <button class="btn" id="openMySetting">æˆ‘çš„è®¾ç½®</button>
    <button class="btn" id="changeBg">æ›´æ¢èƒŒæ™¯</button>
  </div>
</div><!-- æ¨¡æ€ï¼šä»–çš„è®¾å®š --><div class="modal-bg" id="modalBg">
  <div class="modal">
    <h3>ä»–çš„è®¾ç½®</h3>
    <div class="row"><label>AI åç§°</label><input type="text" id="setName"></div>
    <div class="row"><label>æ€§åˆ«</label>
      <select id="setGender" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee">
        <option>ä¸­æ€§</option><option>å¥³</option><option>ç”·</option>
      </select>
    </div>
    <div class="row"><label>äººè®¾</label><textarea class="settings" id="setPersona" rows="3" placeholder="å†™ä¸‹ AI çš„äººè®¾ï¼ˆä½œä¸ºç”Ÿæˆæç¤ºï¼‰"></textarea></div>
    <div class="row"><label>é£æ ¼/ä¹ æƒ¯</label><textarea class="settings" id="setStyle" rows="2" placeholder="AI é£æ ¼æˆ–ä¹ æƒ¯ç”¨è¯­"></textarea></div>
    <div class="row"><label>AI å¤´åƒ</label><input type="file" id="setAvatarFile" accept="image/*"></div>
    <div class="row"><label>å›å¤æ¡æ•°</label><input type="number" id="setReplyCount" min="1" max="20" value="5"></div>
    <div class="row"><label>åŠ¨ä½œ/å¿ƒç†</label><input type="checkbox" id="setActionDesc"> å¼€å¯åå›å¤å¸¦åŠ¨ä½œ/å¿ƒç†</div><div class="actions">
  <button class="btn" id="modalCancel">å–æ¶ˆ</button>
  <button class="btn" id="modalSave">ä¿å­˜</button>
</div>

  </div>
</div><!-- æ¨¡æ€ï¼šåˆ›å»º/ç¼–è¾‘ ç¾¤èŠ --><div class="modal-bg" id="groupModalBg">
  <div class="modal">
    <h3 id="groupModalTitle">åˆ›å»ºç¾¤èŠ</h3>
    <div class="row"><label>ç¾¤èŠå</label><input type="text" id="groupName"></div>
    <div id="groupMembersContainer"></div>
    <div style="display:flex;gap:8px;margin-top:8px;margin-bottom:8px">
      <button class="chip" id="addMemberBtn">æ·»åŠ æˆå‘˜</button>
      <button class="chip" id="removeLastMemberBtn">åˆ é™¤æœ€åä¸€ä¸ªæˆå‘˜</button>
    </div>
    <div class="actions">
      <button class="btn" id="groupCancel">å–æ¶ˆ</button>
      <button class="btn" id="groupSave">ä¿å­˜ç¾¤èŠ</button>
    </div>
  </div>
</div><script>
/* IndexedDB setup */
const dbName = 'nie-db';
const dbVersion = 2; // bump for groups
let db;
function openDB(){
  return new Promise((res,rej)=>{
    const req = indexedDB.open(dbName, dbVersion);
    req.onupgradeneeded = e=>{
      const d = e.target.result;
      if(!d.objectStoreNames.contains('settings')) d.createObjectStore('settings',{keyPath:'key'});
      if(!d.objectStoreNames.contains('avatars')) d.createObjectStore('avatars',{keyPath:'id'});
      if(!d.objectStoreNames.contains('backgrounds')) d.createObjectStore('backgrounds',{keyPath:'id'});
      if(!d.objectStoreNames.contains('contacts')) d.createObjectStore('contacts',{keyPath:'id'});
      if(!d.objectStoreNames.contains('conversations')) d.createObjectStore('conversations',{keyPath:'id'});
      if(!d.objectStoreNames.contains('moments')) d.createObjectStore('moments',{keyPath:'id'});
      if(!d.objectStoreNames.contains('groups')) d.createObjectStore('groups',{keyPath:'id'});
    };
    req.onsuccess = e=>{ db = e.target.result; res(db); };
    req.onerror = e=>rej(e);
  });
}
function idbPut(store, value){ return new Promise((res,rej)=>{ const tx = db.transaction(store,'readwrite'); const s = tx.objectStore(store); const r = s.put(value); r.onsuccess = ()=>res(r.result); r.onerror = e=>rej(e); }); }
function idbGet(store, key){ return new Promise((res,rej)=>{ const tx = db.transaction(store,'readonly'); const s = tx.objectStore(store); const r = s.get(key); r.onsuccess = ()=>res(r.result); r.onerror = e=>rej(e); }); }
function idbGetAll(store){ return new Promise((res,rej)=>{ const tx = db.transaction(store,'readonly'); const s = tx.objectStore(store); const r = s.getAll(); r.onsuccess = ()=>res(r.result); r.onerror = e=>rej(e); }); }

/* helper file->dataURL */
function fileToDataURL(file){ return new Promise((res,rej)=>{ const fr=new FileReader(); fr.onload=()=>res(fr.result); fr.onerror=rej; fr.readAsDataURL(file); }); }

/* Elements */
const contactsListEl = document.getElementById('contactsList');
const msgsEl = document.getElementById('msgs');
const currentAvatarEl = document.getElementById('currentAvatar');
const currentNameEl = document.getElementById('currentName');
const currentSubEl = document.getElementById('currentSub');
const inputBox = document.getElementById('inputBox');
const sendBtn = document.getElementById('sendBtn');

const modalBg = document.getElementById('modalBg');
const setName = document.getElementById('setName');
const setGender = document.getElementById('setGender');
const setPersona = document.getElementById('setPersona');
const setStyle = document.getElementById('setStyle');
const setAvatarFile = document.getElementById('setAvatarFile');
const setReplyCount = document.getElementById('setReplyCount');
const setActionDesc = document.getElementById('setActionDesc');

const groupModalBg = document.getElementById('groupModalBg');
const groupMembersContainer = document.getElementById('groupMembersContainer');
const groupNameInput = document.getElementById('groupName');

let openConversationId = null; // contactId or groupId
let openConversationIsGroup = false;

/* events */
document.getElementById('openHisSetting').addEventListener('click', ()=> modalBg.style.display='flex');
document.getElementById('modalCancel').addEventListener('click', ()=> modalBg.style.display='none');

// Open my setting â€” load currentAI settings
document.getElementById('openMySetting').addEventListener('click', async ()=>{
  const s = await idbGet('settings','currentAI');
  if(s){ setName.value=s.name||''; setGender.value=s.gender||'ä¸­æ€§'; setPersona.value=s.persona||''; setStyle.value=s.style||''; setReplyCount.value=s.replyCount||4; setActionDesc.checked=!!s.actionDesc; }
  else { setName.value='å°NIE'; setGender.value='ä¸­æ€§'; setPersona.value=''; setStyle.value=''; setReplyCount.value=4; setActionDesc.checked=true; }
  modalBg.style.display='flex';
});

// ä¿å­˜ä»–çš„è®¾ç½®ï¼ˆcurrentAIï¼‰
document.getElementById('modalSave').addEventListener('click', async ()=>{
  const name = setName.value || 'æœªå‘½å';
  const gender = setGender.value;
  const persona = setPersona.value;
  const style = setStyle.value;
  const replyCount = parseInt(setReplyCount.value) || 4;
  const actionDesc = setActionDesc.checked;
  await idbPut('settings', { key:'currentAI', name, gender, persona, style, replyCount, actionDesc });
  if(setAvatarFile.files && setAvatarFile.files[0]){
    const data = await fileToDataURL(setAvatarFile.files[0]);
    await idbPut('avatars', { id:'currentAI', data });
  }
  alert('å·²ä¿å­˜ä»–çš„è®¾ç½®');
  modalBg.style.display='none';
  await applySettingsToUI();
});

// change background
document.getElementById('changeBg').addEventListener('click', async ()=>{
  const input = document.createElement('input'); input.type='file'; input.accept='image/*';
  input.onchange = async ()=>{
    if(input.files[0]){
      const d = await fileToDataURL(input.files[0]);
      await idbPut('backgrounds',{ id:'chatBg', data:d });
      await applySettingsToUI();
      alert('å·²ä¿å­˜èŠå¤©èƒŒæ™¯');
    }
  };
  input.click();
});

// send
sendBtn.addEventListener('click', ()=> handleSend());
inputBox.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); } });

/* create group modal open */
document.getElementById('createGroupBtn').addEventListener('click', ()=> openGroupModal());

document.getElementById('groupCancel').addEventListener('click', ()=> groupModalBg.style.display='none');

// dynamic member add/remove
document.getElementById('addMemberBtn').addEventListener('click', ()=> addMemberCard());
document.getElementById('removeLastMemberBtn').addEventListener('click', ()=> removeLastMemberCard());

// save group
document.getElementById('groupSave').addEventListener('click', async ()=>{
  const gname = groupNameInput.value.trim() || ('ç¾¤èŠ_' + Date.now());
  const cards = groupMembersContainer.querySelectorAll('.member-card');
  if(cards.length===0) return alert('è¯·æ·»åŠ è‡³å°‘ä¸€ä¸ªæˆå‘˜');
  const members = [];
  for(let i=0;i<cards.length;i++){
    const root = cards[i];
    const name = root.querySelector('.m-name').value.trim() || ('æˆå‘˜'+(i+1));
    const persona = root.querySelector('.m-persona').value || '';
    const style = root.querySelector('.m-style').value || '';
    const fileInput = root.querySelector('.m-file');
    let avatarId = 'group_' + Date.now() + '_m_' + i; // temp id
    // create unique member id per group: group_<timestamp>_m_<i>
    // but we want stable id to save avatar; we'll create after generate group id
    members.push({ name, persona, style, avatarFile: (fileInput && fileInput.files && fileInput.files[0]) ? fileInput.files[0] : null });
  }

  // create group id
  const gid = 'group_' + Date.now();
  // persist avatars and member entries
  for(let i=0;i<members.length;i++){
    const mem = members[i];
    const mid = gid + '_m_' + i;
    let avatarData = null;
    if(mem.avatarFile){ avatarData = await fileToDataURL(mem.avatarFile); await idbPut('avatars', { id: mid, data: avatarData }); }
    else {
      // default small placeholder SVG
      const placeholder = 'data:image/svg+xml;utf8,' + encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#efe6ff"/></svg>');
      await idbPut('avatars',{ id: mid, data: placeholder });
    }
    // Replace avatar reference with id
    members[i] = { id: mid, name: mem.name, persona: mem.persona, style: mem.style };
  }

  const groupObj = { id: gid, name: gname, members };
  await idbPut('groups', groupObj);

  // Add a contacts entry so it shows in contacts list
  await idbPut('contacts', { id: gid, name: gname, avatarId: (members[0] && members[0].id) ? members[0].id : 'group_default' });

  alert('å·²ä¿å­˜ç¾¤èŠï¼š' + gname);
  groupModalBg.style.display='none';
  await renderContacts();
});

/* group modal helpers */
function clearGroupModal(){ groupMembersContainer.innerHTML=''; groupNameInput.value=''; document.getElementById('groupModalTitle').textContent='åˆ›å»ºç¾¤èŠ'; }
function addMemberCard(defaults){
  const idx = groupMembersContainer.querySelectorAll('.member-card').length;
  const root = document.createElement('div'); root.className='member-card';
  root.innerHTML = `
    <img src="data:image/svg+xml;utf8,${encodeURIComponent('<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"64\" height=\"64\"><rect width=\"100%\" height=\"100%\" fill=\"#f7d9f7\"/></svg>')}" />
    <div style="flex:1">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:6px"><input class="m-name" type="text" placeholder="æˆå‘˜å" style="flex:1;padding:8px;border-radius:8px;border:1px solid #eee"/></div>
      <div style="margin-bottom:6px"><textarea class="m-persona" placeholder="ç¾¤å†…äººè®¾ï¼ˆä»…ä½œä¸ºç”Ÿæˆæç¤ºï¼‰" rows="2" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee"></textarea></div><div style="margin-bottom:6px"><textarea class="m-style" placeholder="é£æ ¼/ä¹ æƒ¯" rows="1" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee"></textarea></div>
  <div style="display:flex;gap:8px;align-items:center"><input class="m-file" type="file" accept="image/*"/></div>
</div>

`; // when user chooses file show preview const fileInput = root.querySelector('.m-file'); const img = root.querySelector('img'); fileInput.addEventListener('change', async ()=>{ if(fileInput.files && fileInput.files[0]){ const data = await fileToDataURL(fileInput.files[0]); img.src = data; } }); groupMembersContainer.appendChild(root); // initialize blanks (important: do NOT copy previous values) const nameInput = root.querySelector('.m-name'); nameInput.value = ''; const personaInput = root.querySelector('.m-persona'); personaInput.value = ''; const styleInput = root.querySelector('.m-style'); styleInput.value = ''; } function removeLastMemberCard(){ const cards = groupMembersContainer.querySelectorAll('.member-card'); if(cards.length>0) cards[cards.length-1].remove(); } function openGroupModal(editGroup){ clearGroupModal(); if(editGroup){ document.getElementById('groupModalTitle').textContent='ç¼–è¾‘ç¾¤èŠ'; groupNameInput.value = editGroup.name || ''; editGroup.members.forEach(m=>{ addMemberCard(); const card = groupMembersContainer.lastChild; card.querySelector('.m-name').value = m.name || ''; card.querySelector('.m-persona').value = m.persona || ''; card.querySelector('.m-style').value = m.style || ''; // load avatar if exists idbGet('avatars', m.id).then(a=>{ if(a && a.data) card.querySelector('img').src = a.data; }); }); } else { // new group: start with 2 empty members by default addMemberCard(); addMemberCard(); } groupModalBg.style.display='flex'; }

/* render contacts (including groups) */ async function renderContacts(){ const contacts = await idbGetAll('contacts'); const groups = await idbGetAll('groups'); contactsListEl.innerHTML=''; // contacts first if(contacts && contacts.length>0){ for(const c of contacts){ const div = document.createElement('div'); div.className='contact-item'; const img = document.createElement('img'); idbGet('avatars', c.avatarId).then(a=>{ if(a && a.data) img.src = a.data; else img.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"></svg>'; }); const name = document.createElement('div'); name.textContent = c.name; div.appendChild(img); div.appendChild(name); div.addEventListener('click', ()=> openChatWith(c.id, c.name, false)); contactsListEl.appendChild(div); } } // groups as separate cards if(groups && groups.length>0){ for(const g of groups){ const div = document.createElement('div'); div.className='contact-item'; const img = document.createElement('img'); // use first member avatar as group avatar const firstMemberId = g.members && g.members[0] ? g.members[0].id : null; if(firstMemberId){ idbGet('avatars', firstMemberId).then(a=>{ if(a && a.data) img.src = a.data; else img.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"></svg>'; }); } else img.src='data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="160" height="160"></svg>'; const name = document.createElement('div'); name.textContent = g.name; div.appendChild(img); div.appendChild(name); div.addEventListener('click', ()=> openChatWith(g.id, g.name, true)); contactsListEl.appendChild(div); } } }

/* open chat */ async function openChatWith(id, name, isGroup){ openConversationId = id; openConversationIsGroup = isGroup; currentNameEl.textContent = name; currentSubEl.textContent = isGroup ? 'ç¾¤èŠ' : 'ç‚¹å‡»è¿›å…¥èŠå¤©'; // avatar: if isGroup, show first member avatar if(isGroup){ const g = await idbGet('groups', id); if(g && g.members && g.members[0]){ const a = await idbGet('avatars', g.members[0].id); if(a && a.data){ currentAvatarEl.innerHTML = ''; const im=document.createElement('img'); im.src=a.data; im.style.width='100%'; im.style.height='100%'; im.style.borderRadius='12px'; currentAvatarEl.appendChild(im); } else currentAvatarEl.textContent='ğŸ™‚'; } else currentAvatarEl.textContent='ğŸ™‚'; } else{ const c = await idbGet('contacts', id); if(c){ const a = await idbGet('avatars', c.avatarId); if(a && a.data){ currentAvatarEl.innerHTML=''; const im=document.createElement('img'); im.src=a.data; im.style.width='100%'; im.style.height='100%'; im.style.borderRadius='12px'; currentAvatarEl.appendChild(im); } else currentAvatarEl.textContent='ğŸ™‚'; } } // load conversation messages msgsEl.innerHTML=''; const conv = await idbGet('conversations', id); if(conv && conv.messages){ conv.messages.forEach(m=> appendMessageToDom(m)); } }

function appendMessageToDom(m){ const row = document.createElement('div'); row.className='msg-row ' + (m.from==='me' ? 'me' : ''); const av = document.createElement('div'); av.className='avatar'; av.style.flex='0 0 34px'; av.textContent='ğŸ™‚'; if(m.avatarData){ const im = document.createElement('img'); im.src=m.avatarData; im.style.width='34px'; im.style.height='34px'; im.style.borderRadius='8px'; av.innerHTML=''; av.appendChild(im); } const b = document.createElement('div'); b.className='bubble ' + (m.from==='me' ? 'me' : ''); b.textContent = m.text; if(m.from==='me'){ row.appendChild(b); row.appendChild(av); } else { row.appendChild(av); row.appendChild(b); } msgsEl.appendChild(row); msgsEl.scrollTop = msgsEl.scrollHeight; }

/* send logic */ async function handleSend(){ const text = inputBox.value.trim(); if(!text) return; const contactId = openConversationId || await guessOpenContactId(); const avatarObj = await idbGet('avatars','me'); const message = { id:'msg_'+Date.now(), from:'me', text, avatarData: avatarObj ? avatarObj.data : null, ts: new Date().toISOString() }; const conv = (await idbGet('conversations', contactId)) || { id:contactId, messages:[] }; conv.messages.push(message); await idbPut('conversations', conv); appendMessageToDom(message); inputBox.value=''; setTimeout(()=> aiAutoReply(contactId, text), 500 + Math.random()*600); }

async function guessOpenContactId(){ const contacts = await idbGetAll('contacts'); if(contacts && contacts.length>0) return contacts[0].id; const demo = { id:'contact_demo', name:'å°NIE', avatarId:'demo' }; await idbPut('contacts', demo); return demo.id; }

/* AI reply: if group, rotate through members; replyCount = per-group-member? We'll interpret replyCount as total replies (not repeats). */ async function aiAutoReply(conversationId, userText){ // determine if conversation is a group const group = await idbGet('groups', conversationId); if(group){ // group chat const settings = await idbGet('settings','currentAI') || { actionDesc:true }; // global replyCount setting applies, but for group we will distribute among members in round-robin const global = settings.replyCount || 3; // ensure no duplicate exact replies: we will craft each reply uniquely const members = group.members || []; if(members.length===0) return; // choose starting index randomly to vary who replies first let start = Math.floor(Math.random()members.length); const replies = []; for(let i=0;i<global;i++){ const mem = members[(start + i) % members.length]; // compose reply using member.persona and style const persona = mem.persona || ''; const style = mem.style || ''; let text = ''; if(settings.actionDesc) text += ï¼ˆä»–è½»è½»ä¸€ç¬‘ï¼‰ ; if(persona) text += persona.split('\n')[0] + 'ï¼š'; // generate variation text += userText; if(style) text += 'ï¼ˆé£æ ¼ï¼š' + style + 'ï¼‰'; if(i>0) text += ' ' + 'å—¯'.repeat((i%3)+1); replies.push({ memberId: mem.id, text }); } // persist replies with small delays, using member avatars for(let i=0;i<replies.length;i++){ await new Promise(r=>setTimeout(r, 300 + i200)); const r = replies[i]; const avat = await idbGet('avatars', r.memberId); const message = { id:'ai_'+Date.now()+'_'+i, from:'ai', text: r.text, avatarData: avat?avat.data:null, ts: new Date().toISOString() }; const conv = (await idbGet('conversations', conversationId)) || { id:conversationId, messages:[] }; conv.messages.push(message); await idbPut('conversations', conv); appendMessageToDom(message); } return; }

// otherwise normal 1-on-1 AI reply using currentAI settings const s = await idbGet('settings','currentAI') || { persona:'', style:'å‹å¥½', replyCount:3, actionDesc:true, name:'å°NIE' }; const replies = []; const max = Math.min(Math.max(1, s.replyCount || 1), 20); for(let i=0;i<max;i++){ let t = ''; if(s.actionDesc) t = ï¼ˆä»–å¾®ç¬‘ï¼‰ ; if(s.persona) t += (s.persona.split('\n')[0] || '') + 'ï¼š'; t += userText; if(i>0) t += ' ' + 'å—¯'.repeat((i%3)+1); replies.push(t); } for(let i=0;i<replies.length;i++){ await new Promise(r=>setTimeout(r, 300 + i*200)); const avatarObj = await idbGet('avatars','currentAI'); const message = { id:'ai_'+Date.now() + '_' + i, from:'ai', text: replies[i], avatarData: avatarObj ? avatarObj.data : null, ts:new Date().toISOString() }; const conv = (await idbGet('conversations', conversationId)) || { id:conversationId, messages:[] }; conv.messages.push(message); await idbPut('conversations', conv); appendMessageToDom(message); } }

/* moments logic (same as before) */ document.getElementById('postBtn').addEventListener('click', async ()=>{ const text = document.getElementById('momentsInput').value.trim(); if(!text) return alert('è¯·è¾“å…¥å†…å®¹'); const id = 'm_' + Date.now(); const item = { id, author:'ä½ ', avatarId:'me', text, ts: new Date().toISOString(), likes:[], comments:[] }; await idbPut('moments', item); document.getElementById('momentsInput').value=''; renderMoments(); }); document.getElementById('aiPostBtn').addEventListener('click', async ()=>{ const s = await idbGet('settings','currentAI'); const text = s && s.persona ? (s.persona.split('\n')[0] || 'ä»Šå¤©ä¹Ÿæƒ³å’Œä½ è¯´ç‚¹å¿ƒé‡Œè¯~') : 'ä»Šå¤©ä¹Ÿæƒ³å’Œä½ è¯´ç‚¹å¿ƒé‡Œè¯~'; const id = 'm_' + Date.now(); const item = { id, author: (s&&s.name)||'å°NIE', avatarId:'currentAI', text, ts: new Date().toISOString(), likes:[], comments:[] }; await idbPut('moments', item); renderMoments(); });

async function renderMoments(){ const list = await idbGetAll('moments'); const container = document.getElementById('momentsList'); container.innerHTML=''; list.sort((a,b)=> new Date(b.ts)-new Date(a.ts)); for(const it of list){ const card = document.createElement('div'); card.className='section'; card.style.marginBottom='8px'; const authorLine = document.createElement('div'); authorLine.innerHTML = <strong>${it.author}</strong> <span class="small" style="margin-left:8px">${new Date(it.ts).toLocaleString()}</span>; const text = document.createElement('div'); text.style.marginTop='8px'; text.textContent = it.text; const actions = document.createElement('div'); actions.style.marginTop='8px'; const likeBtn = document.createElement('button'); likeBtn.className='chip'; likeBtn.textContent = 'èµ (' + (it.likes?it.likes.length:0) + ')'; likeBtn.addEventListener('click', async ()=>{ it.likes = it.likes || []; if(it.likes.includes('ä½ ')) it.likes = it.likes.filter(x=>x!=='ä½ '); else it.likes.push('ä½ '); await idbPut('moments', it); renderMoments(); }); const cBtn = document.createElement('button'); cBtn.className='chip'; cBtn.textContent = 'è¯„è®º (' + (it.comments?it.comments.length:0) + ')'; cBtn.addEventListener('click', ()=>{ const comment = prompt('è¾“å…¥è¯„è®ºï¼š'); if(comment){ it.comments = it.comments || []; it.comments.push({ who:'ä½ ', text: comment, ts:new Date().toISOString() }); idbPut('moments', it).then(()=>renderMoments()); } }); actions.appendChild(likeBtn); actions.appendChild(cBtn); card.appendChild(authorLine); card.appendChild(text); card.appendChild(actions); if(it.comments && it.comments.length>0){ const cdiv = document.createElement('div'); cdiv.style.marginTop='8px'; it.comments.forEach(c=>{ const p = document.createElement('div'); p.className='small'; p.textContent = ${c.who}: ${c.text}; cdiv.appendChild(p); }); card.appendChild(cdiv); } container.appendChild(card); } }

/* apply settings to UI (avatars, background) */ async function applySettingsToUI(){ const s = await idbGet('settings','currentAI'); const av = await idbGet('avatars','currentAI'); const bg = await idbGet('backgrounds','chatBg'); if(av && av.data){ currentAvatarEl.innerHTML=''; const im=document.createElement('img'); im.src=av.data; im.style.width='100%'; im.style.height='100%'; im.style.borderRadius='12px'; currentAvatarEl.appendChild(im); } else currentAvatarEl.textContent='ğŸ™‚'; if(bg && bg.data){ msgsEl.style.backgroundImage = url(${bg.data}); msgsEl.style.backgroundRepeat='repeat'; msgsEl.style.backgroundSize='160px 160px'; } else msgsEl.style.backgroundImage=''; }

/* initialization */ async function init(){ await openDB(); // ensure placeholders const meAv = await idbGet('avatars','me'); if(!meAv){ const placeholder='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#f7d9f7"/></svg>'); await idbPut('avatars',{ id:'me', data:placeholder }); } const aiAv = await idbGet('avatars','currentAI'); if(!aiAv){ const placeholder='data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="#e8e0ff"/></svg>'); await idbPut('avatars',{ id:'currentAI', data:placeholder }); } const s = await idbGet('settings','currentAI'); if(!s) await idbPut('settings',{ key:'currentAI', name:'å°NIE', gender:'ä¸­æ€§', persona:'', style:'å‹å¥½', replyCount:4, actionDesc:true }); // ensure demo contact const contacts = await idbGetAll('contacts'); if(!contacts || contacts.length===0){ await idbPut('contacts',{ id:'contact_demo', name:'å°NIE', avatarId:'me' }); } await renderContacts(); await renderMoments(); await applySettingsToUI(); } init();

/* Expose helpers for debug */ window._nie = { openDB, idbGet, idbPut, idbGetAll }; </script>

</body>
</html>
