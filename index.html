<!doctype html>

<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NIEaiphone - restored</title>
<style>
:root{--bg:#f3eaf8;--card:#fff;--accent:#8a63d9;--muted:#6b6170}
*{box-sizing:border-box}
body{margin:0;font-family:Inter, system-ui, Arial; background:var(--bg);min-height:100vh}
.app{max-width:420px;margin:18px auto;padding:12px}
.card{background:var(--card);border-radius:22px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
.header{display:flex;align-items:center;gap:12px}
.avatar{width:64px;height:64px;border-radius:12px;overflow:hidden;flex:0 0 64px}
.avatar img{width:100%;height:100%;object-fit:cover}
.title{flex:1}
.title h1{margin:0;font-size:20px}
.title p{margin:2px 0 0;color:var(--muted);font-size:13px}
.grid{display:grid;grid-template-columns:repeat(3,1fr);gap:18px;margin-top:18px}
.tile{background:#fff;border-radius:16px;padding:12px;text-align:center;box-shadow:0 6px 18px rgba(0,0,0,.04)}
.tile img{width:48px;height:48px}
.bottom-actions{display:flex;gap:18px;justify-content:center;margin-top:18px}
.btn{background:#fff;padding:10px 18px;border-radius:28px;box-shadow:0 8px 18px rgba(0,0,0,.04);border:none}
.btn.accent{background:linear-gradient(135deg,var(--accent),#a088ee);color:#fff}
/* chat page */
.page{display:none}
.page.active{display:block}
.chat-wrap{margin-top:12px}
.chat-card{background:rgba(255,255,255,0.9);border-radius:18px;padding:12px;min-height:360px;position:relative}
.msg{display:flex;gap:12px;align-items:flex-start;margin-bottom:12px}
.msg .ava{width:36px;height:36px;border-radius:10px;background:#fff}
.msg .bubble{max-width:75%;padding:12px;border-radius:14px;background:linear-gradient(180deg,#e8dfff,#d9caf9);box-shadow:0 12px 20px rgba(0,0,0,.06)}
.msg.user{flex-direction:row-reverse}
.msg.user .bubble{background:linear-gradient(180deg,#ffdfea,#ffd8e8)}
.fixed-input{position:sticky;bottom:0;background:transparent;margin-top:8px;display:flex;gap:8px;align-items:center}
.input{flex:1;padding:12px;border-radius:12px;background:#fff;border:1px solid #eee}
.send{padding:10px 14px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#a088ee);color:#fff;border:none}
/* modal */
.modal{position:fixed;inset:0;display:none;align-items:flex-end;justify-content:center}
.modal.open{display:flex}
.modal .sheet{width:100%;max-width:540px;background:#fff;border-radius:18px;padding:18px;margin:12px}
.row{display:flex;gap:12px;align-items:center;margin-bottom:8px}
.small{font-size:13px;color:var(--muted)}
.kv{display:flex;gap:8px;align-items:center}
.avatar-picker{display:flex;gap:8px;align-items:center}
.member-block{background:#faf7ff;padding:10px;border-radius:12px;margin-bottom:8px}
</style>
</head>
<body>
<div class="app">
  <!-- index/launch page -->
  <div id="launchPage" class="card">
    <div style="height:100px;display:flex;align-items:center;justify-content:center">
      <h2 style="margin:0;color:var(--accent)">NIEaiphone</h2>
    </div>
    <div style="height:240px;display:flex;align-items:center;justify-content:center">
      <button id="goHome" class="btn accent">回到你的小家</button>
    </div>
  </div>  <!-- home page -->  <div id="homePage" class="page active">
    <div class="card">
      <div class="header">
        <div class="avatar" id="homeAvatar"><img src="data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'><rect fill='%23f3eaf8' width='100%'/></svg>"></div>
        <div class="title">
          <h1 id="homeName">NIEnieee.</h1>
          <p id="homeSub">今天心情超级好~</p>
        </div>
        <div>
          <button id="customBtn" class="btn">自定义</button>
        </div>
      </div><div class="grid">
    <div class="tile" data-navigate="chat"> <img src="https://cdn.jsdelivr.net/gh/heeyeonseo14-gif/asset/icons/chat.png" alt="chat"><div>聊天</div></div>
    <div class="tile"> <img src="https://cdn.jsdelivr.net/gh/heeyeonseo14-gif/asset/icons/journal.png"><div>日记</div></div>
    <div class="tile"> <img src="https://cdn.jsdelivr.net/gh/heeyeonseo14-gif/asset/icons/forum.png"><div>论坛</div></div>
    <div class="tile"> <img src="https://cdn.jsdelivr.net/gh/heeyeonseo14-gif/asset/icons/milk.png"><div>API 设置</div></div>
    <div class="tile"> <img src="https://cdn.jsdelivr.net/gh/heeyeonseo14-gif/asset/icons/beauty.png"><div>美化</div></div>
    <div class="tile"> <img src="https://cdn.jsdelivr.net/gh/heeyeonseo14-gif/asset/icons/more.png"><div>更多</div></div>
  </div>

  <div class="bottom-actions">
    <button id="mySettings" class="btn">我的设置</button>
    <button id="changeBg" class="btn">更换背景</button>
  </div>

</div>

  </div>  <!-- chat page -->  <div id="chatPage" class="page">
    <div class="card chat-wrap">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px">
        <div class="avatar" id="chatHead"><img src=""/></div>
        <div style="flex:1"><strong id="chatName">小NIE</strong></div>
        <div><button id="hisSettings" class="btn">他的设置</button></div>
      </div><div class="chat-card" id="chatCard">
    <div id="messages"></div>
  </div>

  <div class="fixed-input">
    <textarea id="msgInput" class="input" placeholder="输入消息, Enter 发送 (Shift+Enter 换行)" rows="1"></textarea>
    <button id="sendBtn" class="send">发送</button>
  </div>

</div>

  </div></div><!-- modal for settings --><div id="modal" class="modal">
  <div class="sheet">
    <h3>他的设置 / 群聊成员设置</h3>
    <div id="membersContainer"></div>
    <div style="display:flex;gap:8px;margin-top:12px">
      <button id="addMember" class="btn">添加成员</button>
      <button id="saveSettings" class="btn accent">保存</button>
      <button id="closeModal" class="btn">关闭</button>
    </div>
  </div>
</div><script>
// Simple IndexedDB helper (promised)
function openDB(name='nie-db', version=1){
  return new Promise((res,rej)=>{
    const req=indexedDB.open(name,version)
    req.onupgradeneeded=e=>{
      const db=e.target.result; if(!db.objectStoreNames.contains('settings')) db.createObjectStore('settings')
    }
    req.onsuccess=e=>res(e.target.result)
    req.onerror=e=>rej(e.target.error)
  })
}
async function idbGet(key){const db=await openDB();return new Promise(res=>{const tx=db.transaction('settings','readonly');const s=tx.objectStore('settings');const rq=s.get(key);rq.onsuccess=()=>res(rq.result);rq.onerror=()=>res(null)})}
async function idbPut(key,val){const db=await openDB();return new Promise(res=>{const tx=db.transaction('settings','readwrite');const s=tx.objectStore('settings');const rq=s.put(val,key);rq.onsuccess=()=>res(true);rq.onerror=()=>res(false)})}

// UI refs
const launchPage=document.getElementById('launchPage');
const goHome=document.getElementById('goHome');
const homePage=document.getElementById('homePage');
const chatPage=document.getElementById('chatPage');
const homeAvatar=document.getElementById('homeAvatar');
const homeName=document.getElementById('homeName');
const homeSub=document.getElementById('homeSub');
const customBtn=document.getElementById('customBtn');
const changeBg=document.getElementById('changeBg');
const mySettings=document.getElementById('mySettings');
const chatHead=document.getElementById('chatHead').querySelector('img');
const chatName=document.getElementById('chatName');
const hisSettings=document.getElementById('hisSettings');
const messages=document.getElementById('messages');
const msgInput=document.getElementById('msgInput');
const sendBtn=document.getElementById('sendBtn');
const modal=document.getElementById('modal');
const membersContainer=document.getElementById('membersContainer');
const addMember=document.getElementById('addMember');
const saveSettings=document.getElementById('saveSettings');
const closeModal=document.getElementById('closeModal');

let settings={members: [{name:'小NIE', avatar:null, persona:'友好', replyCount:5, actions:true}], chatBgCard:null}

async function loadSettings(){
  const s = await idbGet('app-settings');
  if(s) settings=Object.assign(settings,s);
  renderHome(); applyChatHead(); applyChatBg();
}
function renderHome(){homeName.textContent = settings.members[0]?.name || 'NIE'; homeSub.textContent = settings.subtitle || '今天心情超级好~'; if(settings.members[0]?.avatar){homeAvatar.querySelector('img').src=settings.members[0].avatar; chatHead.src=settings.members[0].avatar}}
function applyChatHead(){ const a=settings.members[0]?.avatar; chatHead.src = a||'' }
function applyChatBg(){ const el=document.getElementById('chatCard'); if(settings.chatBgCard){ el.style.backgroundImage=`url('${settings.chatBgCard}')`; el.style.backgroundSize='cover'; el.style.backgroundRepeat='no-repeat'; el.style.backgroundPosition='center' } else { el.style.backgroundImage=''; el.style.backgroundColor='rgba(255,255,255,0.95)'} }

async function showPage(name){ document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); if(name==='home') homePage.classList.add('active'); if(name==='chat') chatPage.classList.add('active'); }

// startup logic
goHome.addEventListener('click',async()=>{ await idbPut('launchSeen',true); launchPage.style.display='none'; showPage('home'); })

// navigation from tiles
document.querySelectorAll('.tile[data-navigate]').forEach(t=>t.addEventListener('click',()=>{ const nav=t.dataset.navigate; if(nav==='chat'){ showPage('chat'); } }))

// custom button -> quick prompts
customBtn.addEventListener('click',async()=>{
  const newName = prompt('设置主页名称', settings.members[0]?.name || ''); if(newName!=null){ settings.members[0].name=newName; await idbPut('app-settings',settings); renderHome(); }
})

changeBg.addEventListener('click',async()=>{
  // allow local upload via file input
  const fileInput = document.createElement('input'); fileInput.type='file'; fileInput.accept='image/*';
  fileInput.onchange = async e=>{
    const f=e.target.files[0]; if(!f) return; const reader=new FileReader(); reader.onload=async ()=>{ settings.chatBgCard = reader.result; await idbPut('app-settings',settings); applyChatBg(); alert('已更换聊天卡片背景（本地保存）'); }
    reader.readAsDataURL(f);
  }
  fileInput.click();
})

mySettings.addEventListener('click',()=>{ const n=prompt('主页标题', settings.members[0]?.name || ''); if(n!=null){ settings.members[0].name=n; idbPut('app-settings',settings).then(()=>renderHome()); } })

// his/her settings modal (group support)
hisSettings.addEventListener('click',openModal);
function openModal(){ membersContainer.innerHTML=''; settings.members.forEach((m,idx)=>{ const div=document.createElement('div'); div.className='member-block'; div.innerHTML = `
  <div style="display:flex;gap:8px;align-items:center">
    <div style="width:56px;height:56px;border-radius:10px;overflow:hidden;background:#fff"><img src="${m.avatar||''}" style="width:100%;height:100%;object-fit:cover"></div>
    <div style="flex:1">
      <input data-idx="${idx}" class="mname" placeholder="名称" value="${m.name||''}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee;margin-bottom:6px">
      <input data-idx="${idx}" class="mpersona" placeholder="人设（仅提示用）" value="${m.persona||''}" style="width:100%;padding:8px;border-radius:8px;border:1px solid #eee">
    </div>
  </div>
  <div style="margin-top:8px;display:flex;gap:8px;align-items:center">
    <label class="small">回复条数</label>
    <input data-idx="${idx}" class="mcount" type="number" min="1" max="20" value="${m.replyCount||5}" style="width:64px;padding:6px;border-radius:8px;border:1px solid #eee">
    <label style="margin-left:12px"><input data-idx="${idx}" type="checkbox" class="mactions" ${m.actions? 'checked':''}> 动作/心理</label>
    <button data-idx="${idx}" class="btn" style="margin-left:auto">选择头像</button>
    <button data-idx="${idx}" class="btn" data-remove="true">移除</button>
  </div>
 `; membersContainer.appendChild(div);
})
 modal.classList.add('open');
}

addMember.addEventListener('click',()=>{ settings.members.push({name:'新成员', avatar:null, persona:'友好', replyCount:3, actions:false}); openModal(); })

closeModal.addEventListener('click',()=>{ modal.classList.remove('open'); })

saveSettings.addEventListener('click',async()=>{
  // read inputs
  const names = membersContainer.querySelectorAll('.mname'); names.forEach(inp=>{ const idx=+inp.dataset.idx; settings.members[idx].name = inp.value });
  const personas = membersContainer.querySelectorAll('.mpersona'); personas.forEach(inp=>{ const idx=+inp.dataset.idx; settings.members[idx].persona = inp.value });
  const counts = membersContainer.querySelectorAll('.mcount'); counts.forEach(inp=>{ const idx=+inp.dataset.idx; settings.members[idx].replyCount = Math.min(20, Math.max(1, +inp.value || 1)) });
  const actions = membersContainer.querySelectorAll('.mactions'); actions.forEach(chk=>{ const idx=+chk.dataset.idx; settings.members[idx].actions = chk.checked });
  // handle avatar selects & remove
  const removeBtns = membersContainer.querySelectorAll('[data-remove]'); removeBtns.forEach(btn=>{ btn.addEventListener('click',()=>{ const par=btn.closest('.member-block'); const idx = Array.from(membersContainer.children).indexOf(par); settings.members.splice(idx,1); openModal(); }) })
  // attach choose avatar handlers
  const chooseBtns = membersContainer.querySelectorAll('.btn'); chooseBtns.forEach(b=>{
    if(b.textContent.trim()==='选择头像'){
      b.onclick = ()=>{
        const idx = +b.dataset.idx; const fi=document.createElement('input'); fi.type='file'; fi.accept='image/*'; fi.onchange = e=>{ const f=e.target.files[0]; const r=new FileReader(); r.onload = async ()=>{ settings.members[idx].avatar = r.result; idbPut('app-settings',settings).then(()=>{ openModal(); renderHome(); applyChatHead(); }) }; r.readAsDataURL(f) }; fi.click();
      }
    }
  })
  // save
  await idbPut('app-settings',settings);
  modal.classList.remove('open'); alert('保存成功'); renderHome(); applyChatHead(); applyChatBg();
})

// messaging logic (demo-only, no backend). Note: will not echo persona text. Reply behavior simulates rule-based responses.
sendBtn.addEventListener('click',onSend);
msgInput.addEventListener('keydown',e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); onSend(); } })
function appendMessage(text, who='ai'){ const div=document.createElement('div'); div.className='msg '+(who==='user'?'user':''); div.innerHTML = ` <div class="ava"></div><div class="bubble">${text}</div>`; messages.appendChild(div); messages.scrollTop = messages.scrollHeight; }

function onSend(){ const t=msgInput.value.trim(); if(!t) return; appendMessage(t,'user'); msgInput.value=''; // simulate AI replies based on settings.members[0]
 const ai = settings.members[0]; if(!ai) return; const max = ai.replyCount || 1; // generate up to max replies (distinct)
 const replies = generateReplies(t, ai, max);
 replies.forEach((r, i)=> setTimeout(()=> appendMessage(r,'ai'), 600 + i*400)); }

function generateReplies(userText, ai, max){ // simple variation generator - does NOT repeat exactly
 const base = `${ai.persona? '':' '}`; const variants = [];
 // generate some short variations
 const v1 = `${userText}`;
 const v2 = ai.actions ? `（他微笑）${userText}` : userText;
 const v3 = ai.actions ? `（他轻轻一笑）${userText}` : userText;
 if(v1 && variants.length<max && !variants.includes(v1)) variants.push(v1);
 if(v2 && variants.length<max && !variants.includes(v2)) variants.push(v2);
 if(v3 && variants.length<max && !variants.includes(v3)) variants.push(v3);
 // if still short, add friendly filler
 while(variants.length<max){ variants.push(`${userText}`+' 我明白了~'); }
 // ensure uniqueness
 return Array.from(new Set(variants)).slice(0,max);
}

// load saved settings at start
loadSettings();

// expose for debugging
window.__nie = { idbGet, idbPut, settings }
</script></body>
</html>
