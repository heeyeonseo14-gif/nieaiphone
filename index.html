<!doctype html>

<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>NIEaiphone â€” index</title>
  <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg1:#f7eef9;--bg2:#f1e6f6;--card:#fff;--muted:#7b6c88;--text:#2f2436;--accent:#8b65d6}
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:"Quicksand",system-ui,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,var(--bg1),var(--bg2));-webkit-font-smoothing:antialiased}
    .app{max-width:480px;margin:12px auto;padding:14px;border-radius:20px;background:transparent;min-height:88vh}
    .header{display:flex;align-items:center;gap:12px}
    .title{font-weight:700;font-size:20px}
    .top-actions{margin-left:auto;display:flex;gap:8px}
    .btn{padding:8px 12px;border-radius:12px;background:#fff;border:1px solid rgba(0,0,0,0.04);cursor:pointer}
    .main{margin-top:12px}
    .pane{background:rgba(255,255,255,0.98);border-radius:14px;padding:12px;min-height:360px}
    .contactsGrid{display:flex;gap:12px;flex-wrap:wrap}
    .contact{width:88px;text-align:center;padding:10px;border-radius:12px;background:linear-gradient(180deg,#fff,#faf8ff);cursor:pointer}
    .contact img{width:56px;height:56px;border-radius:10px;object-fit:cover}
    .chatHeader{display:flex;align-items:center;gap:12px;margin-bottom:8px}
    .chatAvatar{width:52px;height:52px;border-radius:12px;overflow:hidden}
    .chatAvatar img{width:100%;height:100%;object-fit:cover}
    .messages{max-height:44vh;overflow:auto;padding:8px;display:flex;flex-direction:column;gap:10px}
    .row{display:flex;gap:10px;align-items:flex-end}
    .row.mine{justify-content:flex-end}
    .bubble{max-width:78%;padding:10px 14px;border-radius:16px}
    .bubble.user{background:linear-gradient(180deg,#fff0f5,#ffd6e6)}
    .bubble.ai{background:linear-gradient(180deg,#f3eeff,#d7c8ff)}
    .composer{position:sticky;bottom:10px;padding-top:10px;display:flex;gap:8px;align-items:end}
    textarea{flex:1;min-height:48px;padding:10px;border-radius:12px;border:1px solid rgba(0,0,0,0.06);resize:none}
    .send{padding:10px 14px;border-radius:12px;background:linear-gradient(135deg,var(--accent),#a57de6);color:#fff;border:none;cursor:pointer}
    .modalBg{position:fixed;inset:0;background:rgba(0,0,0,0.36);display:none;align-items:center;justify-content:center}
    .modal{background:#fff;padding:14px;border-radius:14px;width:92%;max-width:720px;max-height:86vh;overflow:auto}
    .formRow{display:flex;gap:8px;align-items:center;margin-bottom:10px}
    .formRow label{width:110px;color:var(--muted)}
    input[type=text],input[type=file],textarea,select{flex:1;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.06)}
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:22px;background:linear-gradient(135deg,var(--accent),#7a64d0);color:#fff;padding:10px 16px;border-radius:18px;display:none}
  </style>
</head>
<body>
  <div class="app" id="app">
    <div class="header">
      <div class="title">NIEaiphone</div>
      <div class="top-actions">
        <button class="btn" id="openFeed">æœ‹å‹åœˆ</button>
        <button class="btn" id="addContact">æ·»åŠ è”ç³»äºº</button>
        <button class="btn" id="createGroup">åˆ›å»ºç¾¤èŠ</button>
      </div>
    </div><div class="main">
  <div class="pane" id="contactsPane">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px">
      <div style="font-weight:700">è”ç³»äºº</div>
      <div class="muted">é€‰æ‹©è”ç³»äººå¼€å§‹èŠå¤©</div>
    </div>
    <div id="contactsGrid" class="contactsGrid"></div>
    <div id="emptyHint" style="margin-top:12px;color:var(--muted)">æš‚æ— è”ç³»äººï¼Œç‚¹å‡»â€œæ·»åŠ è”ç³»äººâ€ã€‚</div>
  </div>

  <div class="pane" id="chatPane" style="display:none;margin-top:12px">
    <div class="chatHeader">
      <div class="chatAvatar" id="chatAvatar"><img src="" alt=""></div>
      <div style="flex:1">
        <div id="chatTitle" style="font-weight:700">å¯¹è¯</div>
        <div id="chatSub" style="color:var(--muted)"></div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn" id="openAi">ä»–çš„è®¾å®š</button>
        <button class="btn" id="backToList">è¿”å›</button>
      </div>
    </div>
    <div id="messages" class="messages"></div>
    <div class="composer">
      <textarea id="txtInput" placeholder="è¾“å…¥æ¶ˆæ¯ï¼ŒEnter å‘é€ï¼ˆShift+Enter æ¢è¡Œï¼‰"></textarea>
      <button class="send" id="sendBtn">å‘é€</button>
    </div>
  </div>

  <div class="pane" id="feedPane" style="display:none;margin-top:12px">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div style="font-weight:700">æœ‹å‹åœˆ</div>
      <div style="color:var(--muted)">AI å¯å‘åŠ¨æ€ Â· æ”¯æŒç‚¹èµ/è¯„è®º</div>
    </div>
    <div style="margin-top:10px">
      <textarea id="postText" style="width:100%;height:64px;border-radius:8px;padding:8px" placeholder="åœ¨æœ‹å‹åœˆè¯´ç‚¹ä»€ä¹ˆ..."></textarea>
      <div style="display:flex;gap:8px;margin-top:8px">
        <button class="btn" id="publishBtn">å‘å¸ƒ</button>
        <button class="btn" id="aiPostBtn">AI å‘ä¸€æ¡</button>
        <label style="display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border-radius:10px;background:#fff;border:1px solid rgba(0,0,0,0.04)"><input type="checkbox" id="autoPostSwitch"> AI è‡ªåŠ¨å‘</label>
        <button class="btn" id="closeFeedBtn">å…³é—­</button>
      </div>
    </div>
    <div id="feedList" style="margin-top:12px"></div>
  </div>
</div>

<div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
  <button class="btn" id="openProfileBtn">æˆ‘çš„è®¾ç½®</button>
  <button class="btn" id="changeBgBtn">æ›´æ¢èƒŒæ™¯</button>
</div>

<div class="toast" id="toast"></div>

  </div>  <!-- Modals -->  <div class="modalBg" id="modalBg"><div class="modal" id="modal"> </div></div><script>
// ---------- IndexedDB layer ----------
const DB = 'nieaiphone_db_v1';
let db;
function openIndexedDB(){
  return new Promise((res,rej)=>{
    const r = indexedDB.open(DB,1);
    r.onupgradeneeded = e => {
      const d = e.target.result;
      if(!d.objectStoreNames.contains('settings')) d.createObjectStore('settings',{keyPath:'id'});
      if(!d.objectStoreNames.contains('contacts')) d.createObjectStore('contacts',{keyPath:'id'});
      if(!d.objectStoreNames.contains('conversations')) d.createObjectStore('conversations',{keyPath:'id'});
      if(!d.objectStoreNames.contains('images')) d.createObjectStore('images',{keyPath:'name'});
      if(!d.objectStoreNames.contains('posts')) d.createObjectStore('posts',{keyPath:'id'});
      if(!d.objectStoreNames.contains('groups')) d.createObjectStore('groups',{keyPath:'id'});
    };
    r.onsuccess = e=>{ db = e.target.result; res(db); };
    r.onerror = e=> rej(e);
  });
}
function idbGet(store,key){ return new Promise(res=>{ const tx=db.transaction(store); const req=tx.objectStore(store).get(key); req.onsuccess=e=>res(e.target.result); req.onerror=()=>res(null); }); }
function idbPut(store, val){ return new Promise((res)=>{ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).put(val); tx.oncomplete=()=>res(true); }); }
function idbGetAll(store){ return new Promise(res=>{ const tx=db.transaction(store); const req=tx.objectStore(store).getAll(); req.onsuccess=e=>res(e.target.result); req.onerror=()=>res([]); }); }
function idbDelete(store,key){ const tx=db.transaction(store,'readwrite'); tx.objectStore(store).delete(key); return new Promise(res=>{tx.oncomplete=()=>res(true)}); }

// images: store blob
async function saveImage(name, file){
  const ab = await file.arrayBuffer();
  const blob = new Blob([ab],{type:file.type});
  await idbPut('images',{name, blob});
}
async function getImageURL(name){ const rec = await idbGet('images',name); if(!rec) return null; return URL.createObjectURL(rec.blob); }

// ---------- state & defaults ----------
let state = {me:{id:'me',name:'ä½ ',avatar:null,role:''}, ai:{name:'å°NIE',avatar:null,role:'',replyCount:1,actionsEnabled:false}, contacts:[], conversations:{}, feed:[] };

async function init(){
  await openIndexedDB();
  const s = await idbGet('settings','me'); if(s) state.me = s; else await idbPut('settings',state.me);
  const contacts = await idbGetAll('contacts'); if(contacts.length===0){ const aiId='ai_'+Date.now(); const aiContact={id:aiId,name:state.ai.name,avatar:null,role:state.ai.role,replyCount:state.ai.replyCount,actionsEnabled:state.ai.actionsEnabled}; await idbPut('contacts',aiContact); state.contacts=[aiContact]; } else state.contacts = contacts;
  const feed = await idbGetAll('posts'); state.feed = feed;
  renderContacts(); renderFeed(); applyBackground();
}

// ---------- UI helpers ----------
function qs(id){return document.getElementById(id)}
function showToast(msg,ms=1300){ const t=qs('toast'); t.textContent=msg; t.style.display='block'; setTimeout(()=>t.style.display='none',ms); }
function showModal(html){ qs('modal').innerHTML=html; qs('modalBg').style.display='flex'; }
function closeModal(){ qs('modal').innerHTML=''; qs('modalBg').style.display='none'; }

// ---------- Contacts ----------
async function renderContacts(){
  const grid = qs('contactsGrid'); grid.innerHTML='';
  state.contacts = await idbGetAll('contacts');
  state.contacts.forEach(async c=>{
    const el = document.createElement('div'); el.className='contact'; el.dataset.id=c.id; el.onclick=()=>openConversation(c.id);
    const img = document.createElement('img'); img.alt='avatar'; img.src=''; const url = await getImageURL('avatar_'+c.id); img.src = url || defaultAvatar();
    el.appendChild(img);
    const name = document.createElement('div'); name.textContent=c.name; name.style.marginTop='6px'; el.appendChild(name);
    grid.appendChild(el);
  });
  qs('emptyHint').style.display = (state.contacts.length===0)?'block':'none';
}
function defaultAvatar(){ return 'data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120'><rect width='100%' height='100%' fill='%23fff' rx='20'/><text x='50%' y='54%' font-size='40' text-anchor='middle' dominant-baseline='central'>ğŸ™‚</text></svg>`); }

// ---------- Conversation UI ----------
async function openConversation(id){
  const contact = await idbGet('contacts',id);
  if(!contact) return showToast('è”ç³»äººä¸å­˜åœ¨');
  state.active = id;
  qs('contactsPane').style.display='none'; qs('feedPane').style.display='none'; qs('chatPane').style.display='block';
  qs('chatTitle').textContent = contact.name;
  qs('chatSub').textContent = '';
  const url = await getImageURL('avatar_'+contact.id); if(url) qs('chatAvatar').querySelector('img').src = url; else qs('chatAvatar').querySelector('img').src = defaultAvatar();
  renderMessagesFor(id);
}
async function renderMessagesFor(id){ const conv = await idbGet('conversations',id) || {id,messages:[]}; const container=qs('messages'); container.innerHTML=''; conv.messages.forEach(m=>{ const r=document.createElement('div'); r.className='row'+(m.from==='me'?' mine':''); const bubble=document.createElement('div'); bubble.className='bubble '+(m.from==='me'?'user':'ai'); bubble.innerHTML = escapeHtml(m.text).replaceAll('\n','<br>'); if(m.from==='me'){ r.appendChild(bubble); } else { r.appendChild(bubble); } container.appendChild(r); }); container.scrollTop = container.scrollHeight; }

async function appendMessage(convId, msg){ const conv = await idbGet('conversations', convId) || {id:convId,messages:[]}; conv.messages.push(msg); await idbPut('conversations',conv); renderMessagesFor(convId); }

// ---------- Send & AI ----------
qs('txtInput').addEventListener('keydown', async (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); await handleSend(); } });
qs('sendBtn').addEventListener('click', handleSend);
async function handleSend(){ const txt = qs('txtInput').value.trim(); if(!txt) return; const cid = state.active; if(!cid) return showToast('è¯·é€‰æ‹©è”ç³»äºº'); const msg={id:'m_'+Date.now(),from:'me',text:txt,ts:Date.now()}; await appendMessage(cid,msg); qs('txtInput').value=''; // simulate AI reply
  simulateAIReply(cid,txt);
}

async function simulateAIReply(contactId, userText){
  const contact = await idbGet('contacts', contactId);
  const replyCount = Math.max(1, Math.min(20, contact.replyCount || 1));
  const actionsEnabled = !!contact.actionsEnabled;
  const replies = generateUniqueReplies(contact, userText, replyCount, actionsEnabled);
  for(const t of replies){ await appendMessage(contactId, {id:'m_'+Date.now(),from:'ai',text:t,ts:Date.now()}); await new Promise(r=>setTimeout(r,120)); }
}
function generateUniqueReplies(contact, userText, count, actionsEnabled){
  const seeds = [];
  if(/^(ä½ å¥½|hi|å—¨|hello)/i.test(userText)) seeds.push('ä½ å¥½ï½å¾ˆé«˜å…´å’Œä½ è¯´è¯');
  if(userText.length<10) seeds.push(`ä½ è¯´çš„ã€Œ${userText}ã€æˆ‘å¬åˆ°äº†`);
  if(userText.length>=10) seeds.push(`æˆ‘æ³¨æ„åˆ°ä½ æåˆ°ã€Œ${userText.slice(0,40)}ã€`);
  if(seeds.length===0) seeds.push('å—¯ï¼Œæˆ‘çŸ¥é“äº†');
  const styleTokens = (contact.role||'').split(/[ï¼›;ï¼Œ,]/).map(s=>s.trim()).filter(Boolean);
  const parts=[]; const seen=new Set(); let i=0; while(parts.length<count && i<200){ let base=seeds[i%seeds.length]; const style=styleTokens[i%styleTokens.length]||''; let candidate = style? (base) : base; // DO NOT append style text visibly
    if(actionsEnabled) candidate = `ï¼ˆä»–è½»è½»ä¸€ç¬‘ï¼‰${candidate}`;
    if(!seen.has(candidate)){ seen.add(candidate); parts.push(candidate); }
    i++; }
  return parts.slice(0,count);
}

// ---------- AI settings modal ----------
qs('openAi').addEventListener('click', async ()=>{
  if(!state.active) return showToast('è¯·é€‰æ‹©èŠå¤©å¯¹è±¡');
  const contact = await idbGet('contacts', state.active);
  const html = `
    <h3>ä»–çš„è®¾å®š</h3>
    <div class="formRow"><label>åç§°</label><input type="text" id="m_name" value="${escapeHtml(contact.name)}"></div>
    <div class="formRow"><label>äººè®¾ï¼ˆä»…æç¤ºï¼‰</label><textarea id="m_role">${escapeHtml(contact.role||'')}</textarea></div><div class="formRow"><label>é£æ ¼/ä¹ æƒ¯ï¼ˆä»…æç¤ºï¼‰</label><textarea id="m_style">${escapeHtml(contact.style||'')}</textarea></div>
<div class="formRow"><label>å¤´åƒæ–‡ä»¶</label><input type="file" id="m_avatar"></div>
<div class="formRow"><label>å›å¤æ¡æ•°</label><input type="number" id="m_count" min="1" max="20" value="${contact.replyCount||1}"></div>
<div class="formRow"><label>åŠ¨ä½œ/å¿ƒç†</label><input type="checkbox" id="m_action" ${contact.actionsEnabled? 'checked':''}></div>
<div style="text-align:right;margin-top:8px"><button class="btn" onclick="closeModal()">å–æ¶ˆ</button><button class="btn" id="saveHis">ä¿å­˜</button></div>

`; showModal(html); qs('saveHis').onclick = async ()=>{ contact.name = qs('m_name').value || contact.name; contact.role = qs('m_role').value || contact.role; contact.style = qs('m_style').value || contact.style; contact.replyCount = Math.max(1, Math.min(20, parseInt(qs('m_count').value||1))); contact.actionsEnabled = !!qs('m_action').checked; const f = qs('m_avatar').files && qs('m_avatar').files[0]; if(f) await saveImage('avatar_'+contact.id, f); await idbPut('contacts', contact); await renderContacts(); closeModal(); showToast('å·²ä¿å­˜ä»–çš„è®¾å®š'); }; });

// ---------- profile modal ---------- qs('openProfileBtn').addEventListener('click', ()=>{ const html = <h3>æˆ‘çš„è®¾ç½®</h3> <div class="formRow"><label>åå­—</label><input type="text" id="me_name" value="${escapeHtml(state.me.name)}"></div> <div class="formRow"><label>å¤´åƒ</label><input type="file" id="me_avatar"></div> <div class="formRow"><label>æˆ‘çš„äººè®¾ï¼ˆä»…æç¤ºï¼‰</label><textarea id="me_role">${escapeHtml(state.me.role)}</textarea></div> <div style="text-align:right;margin-top:8px"><button class="btn" onclick="closeModal()">å–æ¶ˆ</button><button class="btn" id="saveMe">ä¿å­˜</button></div>; showModal(html); qs('saveMe').onclick = async ()=>{ state.me.name = qs('me_name').value || state.me.name; state.me.role = qs('me_role').value || state.me.role; const f = qs('me_avatar').files && qs('me_avatar').files[0]; if(f) await saveImage('avatar_me', f); await idbPut('settings', state.me); await renderContacts(); closeModal(); showToast('å·²ä¿å­˜ä¸ªäººè®¾ç½®'); }; });

// ---------- add contact & group ---------- qs('addContact').addEventListener('click', ()=>{ const html = <h3>æ·»åŠ è”ç³»äºº</h3> <div class="formRow"><label>åå­—</label><input type="text" id="new_name"></div> <div class="formRow"><label>å¤´åƒ</label><input type="file" id="new_avatar"></div> <div style="text-align:right;margin-top:8px"><button class="btn" onclick="closeModal()">å–æ¶ˆ</button><button class="btn" id="createContactBtn">åˆ›å»º</button></div>; showModal(html); qs('createContactBtn').onclick = createContact; }); async function createContact(){ const name = qs('new_name').value.trim()||('è”ç³»äºº'+Date.now()); const id='c_'+Date.now(); const c={id,name,role:'',style:'',replyCount:1,actionsEnabled:false}; await idbPut('contacts',c); const f=qs('new_avatar').files && qs('new_avatar').files[0]; if(f) await saveImage('avatar_'+id,f); await renderContacts(); closeModal(); showToast('å·²åˆ›å»ºè”ç³»äºº'); }

qs('createGroup').addEventListener('click', ()=>{ const html = <h3>åˆ›å»ºç¾¤èŠï¼ˆæœ€å¤š8äººï¼‰</h3> <div class="formRow"><label>ç¾¤å</label><input type="text" id="g_name"></div> <div class="formRow"><label>è¯·é€‰æ‹©æˆå‘˜ï¼ˆä»å·²æœ‰è”ç³»äººï¼‰</label><div id="g_select" style="display:flex;gap:8px;flex-wrap:wrap;margin-top:8px"></div></div> <div style="text-align:right;margin-top:8px"><button class="btn" onclick="closeModal()">å–æ¶ˆ</button><button class="btn" id="createGroupBtn">åˆ›å»º</button></div>; showModal(html); // render existing contacts as checkboxes (async ()=>{ const cs = await idbGetAll('contacts'); const wrap = qs('g_select'); wrap.innerHTML=''; cs.forEach(c=>{ const cb = document.createElement('label'); cb.style.display='flex'; cb.style.flexDirection='column'; cb.style.alignItems='center'; cb.style.width='90px'; cb.innerHTML = <input type="checkbox" value="${c.id}"><div style="margin-top:6px">${escapeHtml(c.name)}</div>; wrap.appendChild(cb); }); })(); qs('createGroupBtn').onclick = async ()=>{ const name = qs('g_name').value.trim()||('ç¾¤èŠ'+Date.now()); const checks = Array.from(qs('g_select').querySelectorAll('input[type=checkbox]:checked')).map(i=>i.value); if(checks.length<1) return showToast('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªæˆå‘˜'); if(checks.length+1>8) return showToast('æœ€å¤š8äºº'); const gid='g_'+Date.now(); const g={id:gid,name,members:checks}; await idbPut('groups',g); await idbPut('contacts',{id:gid,name,group:true}); await renderContacts(); closeModal(); showToast('ç¾¤èŠå·²åˆ›å»º'); }; });

// ---------- feed (æœ‹å‹åœˆ) ---------- qs('openFeed').addEventListener('click', ()=>{ qs('contactsPane').style.display='none'; qs('chatPane').style.display='none'; qs('feedPane').style.display='block'; renderFeed(); }); qs('closeFeedBtn').addEventListener('click', ()=>{ qs('feedPane').style.display='none'; qs('contactsPane').style.display='block'; }); qs('publishBtn').addEventListener('click', async ()=>{ const t=qs('postText').value.trim(); if(!t) return showToast('è¯·è¾“å…¥å†…å®¹'); const p={id:'post_'+Date.now(),owner:'me',name:state.me.name,avatar: await getImageURL('avatar_me'),text:t,likes:[],comments:[],ts:Date.now()}; await idbPut('posts',p); qs('postText').value=''; renderFeed(); showToast('å·²å‘å¸ƒ'); }); qs('aiPostBtn').addEventListener('click', async ()=>{ const ai = (await idbGetAll('contacts')).find(c=>c.id.startsWith('ai_')) || (await idbGetAll('contacts'))[0]; const p={id:'post_'+Date.now(),owner:ai.id,name:ai.name,avatar: await getImageURL('avatar_'+ai.id),text:state.ai.role || 'ä»Šå¤©ä¹Ÿæƒ³å’Œä½ è¯´ç‚¹å¿ƒé‡Œè¯ï½',likes:[],comments:[],ts:Date.now()}; await idbPut('posts',p); renderFeed(); showToast('AI å·²å‘ä¸€æ¡'); }); function renderFeed(){ (async ()=>{ const list = await idbGetAll('posts'); const wrap = qs('feedList'); wrap.innerHTML=''; list.sort((a,b)=>b.ts-a.ts).forEach(p=>{ const el=document.createElement('div'); el.style.background='#fff'; el.style.padding='10px'; el.style.borderRadius='10px'; el.style.marginTop='10px'; el.innerHTML = <div style="display:flex;gap:8px;align-items:center"><img src="${p.avatar||defaultAvatar()}" style="width:40px;height:40px;border-radius:8px;object-fit:cover"/><div><strong>${escapeHtml(p.name)}</strong><div style="font-size:12px;color:var(--muted)">${new Date(p.ts).toLocaleString()}</div></div></div><div style="margin-top:8px">${escapeHtml(p.text)}</div><div style="margin-top:8px;display:flex;gap:8px"><button class='btn' onclick='toggleLike("${p.id}")'>èµ (${p.likes?.length||0})</button><button class='btn' onclick='openComment("${p.id}")'>è¯„è®º (${p.comments?.length||0})</button></div>; wrap.appendChild(el); }); })(); } async function toggleLike(id){ const p = await idbGet('posts',id); if(!p) return; p.likes = p.likes||[]; const me=state.me.name; const idx = p.likes.indexOf(me); if(idx>=0) p.likes.splice(idx,1); else p.likes.push(me); await idbPut('posts',p); renderFeed(); } function openComment(id){ showModal(<h3>å†™è¯„è®º</h3><textarea id='cmt'></textarea><div style='text-align:right;margin-top:8px'><button class='btn' onclick='closeModal()'>å–æ¶ˆ</button><button class='btn' onclick="submitComment('${id}')">ç¡®å®š</button></div>); } async function submitComment(id){ const txt=qs('cmt').value.trim(); if(!txt) return showToast('è¯·è¾“å…¥è¯„è®º'); const p=await idbGet('posts',id); p.comments=p.comments||[]; p.comments.push({name:state.me.name,text:txt,ts:Date.now()}); await idbPut('posts',p); closeModal(); renderFeed(); showToast('å·²è¯„è®º'); }

// ---------- background & apply ---------- qs('changeBgBtn').addEventListener('click', ()=>{ showModal(<h3>æ›´æ¢èŠå¤©èƒŒæ™¯ï¼ˆä»…æ›¿æ¢ç™½å¡ï¼‰</h3><div class='formRow'><label>é€‰æ‹©å›¾ç‰‡</label><input type='file' id='bgFile' accept='image/*'></div><div style='text-align:right;margin-top:8px'><button class='btn' onclick='closeModal()'>å–æ¶ˆ</button><button class='btn' id='setBg'>è®¾ç½®</button></div>); qs('setBg').onclick = async ()=>{ const f = qs('bgFile').files && qs('bgFile').files[0]; if(!f) return showToast('è¯·é€‰æ‹©å›¾ç‰‡'); await saveImage('background', f); await idbPut('settings', state.me); applyBackground(); closeModal(); showToast('å·²è®¾ç½®èƒŒæ™¯'); }; }); async function applyBackground(){ const url = await getImageURL('background'); const panes = document.querySelectorAll('.pane'); panes.forEach(p=>{ if(url){ p.style.backgroundImage = url('${url}'); p.style.backgroundSize='cover'; p.style.backgroundPosition='center'; p.style.backgroundColor='rgba(255,255,255,0.6)'; } else { p.style.backgroundImage=''; p.style.backgroundColor='rgba(255,255,255,0.98)'; } }); }

// ---------- utils ---------- function escapeHtml(s){ if(!s) return ''; return (s+'').replaceAll('&','&').replaceAll('<','<').replaceAll('>','>'); }

// expose debug window._NIE = { state, idbGet, idbPut, idbGetAll };

// init init(); </script>

</body>
</html>
